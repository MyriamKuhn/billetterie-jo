import{j as e,r as u}from"./react-C0aVURRx.js";import{b as R,a as B,A as D,P as S,S as F,O as L}from"./index-DrEuU79R.js";import{E as $}from"./ErrorDisplay-CPpgxCLY.js";import{u as j}from"./i18n-react-CLR_B6bE.js";import{x as I,Q as T,t as g,az as P,B as y,C as w,aA as A,q as h,u as M,N as O,I as C,p as Y,r as W,a3 as H,_ as N}from"./mui-DvHa722-.js";import{ac as _,ad as E,ae as V}from"./vendor-BkFWaOq0.js";import{a as b}from"./axios-xsH4HHeE.js";import{u as q}from"./useCustomSnackbar-BM_DdCE4.js";import{d as G}from"./dayjs-DMyafwSS.js";import{F as Q}from"./FilterSelect-BZIZCyjw.js";import{S as U}from"./SortControl-CkPxS0rS.js";import"./zustand-DgaMZn_z.js";import"./i18n-Bhc83OLH.js";import"./emotion-BDhcDjNx.js";import"./helmet-OWuT_DBl.js";import"./cookie-consent-DmI9BIvn.js";function J({report:t}){const{t:s}=j("reports");return e.jsx(I,{sx:{p:2,display:"flex",flexDirection:"column",gap:1},children:e.jsxs(T,{children:[e.jsxs(g,{variant:"h6",children:["#",t.product_id," - ",t.product_name]}),e.jsx(g,{variant:"body2",color:"textSecondary",children:s("reports.sales_count",{count:t.sales_count})})]})})}function K(t,s,o="xlsx",p="Sheet1",i){let a;if(i){const c=Object.keys(i),l=c.map(n=>i[n]),r=t.map(n=>c.map(m=>n[m]));a=_.aoa_to_sheet([l,...r])}else a=_.json_to_sheet(t);if(o==="csv"){const c=_.sheet_to_csv(a);E.saveAs(new Blob([c],{type:"text/csv;charset=utf-8;"}),`${s}.csv`);return}const d=_.book_new();_.book_append_sheet(d,a,p);const x=V(d,{bookType:"xlsx",type:"array"});E.saveAs(new Blob([x],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),`${s}.xlsx`)}function X({filename:t="sales_report"}){const{t:s}=j("reports"),o=R(n=>n.authToken),p=B(n=>n.lang),{notify:i}=q(),[a,d]=u.useState(!1),x={product_id:s("export.product_id"),product_name:s("export.product_name"),sales_count:s("export.sales_count")},c=s("export.sheetname"),l={sort_by:"sales_count",sort_order:"desc",per_page:100,page:1},r=async n=>{d(!0);try{const m=await b.get(`${D}/api/tickets/admin/sales`,{params:l,headers:{Authorization:`Bearer ${o}`,"Accept-Language":p}});K(m.data.data,t,n,c,x),i(s("reports.success"),"success")}catch{i(s("errors.download"),"error")}finally{d(!1)}};return e.jsxs(I,{children:[e.jsxs(T,{children:[e.jsx(g,{variant:"h6",children:s("reports.download_title")}),e.jsx(g,{variant:"subtitle1",color:"text.secondary",children:s("reports.download_description")})]}),e.jsxs(P,{children:[e.jsx(y,{startIcon:a?e.jsx(w,{size:16}):e.jsx(A,{}),variant:"outlined",onClick:()=>r("csv"),size:"small",disabled:a,children:"CSV"}),e.jsx(y,{startIcon:a?e.jsx(w,{size:16}):e.jsx(A,{}),variant:"outlined",onClick:()=>r("xlsx"),size:"small",disabled:a,children:"Excel"})]})]})}function Z({reports:t}){const{t:s}=j("reports");return t.length===0?e.jsx(g,{variant:"h4",sx:{textAlign:"center"},children:s("errors.no_reports")}):e.jsxs(h,{sx:{display:"flex",gap:4,justifyContent:{xs:"center",md:"flex-start"},flexWrap:{xs:"wrap",md:"nowrap"},flexDirection:{xs:"row",md:"column"}},children:[e.jsx(X,{filename:s("export.filename",{today:G().format("YYYY-MM-DD")})}),t.map(o=>e.jsx(J,{report:o},o.product_id))]})}function ee(t,s,o){const[p,i]=u.useState([]),[a,d]=u.useState(0),[x,c]=u.useState(!1),[l,r]=u.useState(null),[n,m]=u.useState(null);return u.useEffect(()=>{c(!0),r(null),m(null);const z={per_page:Math.max(1,t.per_page),page:t.page,sort_by:t.sort_by,sort_order:t.sort_order};b.get(`${D}/api/tickets/admin/sales`,{params:z,headers:{Authorization:`Bearer ${s}`,"Accept-Language":o}}).then(f=>{i(f.data.data),d(f.data.meta.total)}).catch(f=>{var k;if(b.isAxiosError(f)){const v=(k=f.response)==null?void 0:k.status;if(v===422){m(f.response.data.errors);return}if(v===404){i([]),d(0);return}}r(f.code)}).finally(()=>c(!1))},[t,o]),{reports:p,total:a,loading:x,error:l,validationErrors:n}}function te({filters:t,onChange:s}){const{t:o}=j("reports"),p=M(),[i,a]=u.useState(!1),d=[{value:"sales_count",label:o("filters.sales_count")}],x=e.jsxs(h,{sx:{width:260,py:2,px:1},children:[e.jsx(g,{variant:"h6",gutterBottom:!0,children:o("filters.title")}),e.jsxs(O,{spacing:2,sx:{mx:1},children:[e.jsx(U,{fields:d,sortBy:t.sort_by,order:t.sort_order,onSortChange:(c,l)=>s({sort_by:c,sort_order:l,page:1}),label:o("filters.sort_by")}),e.jsx(Q,{label:o("filters.per_page"),value:String(t.per_page),options:["5","10","25","50","100"],onChange:c=>{const l=parseInt(c,10);s({per_page:l,page:1})}}),e.jsx(y,{variant:"outlined",fullWidth:!0,onClick:()=>s({sort_by:"sales_count",sort_order:"desc",per_page:5,page:1}),children:o("filters.reset")})]})]});return e.jsxs(e.Fragment,{children:[e.jsx(h,{component:"aside",sx:{display:{xs:"none",md:"block"},position:"sticky",top:p.mixins.toolbar.minHeight,bgcolor:"background.paper",border:`1px solid ${p.palette.divider}`,borderRadius:1,width:260},children:x}),e.jsxs(h,{sx:{display:{xs:"block",md:"none"},mb:2},children:[e.jsx(C,{onClick:()=>a(!0),"aria-label":o("filters.title"),children:e.jsx(Y,{})}),e.jsx(W,{open:i,onClose:()=>a(!1),keepMounted:!0,children:e.jsxs(h,{sx:{position:"relative"},children:[e.jsx(C,{onClick:()=>a(!1),size:"small",sx:{position:"absolute",top:8,right:8},"aria-label":o("filters.close"),children:e.jsx(H,{})}),x]})})]})]})}function _e(){const{t}=j("reports"),s=R(r=>r.authToken),o=B(r=>r.lang),[p,i]=u.useState({sort_by:"sales_count",sort_order:"desc",per_page:10,page:1}),{reports:a,total:d,loading:x,error:c,validationErrors:l}=ee(p,s,o);return u.useEffect(()=>{if(l){const r={};l.sort_by&&(r.sort_by="sales_count"),l.sort_order&&(r.sort_order="desc"),l.per_page&&(r.per_page=5),l.page&&(r.page=1),i(n=>({...n,...r}))}},[l]),c?e.jsx(S,{children:e.jsx($,{title:t("errors.title"),message:t("errors.message"),showRetry:!0,retryButtonText:t("errors.retry"),onRetry:()=>i(r=>({...r})),showHome:!0,homeButtonText:t("errors.go_home")})}):e.jsxs(e.Fragment,{children:[e.jsx(F,{title:t("seo.title"),description:t("seo.description")}),e.jsxs(S,{disableCard:!0,children:[e.jsx(g,{variant:"h4",sx:{px:2},children:t("reports.title")}),e.jsxs(h,{sx:{display:"flex",flexDirection:{xs:"column",md:"row"},gap:2,p:2},children:[e.jsx(te,{filters:p,onChange:r=>i(n=>({...n,...r}))}),e.jsxs(h,{component:"main",flex:1,children:[x?e.jsx(h,{textAlign:"center",py:8,children:e.jsx(L,{})}):e.jsx(Z,{reports:a}),!x&&a.length>0&&e.jsx(h,{textAlign:"center",mt:4,children:e.jsx(N,{count:Math.ceil(d/p.per_page)||1,page:p.page,onChange:(r,n)=>i(m=>({...m,page:n}))})})]})]})]})]})}export{_e as default};
