import{r as n,j as e}from"./react-C0aVURRx.js";import{A as F,b as D,a as ue,O as le,P as se,S as fe}from"./index-CD9-jRb9.js";import{E as pe}from"./ErrorDisplay-CATvfXnP.js";import{a as B}from"./axios-xsH4HHeE.js";import{u as xe,q as j,t as m,N as me,aA as he,$ as ge,C as q,B as O,I as ae,p as je,r as _e,a3 as be,x as Q,Q as V,av as ye,O as we,aw as ve,U as ne,ao as oe,ax as ke,R as Te,V as Se,X as Ce,i as X,W as Ie,Y as Ae,_ as $e}from"./mui-BBaOU7V-.js";import{F as J}from"./FilterSelect-C7Jqrsxx.js";import{u as Le}from"./useUsers-b78VolcS.js";import{u as E}from"./i18n-react-CHYEX_9Z.js";import{ab as Ue}from"./vendor-1UMx7qFY.js";import{u as G}from"./useCustomSnackbar-Br_GLiSh.js";import{u as Ee}from"./useProductDetails-CqDuAC4C.js";import{e as Be,f as Oe}from"./billingService-0zwj3Do7.js";import{u as De}from"./useAdminDownloadInvoice-C7YJ7ckN.js";import{T as Pe}from"./TicketCardSkeleton-Bx4eLN1e.js";import{f as R,a as ze}from"./format-_gz818Hm.js";import{F as Y}from"./FilterField-Dqw7-p3q.js";import{F as Re}from"./FilterRadios-CuEQvt6P.js";import"./dayjs-DMyafwSS.js";import"./zustand-DgaMZn_z.js";import"./i18n-Bhc83OLH.js";import"./emotion-BKoPsIBf.js";import"./helmet-DqAb31yQ.js";import"./cookie-consent-DYVQHhqE.js";function Fe(r,s){const[o,t]=n.useState([]),[d,c]=n.useState(0),[k,u]=n.useState(!1),[_,f]=n.useState(null),[y,p]=n.useState(null);return n.useEffect(()=>{u(!0),f(null),p(null);const a={per_page:Math.max(1,r.per_page),page:r.page,...r.status&&{status:r.status},...r.user_id&&{user_id:r.user_id}};B.get(`${F}/api/tickets`,{params:a,headers:{Authorization:`Bearer ${s}`}}).then(l=>{t(l.data.data),c(l.data.meta.total)}).catch(l=>{var w;if(B.isAxiosError(l)){const h=(w=l.response)==null?void 0:w.status;if(h===422){p(l.response.data.errors);return}if(h===404){t([]),c(0);return}}f(l.code)}).finally(()=>u(!1))},[r]),{tickets:o,total:d,loading:k,error:_,validationErrors:y}}function We(){const r=D(s=>s.authToken);return async function(o,t){try{return await B.put(`${F}/api/tickets/admin/${o}/status`,t,{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}}),!0}catch{return!1}}}function Me({filters:r,onChange:s}){const{t:o}=E("orders"),t=xe(),[d,c]=n.useState(!1),k=D(i=>i.authToken),u=n.useMemo(()=>({firstname:"",lastname:"",email:"",perPage:1e9,page:1}),[r.per_page]),{users:_,loading:f}=Le(u,k,"user"),y=n.useMemo(()=>({label:o("filters.user_all"),id:void 0}),[o]),p=n.useMemo(()=>[y,..._.map(i=>({label:`${i.firstname} ${i.lastname} (${i.email})`,id:i.id}))],[_,y]),a={"":o("filters.status_all"),issued:o("filters.status_issued"),used:o("filters.status_used"),refunded:o("filters.status_refunded"),cancelled:o("filters.status_cancelled")},l=Object.values(a),w=Object.fromEntries(Object.entries(a).map(([i,b])=>[b,i])),h=a[r.status],L=n.useCallback((i,b,U)=>{s(U==="clear"?{user_id:void 0,page:1}:{user_id:b==null?void 0:b.id,page:1})},[s]),S=e.jsxs(j,{sx:{width:260,py:2,px:1},children:[e.jsx(m,{variant:"h6",gutterBottom:!0,children:o("filters.title")}),e.jsxs(me,{spacing:2,sx:{mx:1},children:[e.jsx(J,{label:o("filters.status_label"),value:h,options:l,onChange:i=>s({status:w[i],page:1})}),e.jsx(he,{clearText:o("filters.clear_user"),size:"small",options:p,loading:f,value:p.find(i=>i.id===r.user_id)??y,onChange:L,isOptionEqualToValue:(i,b)=>i.id===b.id,getOptionLabel:i=>i.label,filterOptions:(i,{inputValue:b})=>i.filter(U=>U.label.toLowerCase().includes(b.toLowerCase())),renderInput:i=>e.jsx(ge,{...i,label:o("filters.user"),InputProps:{...i.InputProps,endAdornment:e.jsxs(e.Fragment,{children:[f&&e.jsx(q,{size:16}),i.InputProps.endAdornment]})}})}),e.jsx(J,{label:o("filters.per_page"),value:String(r.per_page),options:["5","10","25","50","100"],onChange:i=>{const b=parseInt(i,10);s({per_page:b,page:1})}}),e.jsx(O,{variant:"outlined",fullWidth:!0,onClick:()=>s({status:"",user_id:void 0,per_page:5,page:1}),children:o("filters.reset")})]})]});return e.jsxs(e.Fragment,{children:[e.jsx(j,{component:"aside",sx:{display:{xs:"none",md:"block"},position:"sticky",top:t.mixins.toolbar.minHeight,bgcolor:"background.paper",border:`1px solid ${t.palette.divider}`,borderRadius:1,width:260},children:S}),e.jsxs(j,{sx:{display:{xs:"block",md:"none"},mb:2},children:[e.jsx(ae,{onClick:()=>c(!0),"aria-label":o("filters.title"),children:e.jsx(je,{})}),e.jsx(_e,{open:d,onClose:()=>c(!1),keepMounted:!0,children:e.jsxs(j,{sx:{position:"relative"},children:[e.jsx(ae,{onClick:()=>c(!1),size:"small",sx:{position:"absolute",top:8,right:8},"aria-label":o("filters.close"),children:e.jsx(be,{})}),S]})})]})]})}function Ne({onCreate:r}){const{t:s}=E("orders");return e.jsxs(Q,{sx:{p:2,minWidth:240,display:"flex",flexDirection:"column",justifyContent:"space-between"},children:[e.jsxs(V,{children:[e.jsx(m,{variant:"h6",gutterBottom:!0,children:s("tickets.create_new")}),e.jsx(m,{variant:"body2",color:"text.secondary",children:s("tickets.create_intro")})]}),e.jsx(j,{sx:{p:2,pt:0},children:e.jsx(O,{fullWidth:!0,variant:"contained",onClick:r,children:s("tickets.create_button")})})]})}function qe(){const r=D(k=>k.authToken),{t:s}=E("orders"),{notify:o}=G(),[t,d]=n.useState(!1);return{download:async k=>{var _,f;if(!r){o(s("errors.not_authenticated"),"warning");return}const u=k.replace(/^.*[\\/]/,"");if(!u){o(s("errors.download_failed"),"error");return}d(!0);try{const y=await Be(u,r),p=window.URL.createObjectURL(y),a=document.createElement("a");a.href=p,a.download=u,document.body.appendChild(a),a.click(),a.remove(),window.URL.revokeObjectURL(p),o(s("tickets.download_success"),"success")}catch(y){let p=s("errors.download_failed"),a="error";((_=y.response)==null?void 0:_.status)===404?(p=s("errors.not_found"),a="warning"):((f=y.response)==null?void 0:f.status)===401&&(p=s("errors.unauthorized"),a="warning"),o(p,a)}finally{d(!1)}},downloading:t}}function Qe(r){const s=D(_=>_.authToken),{notify:o}=G(),{t}=E("orders"),[d,c]=n.useState(null),[k,u]=n.useState(!1);return n.useEffect(()=>{let _=!1;if(d&&(URL.revokeObjectURL(d),c(null)),!r)return;if(!s){o(t("errors.not_authenticated"),"warning");return}const f=r.replace(/^.*[\\/]/,"");return(async()=>{var p,a;u(!0);try{const l=await Oe(f,s);if(_)return;const w=URL.createObjectURL(l);c(w)}catch(l){let w=t("errors.qr_fetch_failed");((p=l.response)==null?void 0:p.status)===404?w=t("errors.qr_not_found"):((a=l.response)==null?void 0:a.status)===401&&(w=t("errors.unauthorized")),o(w,"error")}finally{_||u(!1)}})(),()=>{_=!0}},[r,s]),{qrUrl:d,loading:k}}const ie=r=>{switch(r){case"paid":return"success";case"pending":return"info";case"refunded":return"warning";case"failed":return"error";default:return"default"}};function Ve({ticket:r,onSave:s,onRefresh:o}){var Z,ee,te,re;const{t}=E("orders"),d=ue($=>$.lang),{notify:c}=G(),{download:k,downloading:u}=qe(),{download:_,downloading:f}=De(),{ref:y,inView:p}=Ue({triggerOnce:!0,rootMargin:"200px"}),{qrUrl:a,loading:l}=Qe(p?r.qr_filename:null),w=((Z=r.product_snapshot)==null?void 0:Z.product_id)??0,{product:h,loading:L,error:S}=Ee(w,d);n.useEffect(()=>{!L&&S&&c(t("errors.product_fetch_failed"),"warning")},[L,S,c,t]);const i={issued:t("filters.status_issued"),used:t("filters.status_used"),refunded:t("filters.status_refunded"),cancelled:t("filters.status_cancelled")},[b,U]=n.useState(r.status),[P,C]=n.useState(i[r.status]??""),z=n.useMemo(()=>b!==r.status,[b,r.status]),W=Object.fromEntries(Object.entries(i).map(([$,ce])=>[ce,$])),[T,I]=n.useState(!1),A=async()=>{I(!0);try{if(await s(r.id,{status:b}))c(t("orders.save_success"),"success"),o();else throw new Error}catch{c(t("errors.save_error"),"error")}finally{I(!1)}},M=()=>{r.pdf_filename?k(r.pdf_filename).catch(()=>c(t("errors.download_error"),"error")):c(t("errors.no_pdf"),"warning")},N=()=>{const $=`invoice_${r.payment.uuid}.pdf`;_($).catch(()=>c(t("errors.invoice_download_error"),"error"))};if(L)return e.jsx(Pe,{});const g=r.product_snapshot,x=r.user,v=S||!h?t("orders.no_product"):`${g==null?void 0:g.product_name} (${r.token})`,H=(ee=h==null?void 0:h.product_details)!=null&&ee.date?R(h.product_details.date,d):"",K=((te=h==null?void 0:h.product_details)==null?void 0:te.time)??"",de=((re=h==null?void 0:h.product_details)==null?void 0:re.location)??t("orders.no_location");return e.jsxs(Q,{ref:y,sx:{display:"flex",flexDirection:{xs:"column",md:"row"},gap:2,p:2},children:[e.jsx(j,{sx:{minWidth:{md:200},textAlign:"center"},children:l?e.jsx(ye,{variant:"rectangular",width:200,height:200}):a?e.jsx(we,{component:"img",image:a,alt:t("orders.qr_alt"),sx:{width:200,height:200,objectFit:"contain"}}):e.jsx(j,{sx:{width:200,height:200,display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"background.default"},children:e.jsx(ve,{fontSize:"large",color:"disabled"})})}),e.jsxs(V,{sx:{flexGrow:1},children:[e.jsxs(j,{sx:{display:"flex",alignItems:"center",mb:1},children:[e.jsx(m,{variant:"h6",children:t("orders.ticket_id",{id:r.id})}),r.payment.status==="paid"&&(g==null?void 0:g.discounted_price)===0?e.jsx(ne,{label:t("orders.free_ticket"),color:ie(r.payment.status),size:"small",sx:{ml:1}}):e.jsx(ne,{label:t(`invoices.status.${r.payment.status}`),color:ie(r.payment.status),size:"small",sx:{ml:1}})]}),e.jsx(m,{variant:"subtitle1",gutterBottom:!0,children:v}),H&&e.jsxs(m,{variant:"body2",color:"text.secondary",children:[H,K&&` – ${K}`]}),e.jsx(m,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:de}),e.jsx(m,{variant:"body1",sx:{mt:1},children:t("orders.price_paid",{price:ze(g==null?void 0:g.discounted_price,d)})}),x&&e.jsx(m,{variant:"body1",children:t("orders.user_info",{id:x.id,name:`${x.firstname} ${x.lastname}`,email:x.email})}),e.jsxs(m,{variant:"caption",color:"text.secondary",sx:{mt:1},children:[t("orders.created_at",{date:R(r.created_at,d)}),r.used_at&&` – ${t("orders.used_at",{date:R(r.used_at,d)})}`,r.refunded_at&&` – ${t("orders.refunded_at",{date:R(r.refunded_at,d)})}`,r.cancelled_at&&` – ${t("orders.cancelled_at",{date:R(r.cancelled_at,d)})}`]}),e.jsxs(j,{sx:{mt:2,display:"flex",flexWrap:"wrap",gap:1,alignItems:"center"},children:[e.jsx(oe,{title:t("orders.download_pdf"),children:e.jsx("span",{children:e.jsx(O,{size:"small",variant:"outlined",startIcon:u?e.jsx(q,{size:16}):e.jsx(ke,{}),onClick:M,disabled:u,children:t("orders.download_ticket")})})}),e.jsx(oe,{title:(g==null?void 0:g.discounted_price)===0?t("orders.free_ticket"):t("orders.download_invoice_pdf"),children:e.jsx("span",{children:e.jsx(O,{size:"small",variant:"outlined",startIcon:f?e.jsx(q,{size:16}):e.jsx(Te,{}),onClick:N,disabled:f||(g==null?void 0:g.discounted_price)===0,children:(g==null?void 0:g.discounted_price)===0?t("orders.free_ticket"):t("orders.download_invoice")})})}),e.jsx(j,{sx:{ml:"auto"},children:e.jsx(J,{label:t("filters.status_label"),value:P,options:Object.values(i),onChange:$=>{C($),U(W[$])}})}),e.jsx(O,{variant:"contained",size:"small",onClick:A,disabled:T||!z,startIcon:T?e.jsx(q,{color:"inherit",size:16}):void 0,children:t(T?"orders.saving":"orders.save")})]})]})]})}function Ge({tickets:r,onSave:s,onRefresh:o,onCreate:t}){const{t:d}=E("orders");return r.length===0?e.jsx(m,{variant:"h4",sx:{textAlign:"center"},children:d("errors.not_found_tickets")}):e.jsxs(j,{sx:{display:"flex",gap:4,justifyContent:{xs:"center",md:"flex-start"},flexWrap:{xs:"wrap",md:"nowrap"},flexDirection:{xs:"row",md:"column"}},children:[e.jsx(Ne,{onCreate:t}),r.map(c=>e.jsx(Ve,{ticket:c,onSave:s,onRefresh:o},c.token))]})}function He(){const r=D(s=>s.authToken);return async function(s){try{return await B.post(`${F}/api/tickets`,s,{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}}),!0}catch{return!1}}}function Xe({open:r,onClose:s,onRefresh:o}){if(!r)return null;const{t}=E("orders"),d=D(x=>x.authToken),{notify:c}=G(),k=He(),[u,_]=n.useState(null),[f,y]=n.useState(null),[p,a]=n.useState(1),[l,w]=n.useState("fr"),[h,L]=n.useState(!1),[S,i]=n.useState(!1),[b,U]=n.useState(!1),[P,C]=n.useState(null),[z,W]=n.useState(null),[T,I]=n.useState(null),[A,M]=n.useState(null),N={Authorization:`Bearer ${d}`,"Accept-Language":l};n.useEffect(()=>{u!==null&&u>0?(C(null),i(!0),I(null),B.get(`${F}/api/users/${u}`,{headers:N}).then(x=>I(x.data.user)).catch(x=>{C(t("errors.user_not_found"))})):(I(null),C(null),i(!1))},[u]),n.useEffect(()=>{T!=null&&T.email&&B.get(`${F}/api/users?email=${encodeURIComponent(T.email)}`,{headers:N}).then(x=>{const v=x.data.data.users;Array.isArray(v)&&v.length>0?v[0].role!=="user"?(C(t("errors.only_users_allowed")),I(null)):C(null):(C(t("errors.user_not_found")),I(null))}).catch(x=>{C(t("errors.user_not_found")),I(null)}).finally(()=>i(!1))},[T]),n.useEffect(()=>{f!==null&&f>0?(W(null),U(!0),M(null),B.get(`${F}/api/products/${f}`,{headers:N}).then(x=>M(x.data.data)).catch(x=>{W(t("errors.product_not_found"))}).finally(()=>U(!1))):(M(null),W(null))},[f,l]);const g=async()=>{L(!0);const v=await k({user_id:u,product_id:f,quantity:p,locale:l});L(!1),v?(c(t("freeTicket.success"),"success"),o(),s()):c(t("errors.save_failed"),"error")};return e.jsxs(Se,{open:r,onClose:s,maxWidth:"sm",fullWidth:!0,children:[e.jsx(Ce,{children:t("freeTicket.title")}),e.jsx(X,{}),e.jsxs(Ie,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsx(Y,{type:"number",label:t("freeTicket.userId"),value:u!=null?String(u):"",onChange:x=>{const v=parseInt(x,10);_(Number.isNaN(v)?null:v)}}),e.jsx(Y,{type:"number",label:t("freeTicket.productId"),value:f!=null?String(f):"",onChange:x=>{const v=parseInt(x,10);y(Number.isNaN(v)?null:v)}}),e.jsx(Y,{type:"number",label:t("freeTicket.quantity"),value:String(p),onChange:x=>{const v=parseInt(x,10);a(Number.isNaN(v)?0:v)}}),e.jsx(Re,{legend:t("freeTicket.locale"),value:l,options:[{value:"fr",label:t("freeTicket.fr")},{value:"en",label:t("freeTicket.en")},{value:"de",label:t("freeTicket.de")}],onChange:w}),e.jsx(X,{}),e.jsx(m,{variant:"body1",children:t("freeTicket.previsualisation")}),e.jsxs(j,{sx:{display:"grid",gap:2,gridTemplateColumns:{xs:"1fr",md:"1fr 1fr"},pt:1},children:[(S||b)&&e.jsx(j,{sx:{gridColumn:"1 / -1",textAlign:"center"},children:e.jsx(le,{})}),P&&e.jsx(j,{sx:{gridColumn:"1 / -1"},color:"error.main",children:P}),z&&e.jsx(j,{sx:{gridColumn:"1 / -1"},color:"error.main",children:z}),!S&&!P&&T&&e.jsx(Q,{variant:"outlined",children:e.jsxs(V,{children:[e.jsx(m,{variant:"subtitle1",gutterBottom:!0,children:t("freeTicket.user")}),e.jsx(m,{sx:{wordBreak:"break-word",overflowWrap:"anywhere"},children:`${T.firstname} ${T.lastname}`}),e.jsx(m,{variant:"body2",color:"text.secondary",sx:{wordBreak:"break-word",overflowWrap:"anywhere"},children:T.email})]})}),!b&&!z&&A&&e.jsx(Q,{variant:"outlined",children:e.jsxs(V,{children:[e.jsx(m,{variant:"subtitle1",gutterBottom:!0,children:t("freeTicket.product")}),e.jsx(m,{variant:"body1",sx:{wordBreak:"break-word",overflowWrap:"anywhere",mb:1},children:A.name}),e.jsx(m,{variant:"body2",sx:{wordBreak:"break-word",overflowWrap:"anywhere"},children:t("freeTicket.productDetails")}),e.jsxs(m,{variant:"body2",color:"text.secondary",sx:{wordBreak:"break-word",overflowWrap:"anywhere"},children:[t("freeTicket.places",{count:A.product_details.places})," "]}),e.jsxs(m,{variant:"body2",color:"text.secondary",sx:{wordBreak:"break-word",overflowWrap:"anywhere"},children:[R(A.product_details.date,l)," - ",A.product_details.time]}),e.jsx(m,{variant:"body2",color:"text.secondary",sx:{wordBreak:"break-word",overflowWrap:"anywhere"},children:A.product_details.location})]})}),!S&&!b&&!P&&!z&&!T&&!A&&e.jsx(j,{sx:{gridColumn:"1 / -1"},children:e.jsx(m,{children:t("freeTicket.noDetails")})})]})]}),e.jsx(X,{}),e.jsxs(Ae,{children:[e.jsx(O,{onClick:s,children:t("freeTicket.cancel")}),e.jsx(O,{onClick:g,variant:"contained",disabled:h||!u||!f||p<=0||!l||u<=0||f<=0,startIcon:h?e.jsx(q,{color:"inherit",size:16}):void 0,children:t(h?"freeTicket.creation":"freeTicket.create")})]})]})}function _t(){const{t:r}=E("orders"),s=D(a=>a.authToken),o=We(),[t,d]=n.useState({status:"",user_id:void 0,per_page:5,page:1}),{tickets:c,total:k,loading:u,error:_,validationErrors:f}=Fe(t,s),[y,p]=n.useState(!1);return n.useEffect(()=>{if(f){const a={};f.user_id&&(a.user_id=void 0),d(l=>({...l,...a}))}},[f]),_?e.jsx(se,{children:e.jsx(pe,{title:r("errors.title"),message:r("errors.message"),showRetry:!0,retryButtonText:r("errors.retry"),onRetry:()=>d(a=>({...a})),showHome:!0,homeButtonText:r("errors.go_home")})}):e.jsxs(e.Fragment,{children:[e.jsx(fe,{title:r("seo.title"),description:r("seo.description")}),e.jsxs(se,{disableCard:!0,children:[e.jsx(m,{variant:"h4",sx:{px:2},children:r("orders.title")}),e.jsxs(j,{sx:{display:"flex",flexDirection:{xs:"column",md:"row"},gap:2,p:2},children:[e.jsx(Me,{filters:t,onChange:a=>d(l=>({...l,...a}))}),e.jsxs(j,{component:"main",flex:1,children:[u?e.jsx(j,{textAlign:"center",py:8,children:e.jsx(le,{})}):e.jsx(Ge,{tickets:c,onSave:async(a,l)=>await o(a,{status:l.status}),onRefresh:()=>d(a=>({...a})),onCreate:()=>p(!0)}),!u&&c.length>0&&e.jsx(j,{textAlign:"center",mt:4,children:e.jsx($e,{count:Math.ceil(k/t.per_page)||1,page:t.page,onChange:(a,l)=>d(w=>({...w,page:l}))})})]})]})]}),e.jsx(Xe,{open:y,onClose:()=>p(!1),onRefresh:()=>d(a=>({...a}))})]})}export{_t as default};
