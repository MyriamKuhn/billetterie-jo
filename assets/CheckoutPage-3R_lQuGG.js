import{r as a,j as r}from"./react-C0aVURRx.js";import{a5 as ee,a6 as re,O as te,a7 as se,a8 as ae,a9 as Q}from"./vendor-DWEXA6-K.js";import{g as k,A as O}from"./AlertMessage-Div13Ill.js";import{a as J,S as oe,P as ne,u as b,b as ie,O as ce}from"./index-C8vFMK_G.js";import{l as X,c as le,g as ue,a as H}from"./paymentService-CbqamQtX.js";import{a as R}from"./axios-Dq7h7Pqt.js";import{u as U}from"./i18n-react-InMECBPB.js";import{q as j,B as _,v as T,y as de,r as me}from"./mui-uHutCCHi.js";import"./dayjs-DMyafwSS.js";import"./zustand-DgaMZn_z.js";import"./i18n-Bhc83OLH.js";import"./emotion-BfGcg3ty.js";import"./helmet-BZ3LMwLd.js";import"./cookie-consent-DtjjNNxi.js";const pe=re("pk_test_51RMYGcPreyLhSIPrfNaAPo6bxnSIvMXPGqMosWfGo6WZyfPjmJSYEMTfYu22AjQHfyM1Se6XLgbsjnYFCmVeajeT00KCOOsNQb");function Ae(){const{t:m}=U("checkout"),p=J(u=>u.lang),[i,f]=a.useState(null),[S,E]=a.useState(null),t=`stripe-elements-${p}-${i?"ready":"no-secret"}`,n={locale:p,...i?{clientSecret:i}:{}};return r.jsxs(r.Fragment,{children:[r.jsx(oe,{title:m("seo.title"),description:m("seo.description")}),r.jsx(ne,{disableCard:!0,children:r.jsx(ee,{stripe:pe,options:n,children:r.jsx(fe,{setClientSecret:f,setPaymentUuid:E,clientSecret:i,paymentUuid:S})},t)})]})}function fe({setClientSecret:m,setPaymentUuid:p,clientSecret:i,paymentUuid:f}){const S=a.useRef(!1),E=2e3,{t}=U("checkout"),n=te(),u=se(),P=ae(),[V,C]=a.useState(!0),[W,h]=a.useState(null),[v,x]=a.useState(!1),[w,c]=a.useState(null),[Y,g]=a.useState(!1),[z,A]=a.useState(null),B=b(e=>e.clearCart),G=b(e=>e.lockCart),o=b(e=>e.unlockCart),d=b(e=>e.cartId),l=ie(e=>e.authToken),N=J(e=>e.lang),q=b(e=>e.loadCart);a.useEffect(()=>{l&&!d&&q().catch(e=>X())},[l,d,q]),a.useEffect(()=>{if(!l){h(t("errors.not_authenticated")),C(!1),n("/login?next=/checkout");return}if(!d){C(!0);return}S.current||(S.current=!0,(async()=>{C(!0),h(null);try{const{data:e}=await le(d,l,N);if(e!=null&&e.client_secret)p(e.uuid),m(e.client_secret);else throw new Error("Unexpected response from server")}catch(e){if(R.isAxiosError(e)&&e.response){const{data:y}=e.response;y.code?h(k(t,y.code)):h(k(t,"generic_error"))}else h(k(t,"network_error"))}finally{C(!1)}})())},[l,d,N,n,t,m,p]);const Z=a.useCallback(async e=>{var $,D,F;e.preventDefault(),c(null),G(),x(!0),A(null),g(!0);const y=P.getElement(Q);if(!y){c(t("errors.no_card_element")),x(!1),g(!1),o();return}try{const{error:I}=await u.confirmCardPayment(i,{payment_method:{card:y}});if(I){X("Stripe confirm error:",I),c(t("errors.card_error")),x(!1),g(!1),o();return}A(t("checkout.waiting_confirmation"));let M=null;for(;;){await new Promise(s=>setTimeout(s,E));try{const{status:s,data:K}=await ue(f,l);if(s!==200||!K)throw new Error(`Unexpected polling response: ${s}`);const L=K.status.toLowerCase();if(L==="succeeded"||L==="paid"){M="paid";break}if(["requires_payment_method","failed","canceled"].includes(L)){M="failed";break}}catch(s){if(H("Polling payment status error:",s),R.isAxiosError(s)&&(($=s.response)==null?void 0:$.status)===401){c(t("errors.not_authenticated")),o(),n("/login");return}R.isAxiosError(s)&&((F=(D=s.response)==null?void 0:D.data)!=null&&F.code)?c(k(t,s.response.data.code)):c(k(t,"network_error")),o();break}}if(M==="paid"){A(t("checkout.payment_success")),o();try{await B()}catch(s){H("clearCart error after payment:",s)}n("/confirmation",{state:{paymentUuid:f}});return}else{c(t("errors.payment_failed")),x(!1),g(!1),o();return}}catch{x(!1),g(!1),o()}},[u,P,i,f,B,n,t,l,G,o]);return a.useEffect(()=>()=>{o()},[o]),W?r.jsxs(j,{sx:{p:4},children:[r.jsx(O,{message:W,severity:"error"}),r.jsxs(j,{sx:{mt:2},children:[r.jsx(_,{variant:"contained",onClick:()=>window.location.reload(),children:t("checkout.retry")}),r.jsx(_,{sx:{ml:2},variant:"outlined",onClick:()=>n("/cart"),children:t("checkout.back_to_cart")})]})]}):!d||V||!u||!P?r.jsxs(j,{sx:{textAlign:"center",py:4},children:[r.jsx(ce,{}),r.jsx(T,{sx:{mt:2},children:t("checkout.initializing")})]}):r.jsxs(de,{component:"form",onSubmit:Z,sx:{maxWidth:500,mx:"auto",mt:4,p:2,border:"1px solid",borderColor:"divider",borderRadius:1},children:[r.jsx(T,{variant:"h5",gutterBottom:!0,children:t("checkout.title")}),w&&r.jsx(O,{message:w,severity:"error"}),Y&&z&&r.jsx(O,{message:z,severity:"info"}),r.jsx(T,{variant:"body2",sx:{mb:1},children:t("checkout.card_number_label")}),r.jsx(j,{sx:{mb:2,border:"1px solid",borderColor:w?"error.main":"divider",borderRadius:1,p:1,backgroundColor:"background.paper",transition:"border-color 0.2s"},children:r.jsx(Q,{options:{style:{base:{fontSize:"16px",color:"#424770","::placeholder":{color:"#aab7c4"}},invalid:{color:"#9e2146"}}}})}),r.jsxs(j,{sx:{textAlign:"right",mt:3},children:[r.jsx(_,{type:"submit",variant:"contained",disabled:!u||v||Y,startIcon:v?r.jsx(me,{color:"inherit",size:16}):void 0,children:t(v?"checkout.processing":"checkout.pay_button")}),r.jsx(_,{variant:"text",onClick:()=>{o(),n("/cart")},children:t("checkout.cancel_payment")})]})]})}export{Ae as default};
