import{r as o,j as e}from"./react-C0aVURRx.js";import{A as F,b as O,a as ue,O as le,P as se,S as fe}from"./index-CXZF4oSR.js";import{E as pe}from"./ErrorDisplay-CCUrHHSf.js";import{a as B}from"./axios-xsH4HHeE.js";import{u as xe,q as b,t as h,N as me,aA as he,$ as ge,C as q,B as D,I as ne,p as je,r as _e,a3 as we,x as V,Q as G,av as be,O as ye,aw as ve,U as ae,ao as oe,ax as ke,R as Te,V as Se,X as Ce,i as X,W as Ie,Y as Ae,_ as Le}from"./mui-pYozd6Ue.js";import{F as J}from"./FilterSelect-D6K1oIzj.js";import{u as Ue}from"./useUsers-BR_DvZtD.js";import{u as U}from"./i18n-react-CHYEX_9Z.js";import{ab as $e}from"./vendor-1UMx7qFY.js";import{u as Q}from"./useCustomSnackbar-H5kbubpM.js";import{u as Ee}from"./useProductDetails-DrOSyKg3.js";import{e as Oe,f as Be,h as De}from"./billingService-DzyWgT6A.js";import{T as Re}from"./TicketCardSkeleton-BuMNFK8t.js";import{f as P,a as ze}from"./format-_gz818Hm.js";import{F as Y}from"./FilterField-XQB9fMSP.js";import{F as Pe}from"./FilterRadios-Bmw7rTuU.js";import"./dayjs-DMyafwSS.js";import"./zustand-DgaMZn_z.js";import"./i18n-Bhc83OLH.js";import"./emotion-BKoPsIBf.js";import"./helmet-DqAb31yQ.js";import"./cookie-consent-DYVQHhqE.js";function Fe(r,s){const[n,t]=o.useState([]),[l,p]=o.useState(0),[j,f]=o.useState(!1),[g,c]=o.useState(null),[x,i]=o.useState(null);return o.useEffect(()=>{f(!0),c(null),i(null);const a={per_page:Math.max(1,r.per_page),page:r.page,...r.status&&{status:r.status},...r.user_id&&{user_id:r.user_id}};B.get(`${F}/api/tickets`,{params:a,headers:{Authorization:`Bearer ${s}`}}).then(u=>{t(u.data.data),p(u.data.meta.total)}).catch(u=>{var v;if(B.isAxiosError(u)){const _=(v=u.response)==null?void 0:v.status;if(_===422){i(u.response.data.errors);return}if(_===404){t([]),p(0);return}}c(u.code)}).finally(()=>f(!1))},[r]),{tickets:n,total:l,loading:j,error:g,validationErrors:x}}function We(){const r=O(s=>s.authToken);return async function(n,t){try{return await B.put(`${F}/api/tickets/admin/${n}/status`,t,{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}}),!0}catch{return!1}}}function Me({filters:r,onChange:s}){const{t:n}=U("orders"),t=xe(),[l,p]=o.useState(!1),j=O(d=>d.authToken),f=o.useMemo(()=>({firstname:"",lastname:"",email:"",perPage:1e9,page:1}),[r.per_page]),{users:g,loading:c}=Ue(f,j,"user"),x=o.useMemo(()=>({label:n("filters.user_all"),id:void 0}),[n]),i=o.useMemo(()=>[x,...g.map(d=>({label:`${d.firstname} ${d.lastname} (${d.email})`,id:d.id}))],[g,x]),a={"":n("filters.status_all"),issued:n("filters.status_issued"),used:n("filters.status_used"),refunded:n("filters.status_refunded"),cancelled:n("filters.status_cancelled")},u=Object.values(a),v=Object.fromEntries(Object.entries(a).map(([d,y])=>[y,d])),_=a[r.status],$=o.useCallback((d,y,E)=>{s(E==="clear"?{user_id:void 0,page:1}:{user_id:y==null?void 0:y.id,page:1})},[s]),S=e.jsxs(b,{sx:{width:260,py:2,px:1},children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:n("filters.title")}),e.jsxs(me,{spacing:2,sx:{mx:1},children:[e.jsx(J,{label:n("filters.status_label"),value:_,options:u,onChange:d=>s({status:v[d],page:1})}),e.jsx(he,{clearText:n("filters.clear_user"),size:"small",options:i,loading:c,value:i.find(d=>d.id===r.user_id)??x,onChange:$,isOptionEqualToValue:(d,y)=>d.id===y.id,getOptionLabel:d=>d.label,filterOptions:(d,{inputValue:y})=>d.filter(E=>E.label.toLowerCase().includes(y.toLowerCase())),renderInput:d=>e.jsx(ge,{...d,label:n("filters.user"),InputProps:{...d.InputProps,endAdornment:e.jsxs(e.Fragment,{children:[c&&e.jsx(q,{size:16}),d.InputProps.endAdornment]})}})}),e.jsx(J,{label:n("filters.per_page"),value:String(r.per_page),options:["5","10","25","50","100"],onChange:d=>{const y=parseInt(d,10);s({per_page:y,page:1})}}),e.jsx(D,{variant:"outlined",fullWidth:!0,onClick:()=>s({status:"",user_id:void 0,per_page:5,page:1}),children:n("filters.reset")})]})]});return e.jsxs(e.Fragment,{children:[e.jsx(b,{component:"aside",sx:{display:{xs:"none",md:"block"},position:"sticky",top:t.mixins.toolbar.minHeight,bgcolor:"background.paper",border:`1px solid ${t.palette.divider}`,borderRadius:1,width:260},children:S}),e.jsxs(b,{sx:{display:{xs:"block",md:"none"},mb:2},children:[e.jsx(ne,{onClick:()=>p(!0),"aria-label":n("filters.title"),children:e.jsx(je,{})}),e.jsx(_e,{open:l,onClose:()=>p(!1),keepMounted:!0,children:e.jsxs(b,{sx:{position:"relative"},children:[e.jsx(ne,{onClick:()=>p(!1),size:"small",sx:{position:"absolute",top:8,right:8},"aria-label":n("filters.close"),children:e.jsx(we,{})}),S]})})]})]})}function Ne({onCreate:r}){const{t:s}=U("orders");return e.jsxs(V,{sx:{p:2,minWidth:240,display:"flex",flexDirection:"column",justifyContent:"space-between"},children:[e.jsxs(G,{children:[e.jsx(h,{variant:"h6",gutterBottom:!0,children:s("tickets.create_new")}),e.jsx(h,{variant:"body2",color:"text.secondary",children:s("tickets.create_intro")})]}),e.jsx(b,{sx:{p:2,pt:0},children:e.jsx(D,{fullWidth:!0,variant:"contained",onClick:r,children:s("tickets.create_button")})})]})}function qe(){const r=O(j=>j.authToken),{t:s}=U("orders"),{notify:n}=Q(),[t,l]=o.useState(!1);return{download:async j=>{var g,c;if(!r){n(s("errors.not_authenticated"),"warning");return}const f=j.replace(/^.*[\\/]/,"");if(!f){n(s("errors.download_failed"),"error");return}l(!0);try{const x=await Oe(f,r),i=window.URL.createObjectURL(x),a=document.createElement("a");a.href=i,a.download=f,document.body.appendChild(a),a.click(),a.remove(),window.URL.revokeObjectURL(i),n(s("tickets.download_success"),"success")}catch(x){let i=s("errors.download_failed"),a="error";((g=x.response)==null?void 0:g.status)===404?(i=s("errors.not_found"),a="warning"):((c=x.response)==null?void 0:c.status)===401&&(i=s("errors.unauthorized"),a="warning"),n(i,a)}finally{l(!1)}},downloading:t}}function Qe(){const r=O(j=>j.authToken),{t:s}=U("orders"),{notify:n}=Q(),[t,l]=o.useState(!1);return{download:async j=>{var f,g;if(!r){n(s("errors.not_authenticated"),"warning");return}l(!0);try{const c=await Be(j,r),x=window.URL.createObjectURL(c),i=document.createElement("a");i.href=x,i.download=j,document.body.appendChild(i),i.click(),i.remove(),window.URL.revokeObjectURL(x),n(s("tickets.download_success"),"success")}catch(c){let x=s("errors.download_failed"),i="error";((f=c.response)==null?void 0:f.status)===404?(x=s("errors.not_found"),i="warning"):((g=c.response)==null?void 0:g.status)===401&&(x=s("errors.unauthorized"),i="warning"),n(x,i)}finally{l(!1)}},downloading:t}}function Ve(r){const s=O(g=>g.authToken),{notify:n}=Q(),{t}=U("orders"),[l,p]=o.useState(null),[j,f]=o.useState(!1);return o.useEffect(()=>{let g=!1;if(l&&(URL.revokeObjectURL(l),p(null)),!r)return;if(!s){n(t("errors.not_authenticated"),"warning");return}const c=r.replace(/^.*[\\/]/,"");return(async()=>{var i,a;f(!0);try{const u=await De(c,s);if(g)return;const v=URL.createObjectURL(u);p(v)}catch(u){let v=t("errors.qr_fetch_failed");((i=u.response)==null?void 0:i.status)===404?v=t("errors.qr_not_found"):((a=u.response)==null?void 0:a.status)===401&&(v=t("errors.unauthorized")),n(v,"error")}finally{g||f(!1)}})(),()=>{g=!0}},[r,s]),{qrUrl:l,loading:j}}const ie=r=>{switch(r){case"paid":return"success";case"pending":return"info";case"refunded":return"warning";case"failed":return"error";default:return"default"}};function Ge({ticket:r,onSave:s,onRefresh:n}){var Z,ee,te,re;const{t}=U("orders"),l=ue(L=>L.lang),{notify:p}=Q(),{download:j,downloading:f}=qe(),{download:g,downloading:c}=Qe(),{ref:x,inView:i}=$e({triggerOnce:!0,rootMargin:"200px"}),{qrUrl:a,loading:u}=Ve(i?r.qr_filename:null),v=((Z=r.product_snapshot)==null?void 0:Z.product_id)??0,{product:_,loading:$,error:S}=Ee(v,l);o.useEffect(()=>{!$&&S&&p(t("errors.product_fetch_failed"),"warning")},[$,S,p,t]);const d={issued:t("filters.status_issued"),used:t("filters.status_used"),refunded:t("filters.status_refunded"),cancelled:t("filters.status_cancelled")},[y,E]=o.useState(r.status),[R,C]=o.useState(d[r.status]??""),z=o.useMemo(()=>y!==r.status,[y,r.status]),W=Object.fromEntries(Object.entries(d).map(([L,ce])=>[ce,L])),[T,I]=o.useState(!1),A=async()=>{I(!0);try{if(await s(r.id,{status:y}))p(t("orders.save_success"),"success"),n();else throw new Error}catch{p(t("errors.save_error"),"error")}finally{I(!1)}},M=()=>{r.pdf_filename?j(r.pdf_filename).catch(()=>p(t("errors.download_error"),"error")):p(t("errors.no_pdf"),"warning")},N=()=>{const L=`invoice_${r.payment.uuid}.pdf`;g(L).catch(()=>p(t("errors.invoice_download_error"),"error"))};if($)return e.jsx(Re,{});const w=r.product_snapshot,m=r.user,k=S||!_?t("orders.no_product"):`${w==null?void 0:w.product_name} (${r.token})`,H=(ee=_==null?void 0:_.product_details)!=null&&ee.date?P(_.product_details.date,l):"",K=((te=_==null?void 0:_.product_details)==null?void 0:te.time)??"",de=((re=_==null?void 0:_.product_details)==null?void 0:re.location)??t("orders.no_location");return e.jsxs(V,{ref:x,sx:{display:"flex",flexDirection:{xs:"column",md:"row"},gap:2,p:2},children:[e.jsx(b,{sx:{minWidth:{md:200},textAlign:"center"},children:u?e.jsx(be,{variant:"rectangular",width:200,height:200}):a?e.jsx(ye,{component:"img",image:a,alt:t("orders.qr_alt"),sx:{width:200,height:200,objectFit:"contain"}}):e.jsx(b,{sx:{width:200,height:200,display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"background.default"},children:e.jsx(ve,{fontSize:"large",color:"disabled"})})}),e.jsxs(G,{sx:{flexGrow:1},children:[e.jsxs(b,{sx:{display:"flex",alignItems:"center",mb:1},children:[e.jsx(h,{variant:"h6",children:t("orders.ticket_id",{id:r.id})}),r.payment.status==="paid"&&(w==null?void 0:w.discounted_price)===0?e.jsx(ae,{label:t("orders.free_ticket"),color:ie(r.payment.status),size:"small",sx:{ml:1}}):e.jsx(ae,{label:t(`invoices.status.${r.payment.status}`),color:ie(r.payment.status),size:"small",sx:{ml:1}})]}),e.jsx(h,{variant:"subtitle1",gutterBottom:!0,children:k}),H&&e.jsxs(h,{variant:"body2",color:"text.secondary",children:[H,K&&` â€“ ${K}`]}),e.jsx(h,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:de}),e.jsx(h,{variant:"body1",sx:{mt:1},children:t("orders.price_paid",{price:ze(w==null?void 0:w.discounted_price,l)})}),m&&e.jsx(h,{variant:"body1",children:t("orders.user_info",{id:m.id,name:`${m.firstname} ${m.lastname}`,email:m.email})}),e.jsxs(h,{variant:"caption",color:"text.secondary",sx:{mt:1},children:[t("orders.created_at",{date:P(r.created_at,l)}),r.used_at&&` â€“ ${t("orders.used_at",{date:P(r.used_at,l)})}`,r.refunded_at&&` â€“ ${t("orders.refunded_at",{date:P(r.refunded_at,l)})}`,r.cancelled_at&&` â€“ ${t("orders.cancelled_at",{date:P(r.cancelled_at,l)})}`]}),e.jsxs(b,{sx:{mt:2,display:"flex",flexWrap:"wrap",gap:1,alignItems:"center"},children:[e.jsx(oe,{title:t("orders.download_pdf"),children:e.jsx("span",{children:e.jsx(D,{size:"small",variant:"outlined",startIcon:f?e.jsx(q,{size:16}):e.jsx(ke,{}),onClick:M,disabled:f,children:t("orders.download_ticket")})})}),e.jsx(oe,{title:(w==null?void 0:w.discounted_price)===0?t("orders.free_ticket"):t("orders.download_invoice_pdf"),children:e.jsx("span",{children:e.jsx(D,{size:"small",variant:"outlined",startIcon:c?e.jsx(q,{size:16}):e.jsx(Te,{}),onClick:N,disabled:c||(w==null?void 0:w.discounted_price)===0,children:(w==null?void 0:w.discounted_price)===0?t("orders.free_ticket"):t("orders.download_invoice")})})}),e.jsx(b,{sx:{ml:"auto"},children:e.jsx(J,{label:t("filters.status_label"),value:R,options:Object.values(d),onChange:L=>{C(L),E(W[L])}})}),e.jsx(D,{variant:"contained",size:"small",onClick:A,disabled:T||!z,startIcon:T?e.jsx(q,{color:"inherit",size:16}):void 0,children:t(T?"orders.saving":"orders.save")})]})]})]})}function He({tickets:r,onSave:s,onRefresh:n,onCreate:t}){const{t:l}=U("orders");return r.length===0?e.jsx(h,{variant:"h4",sx:{textAlign:"center"},children:l("errors.not_found_tickets")}):e.jsxs(b,{sx:{display:"flex",gap:4,justifyContent:{xs:"center",md:"flex-start"},flexWrap:{xs:"wrap",md:"nowrap"},flexDirection:{xs:"row",md:"column"}},children:[e.jsx(Ne,{onCreate:t}),r.map(p=>e.jsx(Ge,{ticket:p,onSave:s,onRefresh:n},p.token))]})}function Xe(){const r=O(s=>s.authToken);return async function(s){try{return await B.post(`${F}/api/tickets`,s,{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}}),!0}catch{return!1}}}function Ye({open:r,onClose:s,onRefresh:n}){if(!r)return null;const{t}=U("orders"),l=O(m=>m.authToken),{notify:p}=Q(),j=Xe(),[f,g]=o.useState(null),[c,x]=o.useState(null),[i,a]=o.useState(1),[u,v]=o.useState("fr"),[_,$]=o.useState(!1),[S,d]=o.useState(!1),[y,E]=o.useState(!1),[R,C]=o.useState(null),[z,W]=o.useState(null),[T,I]=o.useState(null),[A,M]=o.useState(null),N={Authorization:`Bearer ${l}`,"Accept-Language":u};o.useEffect(()=>{f!==null&&f>0?(C(null),d(!0),I(null),B.get(`${F}/api/users/${f}`,{headers:N}).then(m=>I(m.data.user)).catch(m=>{C(t("errors.user_not_found"))})):(I(null),C(null),d(!1))},[f]),o.useEffect(()=>{T!=null&&T.email&&B.get(`${F}/api/users?email=${encodeURIComponent(T.email)}`,{headers:N}).then(m=>{const k=m.data.data.users;Array.isArray(k)&&k.length>0?k[0].role!=="user"?(C(t("errors.only_users_allowed")),I(null)):C(null):(C(t("errors.user_not_found")),I(null))}).catch(m=>{C(t("errors.user_not_found")),I(null)}).finally(()=>d(!1))},[T]),o.useEffect(()=>{c!==null&&c>0?(W(null),E(!0),M(null),B.get(`${F}/api/products/${c}`,{headers:N}).then(m=>M(m.data.data)).catch(m=>{W(t("errors.product_not_found"))}).finally(()=>E(!1))):(M(null),W(null))},[c,u]);const w=async()=>{$(!0);const k=await j({user_id:f,product_id:c,quantity:i,locale:u});$(!1),k?(p(t("freeTicket.success"),"success"),n(),s()):p(t("errors.save_failed"),"error")};return e.jsxs(Se,{open:r,onClose:s,maxWidth:"sm",fullWidth:!0,children:[e.jsx(Ce,{children:t("freeTicket.title")}),e.jsx(X,{}),e.jsxs(Ie,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsx(Y,{type:"number",label:t("freeTicket.userId"),value:f!=null?String(f):"",onChange:m=>{const k=parseInt(m,10);g(Number.isNaN(k)?null:k)}}),e.jsx(Y,{type:"number",label:t("freeTicket.productId"),value:c!=null?String(c):"",onChange:m=>{const k=parseInt(m,10);x(Number.isNaN(k)?null:k)}}),e.jsx(Y,{type:"number",label:t("freeTicket.quantity"),value:String(i),onChange:m=>{const k=parseInt(m,10);a(Number.isNaN(k)?0:k)}}),e.jsx(Pe,{legend:t("freeTicket.locale"),value:u,options:[{value:"fr",label:t("freeTicket.fr")},{value:"en",label:t("freeTicket.en")},{value:"de",label:t("freeTicket.de")}],onChange:v}),e.jsx(X,{}),e.jsx(h,{variant:"body1",children:t("freeTicket.previsualisation")}),e.jsxs(b,{sx:{display:"grid",gap:2,gridTemplateColumns:{xs:"1fr",md:"1fr 1fr"},pt:1},children:[(S||y)&&e.jsx(b,{sx:{gridColumn:"1 / -1",textAlign:"center"},children:e.jsx(le,{})}),R&&e.jsx(b,{sx:{gridColumn:"1 / -1"},color:"error.main",children:R}),z&&e.jsx(b,{sx:{gridColumn:"1 / -1"},color:"error.main",children:z}),!S&&!R&&T&&e.jsx(V,{variant:"outlined",children:e.jsxs(G,{children:[e.jsx(h,{variant:"subtitle1",gutterBottom:!0,children:t("freeTicket.user")}),e.jsx(h,{sx:{wordBreak:"break-word",overflowWrap:"anywhere"},children:`${T.firstname} ${T.lastname}`}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{wordBreak:"break-word",overflowWrap:"anywhere"},children:T.email})]})}),!y&&!z&&A&&e.jsx(V,{variant:"outlined",children:e.jsxs(G,{children:[e.jsx(h,{variant:"subtitle1",gutterBottom:!0,children:t("freeTicket.product")}),e.jsx(h,{variant:"body1",sx:{wordBreak:"break-word",overflowWrap:"anywhere",mb:1},children:A.name}),e.jsx(h,{variant:"body2",sx:{wordBreak:"break-word",overflowWrap:"anywhere"},children:t("freeTicket.productDetails")}),e.jsxs(h,{variant:"body2",color:"text.secondary",sx:{wordBreak:"break-word",overflowWrap:"anywhere"},children:[t("freeTicket.places",{count:A.product_details.places})," "]}),e.jsxs(h,{variant:"body2",color:"text.secondary",sx:{wordBreak:"break-word",overflowWrap:"anywhere"},children:[P(A.product_details.date,u)," - ",A.product_details.time]}),e.jsx(h,{variant:"body2",color:"text.secondary",sx:{wordBreak:"break-word",overflowWrap:"anywhere"},children:A.product_details.location})]})}),!S&&!y&&!R&&!z&&!T&&!A&&e.jsx(b,{sx:{gridColumn:"1 / -1"},children:e.jsx(h,{children:t("freeTicket.noDetails")})})]})]}),e.jsx(X,{}),e.jsxs(Ae,{children:[e.jsx(D,{onClick:s,children:t("freeTicket.cancel")}),e.jsx(D,{onClick:w,variant:"contained",disabled:_||!f||!c||i<=0||!u||f<=0||c<=0,startIcon:_?e.jsx(q,{color:"inherit",size:16}):void 0,children:t(_?"freeTicket.creation":"freeTicket.create")})]})]})}function _t(){const{t:r}=U("orders"),s=O(a=>a.authToken),n=We(),[t,l]=o.useState({status:"",user_id:void 0,per_page:5,page:1}),{tickets:p,total:j,loading:f,error:g,validationErrors:c}=Fe(t,s),[x,i]=o.useState(!1);return o.useEffect(()=>{if(c){const a={};c.user_id&&(a.user_id=void 0),l(u=>({...u,...a}))}},[c]),g?e.jsx(se,{children:e.jsx(pe,{title:r("errors.title"),message:r("errors.message"),showRetry:!0,retryButtonText:r("errors.retry"),onRetry:()=>l(a=>({...a})),showHome:!0,homeButtonText:r("errors.go_home")})}):e.jsxs(e.Fragment,{children:[e.jsx(fe,{title:r("seo.title"),description:r("seo.description")}),e.jsxs(se,{disableCard:!0,children:[e.jsx(h,{variant:"h4",sx:{px:2},children:r("orders.title")}),e.jsxs(b,{sx:{display:"flex",flexDirection:{xs:"column",md:"row"},gap:2,p:2},children:[e.jsx(Me,{filters:t,onChange:a=>l(u=>({...u,...a}))}),e.jsxs(b,{component:"main",flex:1,children:[f?e.jsx(b,{textAlign:"center",py:8,children:e.jsx(le,{})}):e.jsx(He,{tickets:p,onSave:async(a,u)=>await n(a,{status:u.status}),onRefresh:()=>l(a=>({...a})),onCreate:()=>i(!0)}),!f&&p.length>0&&e.jsx(b,{textAlign:"center",mt:4,children:e.jsx(Le,{count:Math.ceil(j/t.per_page)||1,page:t.page,onChange:(a,u)=>l(v=>({...v,page:u}))})})]})]})]}),e.jsx(Ye,{open:x,onClose:()=>i(!1),onRefresh:()=>l(a=>({...a}))})]})}export{_t as default};
