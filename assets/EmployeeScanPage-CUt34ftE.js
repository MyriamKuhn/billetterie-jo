import{r,j as t}from"./react-C0aVURRx.js";import{b as z,a as L,P as _,O as P,S as D,A as T}from"./index-CY5QxFiC.js";import{a as B}from"./axios-Dq7h7Pqt.js";import{f as R}from"./format-_gz818Hm.js";import{E as H}from"./ErrorDisplay-CqpRduDy.js";import{F as M}from"./FilterField-pDWxjenY.js";import{y as w,v as a,V as E,q as f,B as j,C as V,W as O,r as Q}from"./mui-CUyLNCSY.js";import{H as W}from"./qr-scanner-DnACvvLV.js";import{g as U}from"./ticket-B4owiMUc.js";import{u as G}from"./i18n-react-DKLIrUu3.js";import"./dayjs-DMyafwSS.js";import"./zustand-DgaMZn_z.js";import"./vendor-DdBxgcTm.js";import"./i18n-Bhc83OLH.js";import"./emotion-3DDxC2qG.js";import"./helmet-D-y5f56R.js";import"./cookie-consent-h1U6JL3J.js";function J(e,d,o){const i=r.useRef(null),c=r.useRef(!1),l=r.useCallback(async()=>{if(i.current){try{await i.current.clear()}catch{}try{await i.current.start({facingMode:"environment"},{fps:10,qrbox:250},d,()=>{}),c.current=!0}catch(x){o(x)}}},[d,o]),s=r.useCallback(async()=>{if(c.current&&i.current){try{await i.current.stop()}catch{}c.current=!1}},[]);return r.useEffect(()=>{if(!i.current)return i.current=new W(e),l(),()=>{s()}},[e,l,s]),{start:l,stop:s}}function xt(){const{t:e}=G("employee"),d=z(n=>n.authToken),o=L(n=>n.lang),i="qr-reader",[c,l]=r.useState(""),[s,x]=r.useState(null),[g,u]=r.useState(null),[F,y]=r.useState(!1),[v,b]=r.useState(!1),[k,h]=r.useState(!1),{start:I,stop:p}=J("qr-reader",n=>{p(),C(n)},()=>u(e("scan.camera_error")));r.useEffect(()=>()=>{p()},[p]);const C=n=>{y(!0),h(!1),u(null),B.get(`${T}/api/tickets/scan/${n}`,{headers:{Authorization:`Bearer ${d}`,"Accept-Language":o}}).then(m=>x({...m.data,ticket_token:n})).catch(m=>{var A;((A=m.response)==null?void 0:A.status)===404?u(e("scan.not_found")):u(e("scan.fetch_error"))}).finally(()=>{y(!1),l("")})},$=()=>{c.trim()&&(p(),C(c.trim()))},q=()=>{b(!0),h(!1),B.post(`${T}/api/tickets/scan/${s.token}`,{},{headers:{Authorization:`Bearer ${d}`,"Accept-Language":o}}).then(n=>{x(m=>({...m,...n.data})),h(!0)}).catch(n=>{u(e("errors.validate_error"))}).finally(()=>b(!1))},S=()=>{y(!1),x(null),u(null),h(!1),l(""),b(!1),I()};return g?t.jsx(_,{children:t.jsx(H,{title:e("errors.genericErrorTitle"),message:g,showRetry:!0,retryButtonText:e("errors.retry"),onRetry:()=>{window.location.reload()},showHome:!0,homeButtonText:e("errors.home")})}):F?t.jsx(_,{disableCard:!0,children:t.jsxs(w,{sx:{p:2,textAlign:"center"},children:[t.jsx(P,{}),t.jsx(a,{variant:"h5",sx:{mt:2},children:e("scan.fetching")})]})}):t.jsxs(t.Fragment,{children:[t.jsx(D,{title:e("seo.title"),description:e("seo.description")}),t.jsx(_,{disableCard:!0,children:t.jsxs(w,{sx:{p:2,display:"flex",flexDirection:"column",alignItems:"center"},children:[!s&&!g&&t.jsxs(t.Fragment,{children:[t.jsx(a,{variant:"h4",gutterBottom:!0,children:e("scan.title")}),t.jsxs(E,{sx:{textAlign:"center"},children:[t.jsx(a,{variant:"body2",color:"text.secondary",sx:{mb:2},children:e("scan.scan_instructions")}),t.jsx(f,{id:i,sx:{width:{xs:200,sm:250,md:300},height:{xs:200,sm:250,md:300},mx:"auto"}}),t.jsx(a,{variant:"body2",color:"text.secondary",sx:{mb:2},children:e("scan.instructions_manual")}),t.jsxs(f,{component:"form",onSubmit:n=>{n.preventDefault(),$()},sx:{mb:3,display:"flex",flexDirection:"column",gap:1,justifyContent:"center"},children:[t.jsx(M,{label:e("scan.manual_label"),value:c,onChange:l}),t.jsx(j,{type:"submit",variant:"contained",children:e("scan.manual_button")})]})]})]}),s&&t.jsxs(t.Fragment,{children:[t.jsx(a,{variant:"h4",gutterBottom:!0,children:e(k?"scan.validated_title":"scan.verification_title")}),k&&t.jsxs(f,{sx:{textAlign:"center",mb:2},children:[t.jsx(V,{sx:{fontSize:60,color:"success.main",display:"block",mx:"auto",mb:1}}),t.jsx(a,{variant:"h5",children:e("scan.validated_message",{dt:R(s.used_at,o)})}),t.jsx(j,{variant:"contained",onClick:S,sx:{mt:5},children:e("scan.reset_button")})]}),!k&&t.jsxs(t.Fragment,{children:[t.jsx(a,{variant:"body2",color:"text.secondary",sx:{mb:2},children:e("scan.verification_instructions")}),t.jsxs(E,{sx:{textAlign:"left"},children:[t.jsxs(a,{variant:"h6",gutterBottom:!0,children:[t.jsx(O,{label:e(`scan.status.${s.status}`),color:U(s.status),size:"small",sx:{marginRight:1}}),s.event.name]}),t.jsx(a,{variant:"body1",children:e("scan.event_date",{date:R(s.event.date,o),time:s.event.time,location:s.event.location})}),t.jsx(a,{variant:"body1",sx:{mt:2},children:e("scan.client")}),t.jsxs(a,{variant:"body2",color:"text.secondary",children:[s.user.firstname," ",s.user.lastname,t.jsx("br",{}),s.user.email]}),t.jsx(a,{variant:"body1",sx:{mt:2},children:e("scan.event_places",{places:s.event.places})}),t.jsx(a,{variant:"subtitle2",color:"text.secondary",sx:{mt:2},children:e("scan.ticket_token",{token:s.ticket_token})}),t.jsx(a,{variant:"subtitle2",color:"text.secondary",children:e("scan.token",{token:s.token})}),s.status==="issued"?t.jsx(f,{sx:{display:"flex",justifyContent:"flex-end",mt:2},children:t.jsx(j,{variant:"contained",sx:{mt:2,alignSelf:"flex-end"},onClick:q,disabled:v,startIcon:v?t.jsx(Q,{size:20}):null,children:e(v?"scan.validating":"scan.validate_button")})}):t.jsx(f,{sx:{display:"flex",justifyContent:"flex-end",mt:2},children:t.jsx(j,{variant:"contained",sx:{mt:2,alignSelf:"flex-end"},onClick:S,children:e("scan.reset_button")})})]})]})]})]})})]})}export{xt as default};
