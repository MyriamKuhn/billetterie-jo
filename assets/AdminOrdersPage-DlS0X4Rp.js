import{r as n,j as e}from"./react-C0aVURRx.js";import{A as W,b as z,a as ue,O as le,P as se,S as fe}from"./index-C8vFMK_G.js";import{E as pe}from"./ErrorDisplay-Zu0HG1b7.js";import{a as D}from"./axios-Dq7h7Pqt.js";import{u as xe,q as j,v as x,O as me,aq as he,a1 as ge,r as N,B as P,I as ae,p as je,t as _e,a5 as ye,y as Q,V,am as we,U as be,an as ve,W as ne,al as oe,ao as ke,R as Te,X as Se,_ as Ce,i as X,Y as Ie,$ as Ae,a0 as $e}from"./mui-uHutCCHi.js";import{F as J}from"./FilterSelect-CNa929qR.js";import{u as Le}from"./useUsers-CBZkbi0s.js";import{u as B}from"./i18n-react-InMECBPB.js";import{aa as Ue}from"./vendor-DWEXA6-K.js";import{u as G}from"./useCustomSnackbar-D46cyU61.js";import{u as Be}from"./useProductDetails-OoFSfj7n.js";import{e as Ee,f as Oe}from"./billingService-6ouJ5OLm.js";import{u as De}from"./useAdminDownloadInvoice-BGvanYSe.js";import{T as Pe}from"./TicketCardSkeleton-DmJ4mS02.js";import{f as R,a as ze}from"./format-_gz818Hm.js";import{F as Y}from"./FilterField-B6HJt_C_.js";import{F as Re}from"./FilterRadios-D3ajFuhJ.js";import"./dayjs-DMyafwSS.js";import"./zustand-DgaMZn_z.js";import"./i18n-Bhc83OLH.js";import"./emotion-BfGcg3ty.js";import"./helmet-BZ3LMwLd.js";import"./cookie-consent-DtjjNNxi.js";function We(r,s){const[o,t]=n.useState([]),[l,c]=n.useState(0),[k,u]=n.useState(!1),[_,f]=n.useState(null),[w,p]=n.useState(null);return n.useEffect(()=>{u(!0),f(null),p(null);const a={per_page:Math.max(1,r.per_page),page:r.page,...r.status&&{status:r.status},...r.user_id&&{user_id:r.user_id}};D.get(`${W}/api/tickets`,{params:a,headers:{Authorization:`Bearer ${s}`}}).then(d=>{t(d.data.data),c(d.data.meta.total)}).catch(d=>{var b;if(D.isAxiosError(d)){const h=(b=d.response)==null?void 0:b.status;if(h===422){p(d.response.data.errors);return}if(h===404){t([]),c(0);return}}f(d.code)}).finally(()=>u(!1))},[r]),{tickets:o,total:l,loading:k,error:_,validationErrors:w}}function Fe(){const r=z(s=>s.authToken);return async function(o,t){try{return await D.put(`${W}/api/tickets/admin/${o}/status`,t,{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}}),!0}catch{return!1}}}function qe({filters:r,onChange:s}){const{t:o}=B("orders"),t=xe(),[l,c]=n.useState(!1),k=z(i=>i.authToken),u=n.useMemo(()=>({firstname:"",lastname:"",email:"",perPage:1e9,page:1}),[r.per_page]),{users:_,loading:f}=Le(u,k,"user"),w=n.useMemo(()=>({label:o("filters.user_all"),id:void 0}),[o]),p=n.useMemo(()=>[w,..._.map(i=>({label:`${i.firstname} ${i.lastname} (${i.email})`,id:i.id}))],[_,w]),a={"":o("filters.status_all"),issued:o("filters.status_issued"),used:o("filters.status_used"),refunded:o("filters.status_refunded"),cancelled:o("filters.status_cancelled")},d=Object.values(a),b=Object.fromEntries(Object.entries(a).map(([i,y])=>[y,i])),h=a[r.status],L=n.useCallback((i,y,U)=>{s(U==="clear"?{user_id:void 0,page:1}:{user_id:y==null?void 0:y.id,page:1})},[s]),C=e.jsxs(j,{sx:{width:260,py:2,px:1},children:[e.jsx(x,{variant:"h6",gutterBottom:!0,children:o("filters.title")}),e.jsxs(me,{spacing:2,sx:{mx:1},children:[e.jsx(J,{label:o("filters.status_label"),value:h,options:d,onChange:i=>s({status:b[i],page:1})}),e.jsx(he,{clearText:o("filters.clear_user"),size:"small",options:p,loading:f,value:p.find(i=>i.id===r.user_id)??w,onChange:L,isOptionEqualToValue:(i,y)=>i.id===y.id,getOptionLabel:i=>i.label,filterOptions:(i,{inputValue:y})=>i.filter(U=>U.label.toLowerCase().includes(y.toLowerCase())),renderInput:i=>e.jsx(ge,{...i,label:o("filters.user"),InputProps:{...i.InputProps,endAdornment:e.jsxs(e.Fragment,{children:[f&&e.jsx(N,{size:16}),i.InputProps.endAdornment]})}})}),e.jsx(J,{label:o("filters.per_page"),value:String(r.per_page),options:["5","10","25","50","100"],onChange:i=>{const y=parseInt(i,10);s({per_page:y,page:1})}}),e.jsx(P,{variant:"outlined",fullWidth:!0,onClick:()=>s({status:"",user_id:void 0,per_page:5,page:1}),children:o("filters.reset")})]})]});return e.jsxs(e.Fragment,{children:[e.jsx(j,{component:"aside",sx:{display:{xs:"none",md:"block"},position:"sticky",top:t.mixins.toolbar.minHeight,bgcolor:"background.paper",border:`1px solid ${t.palette.divider}`,borderRadius:1,width:260},children:C}),e.jsxs(j,{sx:{display:{xs:"block",md:"none"},mb:2},children:[e.jsx(ae,{onClick:()=>c(!0),"aria-label":o("filters.title"),children:e.jsx(je,{})}),e.jsx(_e,{open:l,onClose:()=>c(!1),keepMounted:!0,children:e.jsxs(j,{sx:{position:"relative"},children:[e.jsx(ae,{onClick:()=>c(!1),size:"small",sx:{position:"absolute",top:8,right:8},"aria-label":o("filters.close"),children:e.jsx(ye,{})}),C]})})]})]})}function Me({onCreate:r}){const{t:s}=B("orders");return e.jsxs(Q,{sx:{p:2,minWidth:240,display:"flex",flexDirection:"column",justifyContent:"space-between"},children:[e.jsxs(V,{children:[e.jsx(x,{variant:"h6",gutterBottom:!0,children:s("tickets.create_new")}),e.jsx(x,{variant:"body2",color:"text.secondary",children:s("tickets.create_intro")})]}),e.jsx(j,{sx:{p:2,pt:0},children:e.jsx(P,{fullWidth:!0,variant:"contained",onClick:r,children:s("tickets.create_button")})})]})}function Ne(){const r=z(k=>k.authToken),{t:s}=B("orders"),{notify:o}=G(),[t,l]=n.useState(!1);return{download:async k=>{var _,f;if(!r){o(s("errors.not_authenticated"),"warning");return}const u=k.replace(/^.*[\\/]/,"");if(!u){o(s("errors.download_failed"),"error");return}l(!0);try{const w=await Ee(u,r),p=window.URL.createObjectURL(w),a=document.createElement("a");a.href=p,a.download=u,document.body.appendChild(a),a.click(),a.remove(),window.URL.revokeObjectURL(p),o(s("tickets.download_success"),"success")}catch(w){let p=s("errors.download_failed"),a="error";((_=w.response)==null?void 0:_.status)===404?(p=s("errors.not_found"),a="warning"):((f=w.response)==null?void 0:f.status)===401&&(p=s("errors.unauthorized"),a="warning"),o(p,a)}finally{l(!1)}},downloading:t}}function Qe(r){const s=z(_=>_.authToken),{notify:o}=G(),{t}=B("orders"),[l,c]=n.useState(null),[k,u]=n.useState(!1);return n.useEffect(()=>{let _=!1;if(l&&(URL.revokeObjectURL(l),c(null)),!r)return;if(!s){o(t("errors.not_authenticated"),"warning");return}const f=r.replace(/^.*[\\/]/,"");return(async()=>{var p,a;u(!0);try{const d=await Oe(f,s);if(_)return;const b=URL.createObjectURL(d);c(b)}catch(d){let b=t("errors.qr_fetch_failed");((p=d.response)==null?void 0:p.status)===404?b=t("errors.qr_not_found"):((a=d.response)==null?void 0:a.status)===401&&(b=t("errors.unauthorized")),o(b,"error")}finally{_||u(!1)}})(),()=>{_=!0}},[r,s]),{qrUrl:l,loading:k}}const ie=r=>{switch(r){case"paid":return"success";case"pending":return"info";case"refunded":return"warning";case"failed":return"error";default:return"default"}};function Ve({ticket:r,onSave:s,onRefresh:o}){var Z,ee,te,re;const{t}=B("orders"),l=ue($=>$.lang),{notify:c}=G(),{download:k,downloading:u}=Ne(),{download:_,downloading:f}=De(),{ref:w,inView:p}=Ue({triggerOnce:!0,rootMargin:"200px"}),{qrUrl:a,loading:d}=Qe(p?r.qr_filename:null),b=((Z=r.product_snapshot)==null?void 0:Z.product_id)??0,{product:h,loading:L,error:C}=Be(b,l);n.useEffect(()=>{!L&&C&&c(t("errors.product_fetch_failed"),"warning")},[L,C,c,t]);const i={issued:t("filters.status_issued"),used:t("filters.status_used"),refunded:t("filters.status_refunded"),cancelled:t("filters.status_cancelled")},[y,U]=n.useState(r.status),[E,I]=n.useState(i[r.status]??""),O=n.useMemo(()=>y!==r.status,[y,r.status]),F=Object.fromEntries(Object.entries(i).map(([$,ce])=>[ce,$])),[T,A]=n.useState(!1),S=async()=>{A(!0);try{if(await s(r.id,{status:y}))c(t("orders.save_success"),"success"),o();else throw new Error}catch{c(t("errors.save_error"),"error")}finally{A(!1)}},q=()=>{r.pdf_filename?k(r.pdf_filename).catch(()=>c(t("errors.download_error"),"error")):c(t("errors.no_pdf"),"warning")},M=()=>{const $=`invoice_${r.payment.uuid}.pdf`;_($).catch(()=>c(t("errors.invoice_download_error"),"error"))};if(L)return e.jsx(Pe,{});const g=r.product_snapshot,m=r.user,v=C||!h?t("orders.no_product"):`${g==null?void 0:g.product_name} (${r.token})`,H=(ee=h==null?void 0:h.product_details)!=null&&ee.date?R(h.product_details.date,l):"",K=((te=h==null?void 0:h.product_details)==null?void 0:te.time)??"",de=((re=h==null?void 0:h.product_details)==null?void 0:re.location)??t("orders.no_location");return e.jsxs(Q,{ref:w,sx:{display:"flex",flexDirection:{xs:"column",md:"row"},gap:2,p:2},children:[e.jsx(j,{sx:{minWidth:{md:200},textAlign:"center"},children:d?e.jsx(we,{variant:"rectangular",width:200,height:200}):a?e.jsx(be,{component:"img",image:a,alt:t("orders.qr_alt"),sx:{width:200,height:200,objectFit:"contain"}}):e.jsx(j,{sx:{width:200,height:200,display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"background.default"},children:e.jsx(ve,{fontSize:"large",color:"disabled"})})}),e.jsxs(V,{sx:{flexGrow:1},children:[e.jsxs(j,{sx:{display:"flex",alignItems:"center",mb:1},children:[e.jsx(x,{variant:"h6",children:t("orders.ticket_id",{id:r.id})}),r.payment.status==="paid"&&(g==null?void 0:g.discounted_price)===0?e.jsx(ne,{label:t("orders.free_ticket"),color:ie(r.payment.status),size:"small",sx:{ml:1}}):e.jsx(ne,{label:t(`invoices.status.${r.payment.status}`),color:ie(r.payment.status),size:"small",sx:{ml:1}})]}),e.jsx(x,{variant:"subtitle1",gutterBottom:!0,children:v}),H&&e.jsxs(x,{variant:"body2",color:"text.secondary",children:[H,K&&` – ${K}`]}),e.jsx(x,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:de}),e.jsx(x,{variant:"body1",sx:{mt:1},children:t("orders.price_paid",{price:ze(g==null?void 0:g.discounted_price,l)})}),m&&e.jsx(x,{variant:"body1",children:t("orders.user_info",{id:m.id,name:`${m.firstname} ${m.lastname}`,email:m.email})}),e.jsxs(x,{variant:"caption",color:"text.secondary",sx:{mt:1},children:[t("orders.created_at",{date:R(r.created_at,l)}),r.used_at&&` – ${t("orders.used_at",{date:R(r.used_at,l)})}`,r.refunded_at&&` – ${t("orders.refunded_at",{date:R(r.refunded_at,l)})}`,r.cancelled_at&&` – ${t("orders.cancelled_at",{date:R(r.cancelled_at,l)})}`]}),e.jsxs(j,{sx:{mt:2,display:"flex",flexWrap:"wrap",gap:1,alignItems:"center"},children:[e.jsx(oe,{title:t("orders.download_pdf"),children:e.jsx("span",{children:e.jsx(P,{size:"small",variant:"outlined",startIcon:u?e.jsx(N,{size:16}):e.jsx(ke,{}),onClick:q,disabled:u,children:t("orders.download_ticket")})})}),e.jsx(oe,{title:(g==null?void 0:g.discounted_price)===0?t("orders.free_ticket"):t("orders.download_invoice_pdf"),children:e.jsx("span",{children:e.jsx(P,{size:"small",variant:"outlined",startIcon:f?e.jsx(N,{size:16}):e.jsx(Te,{}),onClick:M,disabled:f||(g==null?void 0:g.discounted_price)===0,children:(g==null?void 0:g.discounted_price)===0?t("orders.free_ticket"):t("orders.download_invoice")})})}),e.jsx(j,{sx:{ml:"auto"},children:e.jsx(J,{label:t("filters.status_label"),value:E,options:Object.values(i),onChange:$=>{I($),U(F[$])}})}),e.jsx(P,{variant:"contained",size:"small",onClick:S,disabled:T||!O,startIcon:T?e.jsx(N,{color:"inherit",size:16}):void 0,children:t(T?"orders.saving":"orders.save")})]})]})]})}function Ge({tickets:r,onSave:s,onRefresh:o,onCreate:t}){const{t:l}=B("orders");return r.length===0?e.jsx(x,{variant:"h4",sx:{textAlign:"center"},children:l("errors.not_found_tickets")}):e.jsxs(j,{sx:{display:"flex",gap:4,justifyContent:{xs:"center",md:"flex-start"},flexWrap:{xs:"wrap",md:"nowrap"},flexDirection:{xs:"row",md:"column"}},children:[e.jsx(Me,{onCreate:t}),r.map(c=>e.jsx(Ve,{ticket:c,onSave:s,onRefresh:o},c.token))]})}function He(){const r=z(s=>s.authToken);return async function(s){try{return await D.post(`${W}/api/tickets`,s,{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}}),!0}catch{return!1}}}function Xe({open:r,onClose:s,onRefresh:o}){if(!r)return null;const{t}=B("orders"),l=z(m=>m.authToken),{notify:c}=G(),k=He(),[u,_]=n.useState(null),[f,w]=n.useState(null),[p,a]=n.useState(1),[d,b]=n.useState("fr"),[h,L]=n.useState(!1),[C,i]=n.useState(!1),[y,U]=n.useState(!1),[E,I]=n.useState(null),[O,F]=n.useState(null),[T,A]=n.useState(null),[S,q]=n.useState(null),M={Authorization:`Bearer ${l}`,"Accept-Language":d};n.useEffect(()=>{u!==null&&u>0?(I(null),i(!0),A(null),D.get(`${W}/api/users/${u}`,{headers:M}).then(m=>A(m.data.user)).catch(m=>{I(t("errors.user_not_found"))})):(A(null),I(null),i(!1))},[u]),n.useEffect(()=>{T!=null&&T.email&&D.get(`${W}/api/users?email=${encodeURIComponent(T.email)}`,{headers:M}).then(m=>{const v=m.data.data.users;Array.isArray(v)&&v.length>0?v[0].role!=="user"?(I(t("errors.only_users_allowed")),A(null)):I(null):(I(t("errors.user_not_found")),A(null))}).catch(m=>{I(t("errors.user_not_found")),A(null)}).finally(()=>i(!1))},[T]),n.useEffect(()=>{f!==null&&f>0?(F(null),U(!0),q(null),D.get(`${W}/api/products/${f}`,{headers:M}).then(m=>q(m.data.data)).catch(m=>{F(t("errors.product_not_found"))}).finally(()=>U(!1))):(q(null),F(null))},[f,d]);const g=async()=>{L(!0);const v=await k({user_id:u,product_id:f,quantity:p,locale:d});L(!1),v?(c(t("freeTicket.success"),"success"),o(),s()):c(t("errors.save_failed"),"error")};return e.jsxs(Se,{open:r,onClose:s,maxWidth:"sm",fullWidth:!0,children:[e.jsx(Ce,{children:t("freeTicket.title")}),e.jsx(X,{}),e.jsxs(Ie,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsx(Y,{type:"number",label:t("freeTicket.userId"),value:u!=null?String(u):"",onChange:m=>{const v=parseInt(m,10);_(Number.isNaN(v)?null:v)}}),e.jsx(Y,{type:"number",label:t("freeTicket.productId"),value:f!=null?String(f):"",onChange:m=>{const v=parseInt(m,10);w(Number.isNaN(v)?null:v)}}),e.jsx(Y,{type:"number",label:t("freeTicket.quantity"),value:String(p),onChange:m=>{const v=parseInt(m,10);a(Number.isNaN(v)?0:v)}}),e.jsx(Re,{legend:t("freeTicket.locale"),value:d,options:[{value:"fr",label:t("freeTicket.fr")},{value:"en",label:t("freeTicket.en")},{value:"de",label:t("freeTicket.de")}],onChange:b}),e.jsx(X,{}),e.jsx(x,{variant:"body1",children:t("freeTicket.previsualisation")}),e.jsxs(j,{sx:{display:"grid",gap:2,gridTemplateColumns:{xs:"1fr",md:"1fr 1fr"},pt:1},children:[(C||y)&&e.jsx(j,{sx:{gridColumn:"1 / -1",textAlign:"center"},children:e.jsx(le,{})}),E&&e.jsx(j,{sx:{gridColumn:"1 / -1"},color:"error.main",children:E}),O&&e.jsx(j,{sx:{gridColumn:"1 / -1"},color:"error.main",children:O}),!C&&!E&&T&&e.jsx(Q,{variant:"outlined",children:e.jsxs(V,{children:[e.jsx(x,{variant:"subtitle1",gutterBottom:!0,children:t("freeTicket.user")}),e.jsx(x,{sx:{wordBreak:"break-word",overflowWrap:"anywhere"},children:`${T.firstname} ${T.lastname}`}),e.jsx(x,{variant:"body2",color:"text.secondary",sx:{wordBreak:"break-word",overflowWrap:"anywhere"},children:T.email})]})}),!y&&!O&&S&&e.jsx(Q,{variant:"outlined",children:e.jsxs(V,{children:[e.jsx(x,{variant:"subtitle1",gutterBottom:!0,children:t("freeTicket.product")}),e.jsx(x,{variant:"body1",sx:{wordBreak:"break-word",overflowWrap:"anywhere",mb:1},children:S.name}),e.jsx(x,{variant:"body2",sx:{wordBreak:"break-word",overflowWrap:"anywhere"},children:t("freeTicket.productDetails")}),e.jsxs(x,{variant:"body2",color:"text.secondary",sx:{wordBreak:"break-word",overflowWrap:"anywhere"},children:[t("freeTicket.places",{count:S.product_details.places})," "]}),e.jsxs(x,{variant:"body2",color:"text.secondary",sx:{wordBreak:"break-word",overflowWrap:"anywhere"},children:[R(S.product_details.date,d)," - ",S.product_details.time]}),e.jsx(x,{variant:"body2",color:"text.secondary",sx:{wordBreak:"break-word",overflowWrap:"anywhere"},children:S.product_details.location}),e.jsx(x,{variant:"body2",color:S.stock_quantity<=0?"error.main":"success",sx:{wordBreak:"break-word",overflowWrap:"anywhere",mt:1},children:t("freeTicket.stock",{quantity:S.stock_quantity})})]})}),!C&&!y&&!E&&!O&&!T&&!S&&e.jsx(j,{sx:{gridColumn:"1 / -1"},children:e.jsx(x,{children:t("freeTicket.noDetails")})})]})]}),e.jsx(X,{}),e.jsxs(Ae,{children:[e.jsx(P,{onClick:s,children:t("freeTicket.cancel")}),e.jsx(P,{onClick:g,variant:"contained",disabled:h||!u||!f||p<=0||E!==null||O!==null||p>((S==null?void 0:S.stock_quantity)??0),startIcon:h?e.jsx(N,{color:"inherit",size:16}):void 0,children:t(h?"freeTicket.creation":"freeTicket.create")})]})]})}function _t(){const{t:r}=B("orders"),s=z(a=>a.authToken),o=Fe(),[t,l]=n.useState({status:"",user_id:void 0,per_page:5,page:1}),{tickets:c,total:k,loading:u,error:_,validationErrors:f}=We(t,s),[w,p]=n.useState(!1);return n.useEffect(()=>{if(f){const a={};f.user_id&&(a.user_id=void 0),l(d=>({...d,...a}))}},[f]),_?e.jsx(se,{children:e.jsx(pe,{title:r("errors.title"),message:r("errors.message"),showRetry:!0,retryButtonText:r("errors.retry"),onRetry:()=>l(a=>({...a})),showHome:!0,homeButtonText:r("errors.go_home")})}):e.jsxs(e.Fragment,{children:[e.jsx(fe,{title:r("seo.title"),description:r("seo.description")}),e.jsxs(se,{disableCard:!0,children:[e.jsx(x,{variant:"h4",sx:{px:2},children:r("orders.title")}),e.jsxs(j,{sx:{display:"flex",flexDirection:{xs:"column",md:"row"},gap:2,p:2},children:[e.jsx(qe,{filters:t,onChange:a=>l(d=>({...d,...a}))}),e.jsxs(j,{component:"main",flex:1,children:[u?e.jsx(j,{textAlign:"center",py:8,children:e.jsx(le,{})}):e.jsx(Ge,{tickets:c,onSave:async(a,d)=>await o(a,{status:d.status}),onRefresh:()=>l(a=>({...a})),onCreate:()=>p(!0)}),!u&&c.length>0&&e.jsx(j,{textAlign:"center",mt:4,children:e.jsx($e,{count:Math.ceil(k/t.per_page)||1,page:t.page,onChange:(a,d)=>l(b=>({...b,page:d}))})})]})]})]}),e.jsx(Xe,{open:w,onClose:()=>p(!1),onRefresh:()=>l(a=>({...a}))})]})}export{_t as default};
