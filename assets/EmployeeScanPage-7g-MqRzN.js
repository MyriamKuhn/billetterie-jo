import{r,j as e}from"./react-C0aVURRx.js";import{b as z,a as L,P as _,O as P,S as D,A as T}from"./index-C8vFMK_G.js";import{a as w}from"./axios-Dq7h7Pqt.js";import{f as B}from"./format-_gz818Hm.js";import{E as M}from"./ErrorDisplay-Zu0HG1b7.js";import{F as V}from"./FilterField-B6HJt_C_.js";import{y as R,v as n,V as E,q as f,B as j,C as H,W as O,r as Q}from"./mui-uHutCCHi.js";import{af as W}from"./vendor-DWEXA6-K.js";import{u as U}from"./i18n-react-InMECBPB.js";import"./dayjs-DMyafwSS.js";import"./zustand-DgaMZn_z.js";import"./i18n-Bhc83OLH.js";import"./emotion-BfGcg3ty.js";import"./helmet-BZ3LMwLd.js";import"./cookie-consent-DtjjNNxi.js";function G(t,d,c){const i=r.useRef(null),o=r.useRef(!1),l=r.useCallback(async()=>{if(i.current){try{await i.current.clear()}catch{}try{await i.current.start({facingMode:"environment"},{fps:10,qrbox:250},d,()=>{}),o.current=!0}catch(x){c(x)}}},[d,c]),s=r.useCallback(async()=>{if(o.current&&i.current){try{await i.current.stop()}catch{}o.current=!1}},[]);return r.useEffect(()=>{if(!i.current)return i.current=new W(t),l(),()=>{s()}},[t,l,s]),{start:l,stop:s}}function J(t){switch(t){case"used":return"success";case"issued":return"info";case"refunded":return"warning";case"cancelled":return"error";default:return"default"}}function ue(){const{t}=U("employee"),d=z(a=>a.authToken),c=L(a=>a.lang),i="qr-reader",[o,l]=r.useState(""),[s,x]=r.useState(null),[g,u]=r.useState(null),[F,y]=r.useState(!1),[v,b]=r.useState(!1),[k,h]=r.useState(!1),{start:I,stop:p}=G("qr-reader",a=>{p(),C(a)},()=>u(t("scan.camera_error")));r.useEffect(()=>()=>{p()},[p]);const C=a=>{y(!0),h(!1),u(null),w.get(`${T}/api/tickets/scan/${a}`,{headers:{Authorization:`Bearer ${d}`,"Accept-Language":c}}).then(m=>x({...m.data,ticket_token:a})).catch(m=>{var A;((A=m.response)==null?void 0:A.status)===404?u(t("scan.not_found")):u(t("scan.fetch_error"))}).finally(()=>{y(!1),l("")})},$=()=>{o.trim()&&(p(),C(o.trim()))},q=()=>{b(!0),h(!1),w.post(`${T}/api/tickets/scan/${s.token}`,{},{headers:{Authorization:`Bearer ${d}`,"Accept-Language":c}}).then(a=>{x(m=>({...m,...a.data})),h(!0)}).catch(a=>{u(t("errors.validate_error"))}).finally(()=>b(!1))},S=()=>{y(!1),x(null),u(null),h(!1),l(""),b(!1),I()};return g?e.jsx(_,{children:e.jsx(M,{title:t("errors.genericErrorTitle"),message:g,showRetry:!0,retryButtonText:t("errors.retry"),onRetry:()=>{window.location.reload()},showHome:!0,homeButtonText:t("errors.home")})}):F?e.jsx(_,{disableCard:!0,children:e.jsxs(R,{sx:{p:2,textAlign:"center"},children:[e.jsx(P,{}),e.jsx(n,{variant:"h5",sx:{mt:2},children:t("scan.fetching")})]})}):e.jsxs(e.Fragment,{children:[e.jsx(D,{title:t("seo.title"),description:t("seo.subtitle")}),e.jsx(_,{disableCard:!0,children:e.jsxs(R,{sx:{p:2,display:"flex",flexDirection:"column",alignItems:"center"},children:[!s&&!g&&e.jsxs(e.Fragment,{children:[e.jsx(n,{variant:"h4",gutterBottom:!0,children:t("scan.title")}),e.jsxs(E,{sx:{textAlign:"center"},children:[e.jsx(n,{variant:"body2",color:"text.secondary",sx:{mb:2},children:t("scan.scan_instructions")}),e.jsx(f,{id:i,sx:{width:{xs:200,sm:250,md:300},height:{xs:200,sm:250,md:300},mx:"auto"}}),e.jsx(n,{variant:"body2",color:"text.secondary",sx:{mb:2},children:t("scan.instructions_manual")}),e.jsxs(f,{component:"form",onSubmit:a=>{a.preventDefault(),$()},sx:{mb:3,display:"flex",flexDirection:"column",gap:1,justifyContent:"center"},children:[e.jsx(V,{label:t("scan.manual_label"),value:o,onChange:l}),e.jsx(j,{type:"submit",variant:"contained",children:t("scan.manual_button")})]})]})]}),s&&e.jsxs(e.Fragment,{children:[e.jsx(n,{variant:"h4",gutterBottom:!0,children:t(k?"scan.validated_title":"scan.verification_title")}),k&&e.jsxs(f,{sx:{textAlign:"center",mb:2},children:[e.jsx(H,{sx:{fontSize:60,color:"success.main",display:"block",mx:"auto",mb:1}}),e.jsx(n,{variant:"h5",children:t("scan.validated_message",{dt:B(s.used_at,c)})}),e.jsx(j,{variant:"contained",onClick:S,sx:{mt:5},children:t("scan.reset_button")})]}),!k&&e.jsxs(e.Fragment,{children:[e.jsx(n,{variant:"body2",color:"text.secondary",sx:{mb:2},children:t("scan.verification_instructions")}),e.jsxs(E,{sx:{textAlign:"left"},children:[e.jsxs(n,{variant:"h6",gutterBottom:!0,children:[e.jsx(O,{label:t(`scan.status.${s.status}`),color:J(s.status),size:"small",sx:{marginRight:1}}),s.event.name]}),e.jsx(n,{variant:"body1",children:t("scan.event_date",{date:B(s.event.date,c),time:s.event.time,location:s.event.location})}),e.jsx(n,{variant:"body1",sx:{mt:2},children:t("scan.client")}),e.jsxs(n,{variant:"body2",color:"text.secondary",children:[s.user.firstname," ",s.user.lastname,e.jsx("br",{}),s.user.email]}),e.jsx(n,{variant:"body1",sx:{mt:2},children:t("scan.event_places",{places:s.event.places})}),e.jsx(n,{variant:"subtitle2",color:"text.secondary",sx:{mt:2},children:t("scan.ticket_token",{token:s.ticket_token})}),e.jsx(n,{variant:"subtitle2",color:"text.secondary",children:t("scan.token",{token:s.token})}),s.status==="issued"?e.jsx(f,{sx:{display:"flex",justifyContent:"flex-end",mt:2},children:e.jsx(j,{variant:"contained",sx:{mt:2,alignSelf:"flex-end"},onClick:q,disabled:v,startIcon:v?e.jsx(Q,{size:20}):null,children:t(v?"scan.validating":"scan.validate_button")})}):e.jsx(f,{sx:{display:"flex",justifyContent:"flex-end",mt:2},children:e.jsx(j,{variant:"contained",sx:{mt:2,alignSelf:"flex-end"},onClick:S,children:t("scan.reset_button")})})]})]})]})]})})]})}export{ue as default};
