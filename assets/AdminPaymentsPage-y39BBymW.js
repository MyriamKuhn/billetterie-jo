import{r as g,j as e}from"./react-C0aVURRx.js";import{A as q,b as R,a as z,P,S as B,O}from"./index-CY5QxFiC.js";import{E as M}from"./ErrorDisplay-CqpRduDy.js";import{a as S}from"./axios-Dq7h7Pqt.js";import{u as W,q as x,v as c,O as L,B as D,I as F,p as H,t as G,a5 as N,y as V,al as U,r as E,R as J,V as K,W as T,i as Q,av as X,a1 as Y,a0 as Z}from"./mui-CUyLNCSY.js";import{F as w}from"./FilterSelect-BlR2P65X.js";import{F as ee}from"./FilterField-pDWxjenY.js";import{u as v}from"./i18n-react-DKLIrUu3.js";import{b as k,f as C,a as I}from"./format-_gz818Hm.js";import{u as te}from"./useAdminDownloadInvoice-vjZCW4Zg.js";import{u as se}from"./useCustomSnackbar-Cbu9vsWE.js";import"./dayjs-DMyafwSS.js";import"./zustand-DgaMZn_z.js";import"./vendor-DdBxgcTm.js";import"./i18n-Bhc83OLH.js";import"./emotion-3DDxC2qG.js";import"./helmet-D-y5f56R.js";import"./cookie-consent-h1U6JL3J.js";import"./billingService-05Li523_.js";function ae(t,i){const[a,s]=g.useState([]),[r,f]=g.useState(0),[j,u]=g.useState(!1),[p,l]=g.useState(null),[n,d]=g.useState(null);return g.useEffect(()=>{u(!0),l(null),d(null);const y={per_page:Math.max(1,t.per_page),page:t.page,...t.status&&{status:t.status},...t.payment_method&&{payment_method:t.payment_method},...t.q&&{q:t.q}};S.get(`${q}/api/payments`,{params:y,headers:{Authorization:`Bearer ${i}`}}).then(h=>{s(h.data.data),f(h.data.meta.total)}).catch(h=>{var m;if(S.isAxiosError(h)){const o=(m=h.response)==null?void 0:m.status;if(o===422){d(h.response.data.errors);return}if(o===404){s([]),f(0);return}}l(h.code)}).finally(()=>u(!1))},[t]),{payments:a,total:r,loading:j,error:p,validationErrors:n}}function ne(){const t=R(i=>i.authToken);return async function(a,s){try{return await S.post(`${q}/api/payments/${a}/refund`,s,{headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}}),!0}catch{return!1}}}function re({filters:t,onChange:i}){const{t:a}=v("payments"),s=W(),[r,f]=g.useState(!1),j={"":a("filters.status_all"),pending:a("filters.status_pending"),paid:a("filters.status_paid"),failed:a("filters.status_failed"),refunded:a("filters.status_refunded")},u=Object.values(j),p=Object.fromEntries(Object.entries(j).map(([o,b])=>[b,o])),l=j[t.status],n=["","paypal","stripe","free"],d=n.map(o=>a(`filters.payment_method_${o}`)),y=n.includes(t.payment_method)?a(`filters.payment_method_${t.payment_method}`):a("filters.payment_method_all"),h=Object.fromEntries(n.map(o=>[a(`filters.payment_method_${o}`),o])),m=e.jsxs(x,{sx:{width:260,py:2,px:1},children:[e.jsx(c,{variant:"h6",gutterBottom:!0,children:a("filters.title")}),e.jsxs(L,{spacing:2,sx:{mx:1},children:[e.jsx(ee,{label:a("filters.name"),value:t.q,onChange:o=>i({q:o,page:1})}),e.jsx(w,{label:a("filters.status_label"),value:l,options:u,onChange:o=>i({status:p[o],page:1})}),e.jsx(w,{label:a("filters.payment_method_label"),value:y,options:d,onChange:o=>i({payment_method:h[o],page:1})}),e.jsx(w,{label:a("filters.per_page"),value:String(t.per_page),options:["5","10","25","50","100"],onChange:o=>{const b=parseInt(o,10);i({per_page:b,page:1})}}),e.jsx(D,{variant:"outlined",fullWidth:!0,onClick:()=>i({q:"",status:"",payment_method:"",per_page:5,page:1}),children:a("filters.reset")})]})]});return e.jsxs(e.Fragment,{children:[e.jsx(x,{component:"aside",sx:{display:{xs:"none",md:"block"},position:"sticky",top:s.mixins.toolbar.minHeight,bgcolor:"background.paper",border:`1px solid ${s.palette.divider}`,borderRadius:1,width:260},children:m}),e.jsxs(x,{sx:{display:{xs:"block",md:"none"},mb:2},children:[e.jsx(F,{onClick:()=>f(!0),"aria-label":a("filters.title"),children:e.jsx(H,{})}),e.jsx(G,{open:r,onClose:()=>f(!1),keepMounted:!0,children:e.jsxs(x,{sx:{position:"relative"},children:[e.jsx(F,{onClick:()=>f(!1),size:"small",sx:{position:"absolute",top:8,right:8},"aria-label":a("filters.close"),children:e.jsx(N,{})}),m]})})]})]})}const oe=t=>{switch(t){case"paid":return"success";case"pending":return"info";case"refunded":return"warning";case"failed":return"error";default:return"default"}};function ie({payment:t,onSave:i,onRefresh:a}){const{t:s}=v("payments"),r=z(_=>_.lang),{download:f,downloading:j}=te(),{notify:u}=se(),[p,l]=g.useState(""),[n,d]=g.useState(!1);let y;t.payment_method==="free"?y=s("payments.free_ticket"):y=s(`payments.status.${t.status}`);const h=oe(t.status),m=t.status==="paid"||t.status==="refunded";let o=s("payments.download_invoice");m||(t.status==="pending"?o=s("payments.download_not_ready"):t.status==="failed"?o=s("payments.download_not_available"):o=s("payments.download_not_available_generic"));const b=()=>{m?f(t.invoice_link):t.status==="pending"?u(s("snackbar.pending_message"),"warning"):t.status==="failed"?u(s("snackbar.failed_message"),"error"):u(s("snackbar.unavailable_message"),"info")},$=async()=>{const _=parseFloat(p);d(!0);try{if(await i(t.uuid,{amount:_}))u(s("payments.refund_success"),"success"),a(),l("");else throw new Error}catch{u(s("payments.refund_error"),"error")}finally{d(!1)}};return e.jsx(e.Fragment,{children:e.jsx(x,{sx:{flex:{xs:"1 1 calc(33% - 32px)",md:"1 1 100%"},minWidth:{xs:280,md:"auto"},maxWidth:{xs:320,md:"100%"}},children:e.jsxs(V,{sx:{display:"flex",flexDirection:{xs:"column",md:"row"},alignItems:{xs:"stretch",md:"center"},p:2,gap:1},children:[e.jsx(U,{title:o,children:e.jsx(x,{onClick:b,sx:{cursor:m?"pointer":"default",width:{xs:"100%",md:120},minWidth:120,height:80,minHeight:80,display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"background.default",borderRadius:1,position:"relative","&:hover":m?{bgcolor:"action.hover"}:{}},children:j&&m?e.jsx(E,{size:24}):e.jsx(J,{fontSize:"large",color:m?"action":"disabled"})})}),e.jsxs(K,{sx:{flexGrow:1},children:[e.jsxs(c,{variant:"h6",children:[s("payments.reference"),": ",t.uuid]}),e.jsx(T,{label:y,color:h,size:"small"}),e.jsx(c,{variant:"body2",sx:{mt:.5},children:t.payment_method==="free"||t.status==="pending"||t.status==="failed"?s("payments.created_at",{date:C(t.created_at,r),time:k(t.created_at,r)}):t.status==="refunded"?s("payments.refunded_at",{date:C(t.refunded_at,r),time:k(t.refunded_at,r),amount:I(t.refunded_amount,r)}):s("payments.paid_at",{date:C(t.paid_at,r),time:k(t.paid_at,r)})}),e.jsx(c,{variant:"h5",sx:{mt:2},children:s("payments.payment_info")}),e.jsx(c,{variant:"body1",color:"text.secondary",children:s("payments.amount",{amount:I(t.amount,r)})}),e.jsx(c,{variant:"body1",color:"text.secondary",children:s("payments.method",{method:s(`payments.methods.${t.payment_method}`)})}),t.transaction_id&&e.jsx(c,{variant:"body1",color:"text.secondary",children:s("payments.transaction_id",{id:t.transaction_id})}),e.jsx(c,{variant:"h5",sx:{mt:2},children:s("payments.client_info")}),e.jsx(c,{variant:"body1",color:"text.secondary",children:s("payments.client",{id:t.user.id,email:t.user.email})}),e.jsx(c,{variant:"h5",sx:{mt:2},children:s("payments.cart_details")}),e.jsx(x,{sx:{mb:3},children:t.cart_snapshot.map((_,A)=>e.jsxs(c,{variant:"body2",color:"text.secondary",children:["ID ",_.product_id," - ",_.product_name," - ",s("payments.places",{count:_.ticket_places}),e.jsx("br",{}),s("payments.quantity",{quantity:_.quantity}),e.jsx("br",{})]},A))}),t.payment_method!=="free"&&t.status==="paid"&&e.jsxs(e.Fragment,{children:[e.jsx(Q,{}),e.jsxs(X,{sx:{mt:2,display:"flex",flexDirection:"column",alignItems:"flex-start"},children:[e.jsx(c,{variant:"h5",children:s("payments.refund_label")}),e.jsx(c,{variant:"body2",color:"text.secondary",sx:{mb:2},children:s("payments.refund_info")}),e.jsx(Y,{label:s("payments.refund_amount"),value:p,onChange:_=>l(_.target.value),size:"small",type:"number",fullWidth:!0,slotProps:{inputLabel:{shrink:!0},input:{endAdornment:e.jsx(T,{label:"â‚¬",size:"small"}),inputProps:{min:0,step:.01}}},sx:{mb:1}}),e.jsx(D,{variant:"contained",size:"small",disabled:n||!p||parseFloat(p)<=0||isNaN(parseFloat(p))||parseFloat(p)>t.amount,onClick:$,sx:{width:"fit-content",alignSelf:"flex-end"},startIcon:n?e.jsx(E,{size:16}):void 0,children:s(n?"payments.refunding":"payments.confirm_refund")})]})]})]})]})})})}function le({payments:t,onSave:i,onRefresh:a}){const{t:s}=v("payments");return t.length===0?e.jsx(c,{variant:"h4",sx:{textAlign:"center"},children:s("errors.no_payments")}):e.jsx(x,{sx:{display:"flex",gap:4,justifyContent:{xs:"center",md:"flex-start"},flexWrap:{xs:"wrap",md:"nowrap"},flexDirection:{xs:"row",md:"column"}},children:t.map(r=>e.jsx(ie,{payment:r,onSave:i,onRefresh:a},r.uuid))})}function Pe(){const{t}=v("payments"),i=R(n=>n.authToken),a=ne(),[s,r]=g.useState({q:"",status:"",payment_method:"",per_page:5,page:1}),{payments:f,total:j,loading:u,error:p,validationErrors:l}=ae(s,i);return g.useEffect(()=>{if(l){const n={};l.q&&(n.q=""),l.status&&(n.status=""),l.payment_method&&(n.payment_method=""),l.per_page&&(n.per_page=5),l.page&&(n.page=1),r(d=>({...d,...n}))}},[l]),p?e.jsx(P,{children:e.jsx(M,{title:t("errors.title"),message:t("errors.message"),showRetry:!0,retryButtonText:t("errors.retry"),onRetry:()=>r(n=>({...n})),showHome:!0,homeButtonText:t("errors.go_home")})}):e.jsxs(e.Fragment,{children:[e.jsx(B,{title:t("seo.title"),description:t("seo.description")}),e.jsxs(P,{disableCard:!0,children:[e.jsx(c,{variant:"h4",sx:{px:2},children:t("payments.title")}),e.jsxs(x,{sx:{display:"flex",flexDirection:{xs:"column",md:"row"},gap:2,p:2},children:[e.jsx(re,{filters:s,onChange:n=>r(d=>({...d,...n}))}),e.jsxs(x,{component:"main",flex:1,children:[u?e.jsx(x,{textAlign:"center",py:8,children:e.jsx(O,{})}):e.jsx(le,{payments:f,onSave:async(n,d)=>await a(n,{amount:d.amount}),onRefresh:()=>r(n=>({...n}))}),!u&&f.length>0&&e.jsx(x,{textAlign:"center",mt:4,children:e.jsx(Z,{count:Math.ceil(j/s.per_page)||1,page:s.page,onChange:(n,d)=>r(y=>({...y,page:d}))})})]})]})]})]})}export{Pe as default};
