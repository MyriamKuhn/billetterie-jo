import{r as t,j as e}from"./react-C0aVURRx.js";import{a as z}from"./axios-Dq7h7Pqt.js";import{aC as Q,aD as G,q as A,v as f,aE as H,aF as J,O as se,a1 as F,B as E,r as W,ah as oe,I as ie,ai as le,aj as de,n as ce,ap as ne,ak as ue,X as he,_ as pe,Y as fe,$ as me}from"./mui-CUyLNCSY.js";import{A as R,b as X,a as xe}from"./index-CY5QxFiC.js";import{A as N,g as w}from"./AlertMessage-BDwJJZE0.js";import{u as Y}from"./i18n-react-DKLIrUu3.js";import{O as K}from"./vendor-DdBxgcTm.js";import{a as ee,i as be}from"./validation-491qobvS.js";import{P as ge}from"./PasswordWithConfirmation-fPFCWCsA.js";import{Q as je}from"./qrcode-react-qZ9kZ3qF.js";async function $e(a,n){const s={"Content-Type":"application/json",Authorization:`Bearer ${a}`},r=await z.get(`${R}/api/users/me`,{headers:s,signal:n==null?void 0:n.signal});return{status:r.status,data:r.data}}async function ye(a,n){const s={"Content-Type":"application/json",Authorization:`Bearer ${a}`},r=await z.patch(`${R}/api/users/me`,n,{headers:s});return{status:r.status,data:r.data}}async function Ce(a,n,s){const r={"Content-Type":"application/json",Authorization:`Bearer ${a}`,"Accept-Language":s},_=await z.patch(`${R}/api/auth/email`,{email:n},{headers:r});return{status:_.status,data:_.data}}async function we(a,n,s,r){const _={"Content-Type":"application/json",Authorization:`Bearer ${a}`},v=await z.patch(`${R}/api/auth/password`,{current_password:n,password:s,password_confirmation:r},{headers:_});return{status:v.status,data:v.data}}async function ve(a){const n={"Content-Type":"application/json",Authorization:`Bearer ${a}`},s=await z.post(`${R}/api/auth/2fa/enable`,{},{headers:n});return{status:s.status,data:s.data}}async function Se(a,n){const s={"Content-Type":"application/json",Authorization:`Bearer ${a}`},r=await z.post(`${R}/api/auth/2fa/confirm`,{otp:n},{headers:s});return{status:r.status,data:r.data}}async function Te(a,n){const s={"Content-Type":"application/json",Authorization:`Bearer ${a}`};return{status:(await z.post(`${R}/api/auth/2fa/disable`,{twofa_code:n},{headers:s})).status}}function qe({user:a,onUpdate:n}){const{t:s}=Y("userDashboard"),r=X(T=>T.authToken),_=K(),[v,I]=t.useState(!1),[S,o]=t.useState(a.firstname),[h,M]=t.useState(a.lastname),[y,C]=t.useState(!1),[D,k]=t.useState(!1),[i,l]=t.useState(!1),[m,x]=t.useState(null),[$,u]=t.useState(null),b=y&&S.trim()==="",c=D&&h.trim()==="",p=S.trim()!=="",q=h.trim()!=="";t.useEffect(()=>{o(a.firstname),M(a.lastname),C(!1),k(!1),x(null)},[a.firstname,a.lastname]);const j=()=>{v&&(x(null),u(null),C(!1),k(!1),o(a.firstname),M(a.lastname)),I(T=>!T)},U=async T=>{if(T.preventDefault(),x(null),u(null),!p||!q){x(s("errors.nameRequired"));return}if(!r){_("/login",{replace:!0});return}l(!0);try{const{status:d}=await ye(r,{firstname:S,lastname:h});d===204||d===200?(n({firstname:S,lastname:h}),u(s("dashboard.successMessageProfileUpdate"))):x(s("errors.nameUpdate"))}catch(d){if(z.isAxiosError(d)&&d.response){const{data:P}=d.response;P.code?x(w(s,P.code)):x(w(s,"generic_error"))}else x(w(s,"network_error"))}finally{l(!1)}};return e.jsxs(Q,{expanded:v,onChange:j,children:[e.jsx(G,{expandIcon:e.jsx(H,{}),children:e.jsxs(A,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",width:"100%",gap:{xs:1,sm:0}},children:[e.jsx(f,{sx:{fontSize:{xs:"0.85rem",sm:"1.2rem"}},children:s("dashboard.name")}),e.jsxs(f,{variant:"body2",color:"text.secondary",sx:{fontSize:{xs:"0.8rem",sm:"1rem"}},children:[a.firstname," ",a.lastname]})]})}),e.jsx(J,{children:e.jsxs(se,{component:"form",onSubmit:U,spacing:2,sx:{width:"100%"},children:[m&&e.jsx(N,{message:m,severity:"error"}),$&&e.jsx(N,{message:$,severity:"success"}),e.jsx(F,{required:!0,fullWidth:!0,id:"lastname",label:s("dashboard.lastname"),value:h,onChange:T=>M(T.target.value),onBlur:()=>k(!0),autoComplete:"family-name",error:c,helperText:c?s("errors.lastnameRequired"):""}),e.jsx(F,{required:!0,fullWidth:!0,id:"firstname",label:s("dashboard.firstname"),value:S,onChange:T=>o(T.target.value),onBlur:()=>C(!0),autoComplete:"given-name",error:b,helperText:b?s("errors.firstnameRequired"):""}),e.jsxs(A,{sx:{display:"flex",justifyContent:"flex-end",gap:1},children:[e.jsx(E,{onClick:()=>{o(a.firstname),M(a.lastname),C(!1),k(!1),x(null),u(null)},disabled:i,children:s("dashboard.cancel")}),e.jsx(E,{type:"submit",variant:"contained",disabled:i||!p||!q,startIcon:i?e.jsx(W,{color:"inherit",size:16}):void 0,children:i?`${s("dashboard.saveLoad")}…`:s("dashboard.save")})]})]})})]})}function Le({currentEmail:a,onUpdate:n}){const{t:s}=Y("userDashboard"),r=X(b=>b.authToken),_=K(),v=xe(b=>b.lang),[I,S]=t.useState(!1),[o,h]=t.useState(a),[M,y]=t.useState(!1),[C,D]=t.useState(!1),[k,i]=t.useState(null),[l,m]=t.useState(null),x=M&&!ee(o);t.useEffect(()=>{h(a),y(!1),i(null)},[a]);const $=()=>{I&&(i(null),m(null),y(!1),h(a)),S(b=>!b)},u=async b=>{if(b.preventDefault(),i(null),m(null),!ee(o)){i(s("errors.emailRequired"));return}if(o===a){i(s("errors.emailUnchanged"));return}if(!r){_("/login",{replace:!0});return}D(!0);try{const{status:c}=await Ce(r,o,v);c===204||c===200?(n(o),m(s("dashboard.successMessageEmailUpdate"))):i(s("errors.emailUpdate"))}catch(c){if(z.isAxiosError(c)&&c.response){const{data:p}=c.response;p.code?i(w(s,p.code)):i(w(s,"generic_error"))}else i(w(s,"network_error"))}finally{D(!1)}};return e.jsxs(Q,{expanded:I,onChange:$,children:[e.jsx(G,{expandIcon:e.jsx(H,{}),children:e.jsxs(A,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",width:"100%",gap:{xs:1,sm:0}},children:[e.jsx(f,{sx:{fontSize:{xs:"0.85rem",sm:"1.2rem"}},children:s("dashboard.email")}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{fontSize:{xs:"0.8rem",sm:"1rem"}},children:a})]})}),e.jsx(J,{children:e.jsxs(se,{component:"form",onSubmit:u,spacing:2,sx:{width:"100%"},children:[k&&e.jsx(N,{message:k,severity:"error"}),l&&e.jsx(N,{message:l,severity:"success"}),e.jsx(F,{required:!0,fullWidth:!0,id:"email",label:s("dashboard.email"),type:"email",value:o,onChange:b=>h(b.target.value),onBlur:()=>y(!0),autoComplete:"email",error:x,helperText:x?s("errors.emailInvalid"):""}),e.jsxs(A,{sx:{display:"flex",justifyContent:"flex-end",gap:1},children:[e.jsx(E,{onClick:()=>{h(a),y(!1),i(null),m(null)},disabled:C,children:s("dashboard.cancel")}),e.jsx(E,{type:"submit",variant:"contained",disabled:C||!ee(o),startIcon:C?e.jsx(W,{color:"inherit",size:16}):void 0,children:C?`${s("dashboard.saveLoad")}…`:s("dashboard.save")})]})]})})]})}function Re(){const{t:a}=Y("userDashboard"),n=X(d=>d.authToken),s=K(),[r,_]=t.useState(!1),[v,I]=t.useState(""),[S,o]=t.useState(""),[h,M]=t.useState(""),[y,C]=t.useState(!1),[D,k]=t.useState(!1),[i,l]=t.useState(!1),[m,x]=t.useState(!1),[$,u]=t.useState(null),[b,c]=t.useState(null),p=y&&!v.trim(),q=be(S),j=S===h,U=()=>{r&&(u(null),c(null),C(!1),k(!1)),_(d=>!d)},T=async d=>{if(d.preventDefault(),u(null),c(null),p){u(a("errors.currentPasswordRequired"));return}if(!q){u(a("errors.passwordNotStrong"));return}if(!j){u(a("errors.passwordsDontMatch"));return}if(!n){s("/login",{replace:!0});return}x(!0);try{const{status:P}=await we(n,v,S,h);P===200?c(a("dashboard.successMessagePasswordUpdate")):u(a("errors.passwordUpdate"))}catch(P){if(z.isAxiosError(P)&&P.response){const{data:V}=P.response;V.code?u(w(a,V.code)):u(w(a,"generic_error"))}else u(w(a,"network_error"))}finally{x(!1)}};return e.jsxs(Q,{expanded:r,onChange:U,children:[e.jsx(G,{expandIcon:e.jsx(H,{}),children:e.jsx(A,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",width:"100%",gap:{xs:1,sm:0}},children:e.jsx(f,{sx:{fontSize:{xs:"0.85rem",sm:"1.2rem"}},children:a("dashboard.password")})})}),e.jsx(J,{children:e.jsxs(se,{component:"form",onSubmit:T,spacing:2,sx:{width:"100%"},children:[$&&e.jsx(N,{message:$,severity:"error"}),b&&e.jsx(N,{message:b,severity:"success"}),e.jsx(F,{required:!0,fullWidth:!0,id:"password",label:a("dashboard.currentPassword"),type:i?"text":"password",value:v,onChange:d=>I(d.target.value),onBlur:()=>C(!0),autoComplete:"password",error:p,helperText:p?a("errors.passwordInvalid"):"",slotProps:{input:{endAdornment:e.jsx(oe,{position:"end",children:e.jsx(ie,{"aria-label":a(i?"dashboard.hidePassword":"dashboard.showPassword"),onClick:()=>l(!i),edge:"end",children:i?e.jsx(le,{}):e.jsx(de,{})})})}}}),e.jsx(ge,{password:S,onPasswordChange:o,confirmPassword:h,onConfirmChange:M,touched:D,onBlur:()=>k(!0)}),e.jsxs(A,{sx:{display:"flex",justifyContent:"flex-end",gap:1},children:[e.jsx(E,{onClick:()=>{I(""),o(""),M(""),C(!1),k(!1),u(null),c(null)},disabled:m,children:a("dashboard.cancel")}),e.jsx(E,{type:"submit",variant:"contained",disabled:m||!q||!j||p,startIcon:m?e.jsx(W,{color:"inherit",size:16}):void 0,children:m?`${a("dashboard.saveLoad")}…`:a("dashboard.save")})]})]})})]})}function Ue({enabled:a,onToggle:n}){const{t:s}=Y("userDashboard"),r=X(g=>g.authToken),_=K(),v=ce(g=>g.breakpoints.down("sm")),[I,S]=t.useState(!1),[o,h]=t.useState(!1),[M,y]=t.useState(null),[C,D]=t.useState(null),[k,i]=t.useState(!1),[l,m]=t.useState("enable_prepare"),[x,$]=t.useState(null),[u,b]=t.useState(null),[c,p]=t.useState(""),[q,j]=t.useState(null),[U,T]=t.useState(null),[d,P]=t.useState("otp"),V=()=>{I&&(y(null),D(null)),S(g=>!g)},ae=async()=>{var g,O;if(y(null),D(null),j(null),T(null),!r){_("/login",{replace:!0});return}if(a)m("disable"),P("otp"),p(""),j(null),i(!0);else{h(!0);try{const B=await ve(r);B.status===200&&B.data.qrCodeUrl?($(B.data.qrCodeUrl),b(B.data.secret||null),m("enable_prepare"),i(!0)):y(w(s,"generic_error"))}catch(B){z.isAxiosError(B)&&((O=(g=B.response)==null?void 0:g.data)!=null&&O.code)?y(w(s,B.response.data.code)):y(w(s,"network_error"))}finally{h(!1)}}},te=async()=>{var g,O,B;if(j(null),!r){_("/login",{replace:!0});return}if(l==="enable_confirm"){if(!c){j(s("errors.otpRequired"));return}}else if(l==="disable"&&!c){j(s(d==="otp"?"errors.otpRequired":"errors.recoveryCodeRequired"));return}h(!0);try{switch(l){case"enable_prepare":m("enable_confirm"),p("");break;case"enable_confirm":{const L=await Se(r,c);L.status===200&&((g=L.data)!=null&&g.recovery_codes)?(n(!0),D(s("dashboard.2faEnabled")),T(L.data.recovery_codes),j(null),m("enable_success")):y(w(s,"generic_error"))}break;case"disable":(await Te(r,c)).status===204?(n(!1),D(s("dashboard.2faDisabled")),i(!1),p(""),S(!1)):y(w(s,"generic_error"));break}}catch(L){if(z.isAxiosError(L)&&((B=(O=L.response)==null?void 0:O.data)!=null&&B.code)){const re=L.response.data.code;j(l==="disable"&&re==="twofa_invalid_code"?s(d==="otp"?"errors.invalidOtp":"errors.invalidRecoveryCode"):w(s,re))}else j(w(s,"network_error"))}finally{h(!1)}},Z=()=>{i(!1),p(""),j(null),$(null),b(null),T(null),(l==="enable_prepare"||l==="enable_confirm")&&n(!1),m("enable_prepare")};return e.jsxs(e.Fragment,{children:[e.jsxs(Q,{expanded:I,onChange:V,children:[e.jsx(G,{expandIcon:e.jsx(H,{}),children:e.jsxs(A,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",width:"100%",gap:{xs:1,sm:0}},children:[e.jsx(f,{sx:{fontSize:{xs:"0.85rem",sm:"1.2rem"}},children:s("dashboard.twoFA")}),v?e.jsx(ne,{size:"small",checked:a,onChange:ae,disabled:o}):e.jsx(ue,{control:e.jsx(ne,{size:"small",checked:a,onChange:ae,disabled:o}),label:s(a?"dashboard.enabled":"dashboard.disabled")})]})}),e.jsxs(J,{children:[M&&e.jsx(f,{color:"error",children:M}),C&&e.jsx(f,{color:"success.main",children:C}),e.jsx(f,{variant:"body2",children:s(a?"dashboard.2faEnabled":"dashboard.2faDisabled")})]})]}),e.jsxs(he,{open:k,onClose:Z,children:[e.jsxs(pe,{children:[l==="disable"&&s("dashboard.disable2faTitle"),l==="enable_prepare"&&s("dashboard.enable2faTitle"),l==="enable_confirm"&&s("dashboard.confirm2faTitle")]}),e.jsxs(fe,{children:[l==="enable_prepare"&&x&&e.jsxs(A,{sx:{textAlign:"center",mb:2},children:[e.jsx(f,{variant:"body2",gutterBottom:!0,children:s("dashboard.scanQRCodeWithoutConfirm")}),e.jsx(A,{sx:{mx:"auto",width:200,height:200,backgroundColor:"#fff",p:1},children:e.jsx(je,{value:x,size:180})}),u&&e.jsxs(A,{sx:{display:"flex",alignItems:"center",justifyContent:"center",mt:1},children:[e.jsxs(f,{variant:"caption",sx:{fontFamily:"monospace",mr:1},children:[s("dashboard.secret"),": ",u]}),e.jsx(E,{size:"small",onClick:()=>{navigator.clipboard.writeText(u)},children:s("dashboard.copy")})]}),e.jsx(f,{variant:"body2",sx:{mt:2},children:s("dashboard.enterOtpAfterScan")})]}),l==="enable_confirm"&&e.jsxs(A,{children:[e.jsx(f,{variant:"body2",gutterBottom:!0,children:s("dashboard.enterCodeToConfirm")}),e.jsx(F,{label:s(v?"dashboard.otpCodeMobile":"dashboard.otpCode"),value:c,onChange:g=>p(g.target.value.trim()),fullWidth:!0,type:"text",margin:"normal",slotProps:{input:{inputProps:{maxLength:6}}},placeholder:"123456"}),q&&e.jsx(f,{color:"error",sx:{mt:1},children:q})]}),l==="enable_success"&&U&&e.jsxs(A,{children:[e.jsx(f,{variant:"subtitle2",gutterBottom:!0,children:s("dashboard.recoveryCodesTitle")}),U.map(g=>e.jsx(f,{variant:"body2",sx:{fontFamily:"monospace"},children:g},g)),e.jsx(f,{variant:"caption",sx:{display:"block",mt:1},children:s("dashboard.recoveryCodesNote")})]}),l==="disable"&&e.jsxs(A,{children:[e.jsx(f,{variant:"body2",gutterBottom:!0,children:s(d==="otp"?"dashboard.enterCodeToDisable":"dashboard.enterRecoveryCodeToDisable")}),e.jsxs(A,{sx:{display:"flex",gap:1,mb:1},children:[e.jsx(E,{variant:d==="otp"?"contained":"outlined",onClick:()=>{P("otp"),p(""),j(null)},disabled:o,size:"small",sx:{fontSize:{xs:"0.6rem",sm:"0.875rem"}},children:s("dashboard.useOtp")}),e.jsx(E,{variant:d==="recovery"?"contained":"outlined",onClick:()=>{P("recovery"),p(""),j(null)},disabled:o,size:"small",sx:{fontSize:{xs:"0.6rem",sm:"0.875rem"}},children:s("dashboard.useRecoveryCode")})]}),e.jsx(F,{label:s(v?d==="otp"?"dashboard.otpCodeMobile":"dashboard.recoveryCodeMobile":d==="otp"?"dashboard.otpCode":"dashboard.recoveryCode"),value:c,onChange:g=>p(g.target.value.trim()),fullWidth:!0,type:"text",margin:"normal",slotProps:{input:{inputProps:{maxLength:d==="otp"?6:20}}},placeholder:d==="otp"?"123456":"ABCDEFGHIJ"}),q&&e.jsx(f,{color:"error",sx:{mt:1},children:q})]})]}),e.jsxs(me,{children:[e.jsx(E,{onClick:Z,disabled:o,children:s("dashboard.cancel")}),l==="enable_prepare"&&e.jsx(E,{variant:"contained",onClick:te,disabled:o,startIcon:o?e.jsx(W,{size:16}):null,children:s("dashboard.next")}),(l==="enable_confirm"||l==="disable")&&e.jsx(E,{variant:"contained",onClick:te,disabled:o||!c,startIcon:o?e.jsx(W,{size:16}):null,children:s("dashboard.confirm")}),l==="enable_success"&&e.jsx(E,{variant:"contained",onClick:Z,children:s("dashboard.done")})]})]})]})}export{Le as E,qe as N,Re as P,Ue as T,$e as f};
