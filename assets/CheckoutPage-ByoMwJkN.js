import{r as a,j as t}from"./react-C0aVURRx.js";import{a5 as ee,a6 as te,O as re,a7 as se,a8 as ae,a9 as Q}from"./vendor-CknGL9X_.js";import{g as k,A as O}from"./AlertMessage-DyibR1wZ.js";import{a as J,S as oe,P as ne,u as b,b as ie,O as ce}from"./index-0o0hW-SE.js";import{l as X,c as le,g as ue,a as H}from"./paymentService-Bq5KHVfK.js";import{a as R}from"./axios-xsH4HHeE.js";import{u as U}from"./i18n-react-2P1mIwau.js";import{q as j,B as _,t as T,x as de,C as me}from"./mui-CaMhj-nn.js";import"./dayjs-DMyafwSS.js";import"./zustand-DgaMZn_z.js";import"./i18n-Bhc83OLH.js";import"./emotion-VhTkku_q.js";import"./helmet-BJ5MjdLa.js";import"./cookie-consent-BKvNUUg0.js";const pe=te("pk_test_51RMYGcPreyLhSIPrfNaAPo6bxnSIvMXPGqMosWfGo6WZyfPjmJSYEMTfYu22AjQHfyM1Se6XLgbsjnYFCmVeajeT00KCOOsNQb");function Ae(){const{t:m}=U("checkout"),p=J(u=>u.lang),[i,f]=a.useState(null),[S,E]=a.useState(null),r=`stripe-elements-${p}-${i?"ready":"no-secret"}`,n={locale:p,...i?{clientSecret:i}:{}};return t.jsxs(t.Fragment,{children:[t.jsx(oe,{title:m("seo.title"),description:m("seo.description")}),t.jsx(ne,{disableCard:!0,children:t.jsx(ee,{stripe:pe,options:n,children:t.jsx(fe,{setClientSecret:f,setPaymentUuid:E,clientSecret:i,paymentUuid:S})},r)})]})}function fe({setClientSecret:m,setPaymentUuid:p,clientSecret:i,paymentUuid:f}){const S=a.useRef(!1),E=2e3,{t:r}=U("checkout"),n=re(),u=se(),P=ae(),[V,C]=a.useState(!0),[W,x]=a.useState(null),[v,h]=a.useState(!1),[w,c]=a.useState(null),[Y,g]=a.useState(!1),[z,A]=a.useState(null),B=b(e=>e.clearCart),G=b(e=>e.lockCart),o=b(e=>e.unlockCart),d=b(e=>e.cartId),l=ie(e=>e.authToken),N=J(e=>e.lang),q=b(e=>e.loadCart);a.useEffect(()=>{l&&!d&&q().catch(e=>X())},[l,d,q]),a.useEffect(()=>{if(!l){x(r("errors.not_authenticated")),C(!1),n("/login?next=/checkout");return}if(!d){C(!0);return}S.current||(S.current=!0,(async()=>{C(!0),x(null);try{const{data:e}=await le(d,l,N);if(e!=null&&e.client_secret)p(e.uuid),m(e.client_secret);else throw new Error("Unexpected response from server")}catch(e){if(R.isAxiosError(e)&&e.response){const{data:y}=e.response;y.code?x(k(r,y.code)):x(k(r,"generic_error"))}else x(k(r,"network_error"))}finally{C(!1)}})())},[l,d,N,n,r,m,p]);const Z=a.useCallback(async e=>{var $,D,F;e.preventDefault(),c(null),G(),h(!0),A(null),g(!0);const y=P.getElement(Q);if(!y){c(r("errors.no_card_element")),h(!1),g(!1),o();return}try{const{error:I}=await u.confirmCardPayment(i,{payment_method:{card:y}});if(I){X("Stripe confirm error:",I),c(r("errors.card_error")),h(!1),g(!1),o();return}A(r("checkout.waiting_confirmation"));let M=null;for(;;){await new Promise(s=>setTimeout(s,E));try{const{status:s,data:K}=await ue(f,l);if(s!==200||!K)throw new Error(`Unexpected polling response: ${s}`);const L=K.status.toLowerCase();if(L==="succeeded"||L==="paid"){M="paid";break}if(["requires_payment_method","failed","canceled"].includes(L)){M="failed";break}}catch(s){if(H("Polling payment status error:",s),R.isAxiosError(s)&&(($=s.response)==null?void 0:$.status)===401){c(r("errors.not_authenticated")),o(),n("/login");return}R.isAxiosError(s)&&((F=(D=s.response)==null?void 0:D.data)!=null&&F.code)?c(k(r,s.response.data.code)):c(k(r,"network_error")),o();break}}if(M==="paid"){A(r("checkout.payment_success")),o();try{await B()}catch(s){H("clearCart error after payment:",s)}n("/confirmation",{state:{paymentUuid:f}});return}else{c(r("errors.payment_failed")),h(!1),g(!1),o();return}}catch{h(!1),g(!1),o()}},[u,P,i,f,B,n,r,l,G,o]);return a.useEffect(()=>()=>{o()},[o]),W?t.jsxs(j,{sx:{p:4},children:[t.jsx(O,{message:W,severity:"error"}),t.jsxs(j,{sx:{mt:2},children:[t.jsx(_,{variant:"contained",onClick:()=>window.location.reload(),children:r("checkout.retry")}),t.jsx(_,{sx:{ml:2},variant:"outlined",onClick:()=>n("/cart"),children:r("checkout.back_to_cart")})]})]}):!d||V||!u||!P?t.jsxs(j,{sx:{textAlign:"center",py:4},children:[t.jsx(ce,{}),t.jsx(T,{sx:{mt:2},children:r("checkout.initializing")})]}):t.jsxs(de,{component:"form",onSubmit:Z,sx:{maxWidth:500,mx:"auto",mt:4,p:2,border:"1px solid",borderColor:"divider",borderRadius:1},children:[t.jsx(T,{variant:"h5",gutterBottom:!0,children:r("checkout.title")}),w&&t.jsx(O,{message:w,severity:"error"}),Y&&z&&t.jsx(O,{message:z,severity:"info"}),t.jsx(T,{variant:"body2",sx:{mb:1},children:r("checkout.card_number_label")}),t.jsx(j,{sx:{mb:2,border:"1px solid",borderColor:w?"error.main":"divider",borderRadius:1,p:1,backgroundColor:"background.paper",transition:"border-color 0.2s"},children:t.jsx(Q,{options:{style:{base:{fontSize:"16px",color:"#424770","::placeholder":{color:"#aab7c4"}},invalid:{color:"#9e2146"}}}})}),t.jsxs(j,{sx:{textAlign:"right",mt:3},children:[t.jsx(_,{type:"submit",variant:"contained",disabled:!u||v||Y,startIcon:v?t.jsx(me,{color:"inherit",size:16}):void 0,children:r(v?"checkout.processing":"checkout.pay_button")}),t.jsx(_,{variant:"text",onClick:()=>{o(),n("/cart")},children:r("checkout.cancel_payment")})]})]})}export{Ae as default};
