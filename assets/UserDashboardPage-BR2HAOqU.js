import{r as t,j as e}from"./react-C0aVURRx.js";import{A as R,b as V,a as le,S as ne,O as de,P as oe}from"./index-0o0hW-SE.js";import{a as B}from"./axios-xsH4HHeE.js";import{A as q,g as S}from"./AlertMessage-DyibR1wZ.js";import{E as ce}from"./ErrorDisplay-C2nHG3XV.js";import{al as H,am as J,q as A,t as f,an as K,ao as X,N as Y,O,B as z,C as N,ai as ue,I as he,aj as pe,ak as me,n as fe,ap as ie,W as xe,a2 as be,a4 as ge,a3 as je,a5 as ye}from"./mui-CaMhj-nn.js";import{u as Q}from"./i18n-react-2P1mIwau.js";import{O as Z,a4 as we,U as Ce}from"./vendor-CknGL9X_.js";import{a as se,i as ve}from"./validation-491qobvS.js";import{P as Se}from"./PasswordWithConfirmation-ZWkDUF89.js";import"./dayjs-DMyafwSS.js";import"./zustand-DgaMZn_z.js";import"./i18n-Bhc83OLH.js";import"./emotion-VhTkku_q.js";import"./helmet-BJ5MjdLa.js";import"./cookie-consent-BKvNUUg0.js";async function Te(a,o){const s={"Content-Type":"application/json",Authorization:`Bearer ${a}`},n=await B.get(`${R}/api/users/me`,{headers:s,signal:o==null?void 0:o.signal});return{status:n.status,data:n.data}}async function Ae(a,o){const s={"Content-Type":"application/json",Authorization:`Bearer ${a}`},n=await B.patch(`${R}/api/users/me`,o,{headers:s});return{status:n.status,data:n.data}}async function Ee(a,o,s){const n={"Content-Type":"application/json",Authorization:`Bearer ${a}`,"Accept-Language":s},E=await B.patch(`${R}/api/auth/email`,{email:o},{headers:n});return{status:E.status,data:E.data}}async function ke(a,o,s,n){const E={"Content-Type":"application/json",Authorization:`Bearer ${a}`},b=await B.patch(`${R}/api/auth/password`,{current_password:o,password:s,password_confirmation:n},{headers:E});return{status:b.status,data:b.data}}async function _e(a){const o={"Content-Type":"application/json",Authorization:`Bearer ${a}`},s=await B.post(`${R}/api/auth/2fa/enable`,{},{headers:o});return{status:s.status,data:s.data}}async function Me(a,o){const s={"Content-Type":"application/json",Authorization:`Bearer ${a}`},n=await B.post(`${R}/api/auth/2fa/confirm`,{otp:o},{headers:s});return{status:n.status,data:n.data}}async function Pe(a,o){const s={"Content-Type":"application/json",Authorization:`Bearer ${a}`};return{status:(await B.post(`${R}/api/auth/2fa/disable`,{twofa_code:o},{headers:s})).status}}function ze({user:a,onUpdate:o}){const{t:s}=Q("userDashboard"),n=V(k=>k.authToken),E=Z(),[b,_]=t.useState(!1),[x,r]=t.useState(a.firstname),[i,M]=t.useState(a.lastname),[u,h]=t.useState(!1),[g,P]=t.useState(!1),[l,d]=t.useState(!1),[y,w]=t.useState(null),[I,m]=t.useState(null),C=u&&x.trim()==="",p=g&&i.trim()==="",j=x.trim()!=="",F=i.trim()!=="";t.useEffect(()=>{r(a.firstname),M(a.lastname),h(!1),P(!1),w(null)},[a.firstname,a.lastname]);const T=()=>{b&&(w(null),m(null),h(!1),P(!1),r(a.firstname),M(a.lastname)),_(k=>!k)},$=async k=>{if(k.preventDefault(),w(null),m(null),!j||!F){w(s("errors.nameRequired"));return}if(!n){E("/login",{replace:!0});return}d(!0);try{const{status:c}=await Ae(n,{firstname:x,lastname:i});c===204||c===200?(o({firstname:x,lastname:i}),m(s("dashboard.successMessageProfileUpdate"))):w(s("errors.nameUpdate"))}catch(c){if(B.isAxiosError(c)&&c.response){const{data:U}=c.response;U.code?w(S(s,U.code)):w(S(s,"generic_error"))}else w(S(s,"network_error"))}finally{d(!1)}};return e.jsxs(H,{expanded:b,onChange:T,children:[e.jsx(J,{expandIcon:e.jsx(K,{}),children:e.jsxs(A,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",width:"100%",gap:{xs:1,sm:0}},children:[e.jsx(f,{sx:{fontSize:{xs:"0.85rem",sm:"1.2rem"}},children:s("dashboard.name")}),e.jsxs(f,{variant:"body2",color:"text.secondary",sx:{fontSize:{xs:"0.8rem",sm:"1rem"}},children:[a.firstname," ",a.lastname]})]})}),e.jsx(X,{children:e.jsxs(Y,{component:"form",onSubmit:$,spacing:2,sx:{width:"100%"},children:[y&&e.jsx(q,{message:y,severity:"error"}),I&&e.jsx(q,{message:I,severity:"success"}),e.jsx(O,{required:!0,fullWidth:!0,id:"lastname",label:s("dashboard.lastname"),value:i,onChange:k=>M(k.target.value),onBlur:()=>P(!0),autoComplete:"family-name",error:p,helperText:p?s("errors.lastnameRequired"):""}),e.jsx(O,{required:!0,fullWidth:!0,id:"firstname",label:s("dashboard.firstname"),value:x,onChange:k=>r(k.target.value),onBlur:()=>h(!0),autoComplete:"given-name",error:C,helperText:C?s("errors.firstnameRequired"):""}),e.jsxs(A,{sx:{display:"flex",justifyContent:"flex-end",gap:1},children:[e.jsx(z,{onClick:()=>{r(a.firstname),M(a.lastname),h(!1),P(!1),w(null),m(null)},disabled:l,children:s("dashboard.cancel")}),e.jsx(z,{type:"submit",variant:"contained",disabled:l||!j||!F,startIcon:l?e.jsx(N,{color:"inherit",size:16}):void 0,children:l?`${s("dashboard.saveLoad")}…`:s("dashboard.save")})]})]})})]})}function Be({currentEmail:a,onUpdate:o}){const{t:s}=Q("userDashboard"),n=V(C=>C.authToken),E=Z(),b=le(C=>C.lang),[_,x]=t.useState(!1),[r,i]=t.useState(a),[M,u]=t.useState(!1),[h,g]=t.useState(!1),[P,l]=t.useState(null),[d,y]=t.useState(null),w=M&&!se(r);t.useEffect(()=>{i(a),u(!1),l(null)},[a]);const I=()=>{_&&(l(null),y(null),u(!1),i(a)),x(C=>!C)},m=async C=>{if(C.preventDefault(),l(null),y(null),!se(r)){l(s("errors.emailRequired"));return}if(r===a){l(s("errors.emailUnchanged"));return}if(!n){E("/login",{replace:!0});return}g(!0);try{const{status:p}=await Ee(n,r,b);p===204||p===200?(o(r),y(s("dashboard.successMessageEmailUpdate"))):l(s("errors.emailUpdate"))}catch(p){if(B.isAxiosError(p)&&p.response){const{data:j}=p.response;j.code?l(S(s,j.code)):l(S(s,"generic_error"))}else l(S(s,"network_error"))}finally{g(!1)}};return e.jsxs(H,{expanded:_,onChange:I,children:[e.jsx(J,{expandIcon:e.jsx(K,{}),children:e.jsxs(A,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",width:"100%",gap:{xs:1,sm:0}},children:[e.jsx(f,{sx:{fontSize:{xs:"0.85rem",sm:"1.2rem"}},children:s("dashboard.email")}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{fontSize:{xs:"0.8rem",sm:"1rem"}},children:a})]})}),e.jsx(X,{children:e.jsxs(Y,{component:"form",onSubmit:m,spacing:2,sx:{width:"100%"},children:[P&&e.jsx(q,{message:P,severity:"error"}),d&&e.jsx(q,{message:d,severity:"success"}),e.jsx(O,{required:!0,fullWidth:!0,id:"email",label:s("dashboard.email"),type:"email",value:r,onChange:C=>i(C.target.value),onBlur:()=>u(!0),autoComplete:"email",error:w,helperText:w?s("errors.emailInvalid"):""}),e.jsxs(A,{sx:{display:"flex",justifyContent:"flex-end",gap:1},children:[e.jsx(z,{onClick:()=>{i(a),u(!1),l(null),y(null)},disabled:h,children:s("dashboard.cancel")}),e.jsx(z,{type:"submit",variant:"contained",disabled:h||!se(r),startIcon:h?e.jsx(N,{color:"inherit",size:16}):void 0,children:h?`${s("dashboard.saveLoad")}…`:s("dashboard.save")})]})]})})]})}function Ue(){const{t:a}=Q("userDashboard"),o=V(c=>c.authToken),s=Z(),[n,E]=t.useState(!1),[b,_]=t.useState(""),[x,r]=t.useState(""),[i,M]=t.useState(""),[u,h]=t.useState(!1),[g,P]=t.useState(!1),[l,d]=t.useState(!1),[y,w]=t.useState(!1),[I,m]=t.useState(null),[C,p]=t.useState(null),j=u&&!b.trim(),F=ve(x),T=x===i,$=()=>{n&&(m(null),p(null),h(!1),P(!1)),E(c=>!c)},k=async c=>{if(c.preventDefault(),m(null),p(null),j){m(a("errors.currentPasswordRequired"));return}if(!F){m(a("errors.passwordNotStrong"));return}if(!T){m(a("errors.passwordsDontMatch"));return}if(!o){s("/login",{replace:!0});return}w(!0);try{const{status:U}=await ke(o,b,x,i);U===200?p(a("dashboard.successMessagePasswordUpdate")):m(a("errors.passwordUpdate"))}catch(U){if(B.isAxiosError(U)&&U.response){const{data:G}=U.response;G.code?m(S(a,G.code)):m(S(a,"generic_error"))}else m(S(a,"network_error"))}finally{w(!1)}};return e.jsxs(H,{expanded:n,onChange:$,children:[e.jsx(J,{expandIcon:e.jsx(K,{}),children:e.jsx(A,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",width:"100%",gap:{xs:1,sm:0}},children:e.jsx(f,{sx:{fontSize:{xs:"0.85rem",sm:"1.2rem"}},children:a("dashboard.password")})})}),e.jsx(X,{children:e.jsxs(Y,{component:"form",onSubmit:k,spacing:2,sx:{width:"100%"},children:[I&&e.jsx(q,{message:I,severity:"error"}),C&&e.jsx(q,{message:C,severity:"success"}),e.jsx(O,{required:!0,fullWidth:!0,id:"password",label:a("dashboard.currentPassword"),type:l?"text":"password",value:b,onChange:c=>_(c.target.value),onBlur:()=>h(!0),autoComplete:"password",error:j,helperText:j?a("errors.passwordInvalid"):"",slotProps:{input:{endAdornment:e.jsx(ue,{position:"end",children:e.jsx(he,{"aria-label":a(l?"dashboard.hidePassword":"dashboard.showPassword"),onClick:()=>d(!l),edge:"end",children:l?e.jsx(pe,{}):e.jsx(me,{})})})}}}),e.jsx(Se,{password:x,onPasswordChange:r,confirmPassword:i,onConfirmChange:M,touched:g,onBlur:()=>P(!0)}),e.jsxs(A,{sx:{display:"flex",justifyContent:"flex-end",gap:1},children:[e.jsx(z,{onClick:()=>{_(""),r(""),M(""),h(!1),P(!1),m(null),p(null)},disabled:y,children:a("dashboard.cancel")}),e.jsx(z,{type:"submit",variant:"contained",disabled:y||!F||!T||j,startIcon:y?e.jsx(N,{color:"inherit",size:16}):void 0,children:y?`${a("dashboard.saveLoad")}…`:a("dashboard.save")})]})]})})]})}function De({enabled:a,onToggle:o}){const{t:s}=Q("userDashboard"),n=V(v=>v.authToken),E=Z(),b=fe(v=>v.breakpoints.down("sm")),[_,x]=t.useState(!1),[r,i]=t.useState(!1),[M,u]=t.useState(null),[h,g]=t.useState(null),[P,l]=t.useState(!1),[d,y]=t.useState("enable_prepare"),[w,I]=t.useState(null),[m,C]=t.useState(null),[p,j]=t.useState(""),[F,T]=t.useState(null),[$,k]=t.useState(null),[c,U]=t.useState("otp"),G=()=>{_&&(u(null),g(null)),x(v=>!v)},ae=async()=>{var v,W;if(u(null),g(null),T(null),k(null),!n){E("/login",{replace:!0});return}if(a)y("disable"),U("otp"),j(""),T(null),l(!0);else{i(!0);try{const D=await _e(n);D.status===200&&D.data.qrCodeUrl?(I(D.data.qrCodeUrl),C(D.data.secret||null),y("enable_prepare"),l(!0)):u(S(s,"generic_error"))}catch(D){B.isAxiosError(D)&&((W=(v=D.response)==null?void 0:v.data)!=null&&W.code)?u(S(s,D.response.data.code)):u(S(s,"network_error"))}finally{i(!1)}}},te=async()=>{var v,W,D;if(T(null),!n){E("/login",{replace:!0});return}if(d==="enable_confirm"){if(!p){T(s("errors.otpRequired"));return}}else if(d==="disable"&&!p){T(s(c==="otp"?"errors.otpRequired":"errors.recoveryCodeRequired"));return}i(!0);try{switch(d){case"enable_prepare":y("enable_confirm"),j("");break;case"enable_confirm":{const L=await Me(n,p);L.status===200&&((v=L.data)!=null&&v.recovery_codes)?(o(!0),g(s("dashboard.2faEnabled")),k(L.data.recovery_codes),T(null),y("enable_success")):u(S(s,"generic_error"))}break;case"disable":(await Pe(n,p)).status===204?(o(!1),g(s("dashboard.2faDisabled")),l(!1),j(""),x(!1)):u(S(s,"generic_error"));break}}catch(L){if(B.isAxiosError(L)&&((D=(W=L.response)==null?void 0:W.data)!=null&&D.code)){const re=L.response.data.code;T(d==="disable"&&re==="twofa_invalid_code"?s(c==="otp"?"errors.invalidOtp":"errors.invalidRecoveryCode"):S(s,re))}else T(S(s,"network_error"))}finally{i(!1)}},ee=()=>{l(!1),j(""),T(null),I(null),C(null),k(null),(d==="enable_prepare"||d==="enable_confirm")&&o(!1),y("enable_prepare")};return e.jsxs(e.Fragment,{children:[e.jsxs(H,{expanded:_,onChange:G,children:[e.jsx(J,{expandIcon:e.jsx(K,{}),children:e.jsxs(A,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",width:"100%",gap:{xs:1,sm:0}},children:[e.jsx(f,{sx:{fontSize:{xs:"0.85rem",sm:"1.2rem"}},children:s("dashboard.twoFA")}),b?e.jsx(ie,{size:"small",checked:a,onChange:ae,disabled:r}):e.jsx(xe,{control:e.jsx(ie,{size:"small",checked:a,onChange:ae,disabled:r}),label:s(a?"dashboard.enabled":"dashboard.disabled")})]})}),e.jsxs(X,{children:[M&&e.jsx(f,{color:"error",children:M}),h&&e.jsx(f,{color:"success.main",children:h}),e.jsx(f,{variant:"body2",children:s(a?"dashboard.2faEnabled":"dashboard.2faDisabled")})]})]}),e.jsxs(be,{open:P,onClose:ee,children:[e.jsxs(ge,{children:[d==="disable"&&s("dashboard.disable2faTitle"),d==="enable_prepare"&&s("dashboard.enable2faTitle"),d==="enable_confirm"&&s("dashboard.confirm2faTitle")]}),e.jsxs(je,{children:[d==="enable_prepare"&&w&&e.jsxs(A,{sx:{textAlign:"center",mb:2},children:[e.jsx(f,{variant:"body2",gutterBottom:!0,children:s("dashboard.scanQRCodeWithoutConfirm")}),e.jsx(A,{sx:{mx:"auto",width:200,height:200,backgroundColor:"#fff",p:1},children:e.jsx(we,{value:w,size:180})}),m&&e.jsxs(A,{sx:{display:"flex",alignItems:"center",justifyContent:"center",mt:1},children:[e.jsxs(f,{variant:"caption",sx:{fontFamily:"monospace",mr:1},children:[s("dashboard.secret"),": ",m]}),e.jsx(z,{size:"small",onClick:()=>{navigator.clipboard.writeText(m)},children:s("dashboard.copy")})]}),e.jsx(f,{variant:"body2",sx:{mt:2},children:s("dashboard.enterOtpAfterScan")})]}),d==="enable_confirm"&&e.jsxs(A,{children:[e.jsx(f,{variant:"body2",gutterBottom:!0,children:s("dashboard.enterCodeToConfirm")}),e.jsx(O,{label:s(b?"dashboard.otpCodeMobile":"dashboard.otpCode"),value:p,onChange:v=>j(v.target.value.trim()),fullWidth:!0,type:"text",margin:"normal",slotProps:{input:{inputProps:{maxLength:6}}},placeholder:"123456"}),F&&e.jsx(f,{color:"error",sx:{mt:1},children:F})]}),d==="enable_success"&&$&&e.jsxs(A,{children:[e.jsx(f,{variant:"subtitle2",gutterBottom:!0,children:s("dashboard.recoveryCodesTitle")}),$.map(v=>e.jsx(f,{variant:"body2",sx:{fontFamily:"monospace"},children:v},v)),e.jsx(f,{variant:"caption",sx:{display:"block",mt:1},children:s("dashboard.recoveryCodesNote")})]}),d==="disable"&&e.jsxs(A,{children:[e.jsx(f,{variant:"body2",gutterBottom:!0,children:s(c==="otp"?"dashboard.enterCodeToDisable":"dashboard.enterRecoveryCodeToDisable")}),e.jsxs(A,{sx:{display:"flex",gap:1,mb:1},children:[e.jsx(z,{variant:c==="otp"?"contained":"outlined",onClick:()=>{U("otp"),j(""),T(null)},disabled:r,size:"small",sx:{fontSize:{xs:"0.6rem",sm:"0.875rem"}},children:s("dashboard.useOtp")}),e.jsx(z,{variant:c==="recovery"?"contained":"outlined",onClick:()=>{U("recovery"),j(""),T(null)},disabled:r,size:"small",sx:{fontSize:{xs:"0.6rem",sm:"0.875rem"}},children:s("dashboard.useRecoveryCode")})]}),e.jsx(O,{label:s(b?c==="otp"?"dashboard.otpCodeMobile":"dashboard.recoveryCodeMobile":c==="otp"?"dashboard.otpCode":"dashboard.recoveryCode"),value:p,onChange:v=>j(v.target.value.trim()),fullWidth:!0,type:"text",margin:"normal",slotProps:{input:{inputProps:{maxLength:c==="otp"?6:20}}},placeholder:c==="otp"?"123456":"ABCDEFGHIJ"}),F&&e.jsx(f,{color:"error",sx:{mt:1},children:F})]})]}),e.jsxs(ye,{children:[e.jsx(z,{onClick:ee,disabled:r,children:s("dashboard.cancel")}),d==="enable_prepare"&&e.jsx(z,{variant:"contained",onClick:te,disabled:r,startIcon:r?e.jsx(N,{size:16}):null,children:s("dashboard.next")}),(d==="enable_confirm"||d==="disable")&&e.jsx(z,{variant:"contained",onClick:te,disabled:r||!p,startIcon:r?e.jsx(N,{size:16}):null,children:s("dashboard.confirm")}),d==="enable_success"&&e.jsx(z,{variant:"contained",onClick:ee,children:s("dashboard.done")})]})]})]})}function Ye(){const{t:a}=Q("userDashboard"),o=V(r=>r.authToken),[s,n]=t.useState(null),[E,b]=t.useState(!0),[_,x]=t.useState(null);return t.useEffect(()=>{if(!o){n(null),b(!1);return}const r=new AbortController,i=r.signal;return(async()=>{b(!0),x(null);try{const u=await Te(o,{signal:i});if(i.aborted)return;const{status:h,data:g}=u;h===200&&g.user?n({firstname:g.user.firstname,lastname:g.user.lastname,email:g.user.email,twoFAEnabled:g.user.twofa_enabled}):x(a("errors.fetchProfile"))}catch(u){if(i.aborted)return;if(B.isAxiosError(u)&&u.response){const h=u.response.data,g=h==null?void 0:h.code;x(S(a,g??"generic_error"))}else x(S(a,"network_error"))}finally{i.aborted||b(!1)}})(),()=>{r.abort()}},[o,a]),E?e.jsxs(e.Fragment,{children:[e.jsx(ne,{title:a("seo.title"),description:a("seo.description")}),e.jsx(A,{sx:{display:"flex",justifyContent:"center",mt:4},children:e.jsx(de,{})})]}):_?e.jsx(oe,{children:e.jsx(ce,{title:a("errors.genericErrorTitle"),message:_,showRetry:!0,retryButtonText:a("errors.retry"),onRetry:()=>{window.location.reload()},showHome:!0,homeButtonText:a("errors.home")})}):s?e.jsxs(e.Fragment,{children:[e.jsx(ne,{title:a("seo.title"),description:a("seo.description")}),e.jsx(oe,{children:e.jsxs(A,{sx:{maxWidth:600,mx:"auto",mt:4,mb:4},children:[e.jsx(f,{variant:"h4",gutterBottom:!0,align:"center",children:a("dashboard.title")}),e.jsx(f,{variant:"body1",gutterBottom:!0,align:"center",sx:{mb:4},children:a("dashboard.subtitle")}),e.jsxs(Y,{spacing:2,children:[e.jsx(ze,{user:s,onUpdate:r=>n(i=>({...i,...r}))}),e.jsx(Be,{currentEmail:s.email,onUpdate:r=>n(i=>({...i,email:r}))}),e.jsx(Ue,{}),e.jsx(De,{enabled:s.twoFAEnabled,onToggle:r=>n(i=>({...i,twoFAEnabled:r}))})]})]})})]}):e.jsx(Ce,{to:"/login",replace:!0})}export{Ye as default};
