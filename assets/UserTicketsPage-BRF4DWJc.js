import{r as h,j as e,R as H}from"./react-C0aVURRx.js";import{b as I,a as N,P as M,S as J,O as K}from"./index-DrEuU79R.js";import{E as X}from"./ErrorDisplay-CPpgxCLY.js";import{u as Z,q as g,t as j,N as ee,a2 as P,B as C,I as B,p as te,r as se,a3 as re,ap as oe,O as ne,aq as ae,x as ie,Q as le,U as ce,ao as F,C as q,ar as de,R as ue,_ as pe}from"./mui-DvHa722-.js";import{d as Q}from"./dayjs-DMyafwSS.js";import{F as Y}from"./FilterSelect-BZIZCyjw.js";import{u as w}from"./i18n-react-CLR_B6bE.js";import{a as fe,b as xe,c as me}from"./billingService-D-S36CYI.js";import{u as U}from"./useCustomSnackbar-BM_DdCE4.js";import{u as he}from"./useDownloadInvoice-BrgeLClq.js";import{f as ge}from"./format-_gz818Hm.js";import{u as _e}from"./useProductDetails-Bn1G9aGq.js";import{ab as je}from"./vendor-BkFWaOq0.js";import{T as we}from"./TicketCardSkeleton-D3Sn2Pyc.js";import"./axios-xsH4HHeE.js";import"./zustand-DgaMZn_z.js";import"./i18n-Bhc83OLH.js";import"./emotion-BDhcDjNx.js";import"./helmet-OWuT_DBl.js";import"./cookie-consent-DmI9BIvn.js";function ke({filters:t,onChange:s}){const{t:r}=w("tickets"),l=Z(),[x,d]=h.useState(!1),p={"":r("filters.status_all"),issued:r("filters.status_issued"),used:r("filters.status_used"),refunded:r("filters.status_refunded"),cancelled:r("filters.status_cancelled")},i=Object.entries(p).reduce((o,[n,_])=>(o[_]=n,o),{}),a=Object.values(p),c=p[t.status],f=e.jsxs(g,{sx:{width:260,py:2,px:1},children:[e.jsx(j,{variant:"h6",gutterBottom:!0,children:r("filters.title")}),e.jsxs(ee,{spacing:2,sx:{mx:1},children:[e.jsx(Y,{label:r("filters.status_label"),value:c,options:a,onChange:o=>{const n=i[o];s({status:n,page:1})}}),e.jsx(P,{label:r("filters.event_date_from"),value:t.event_date_from?Q(t.event_date_from):null,onChange:o=>s({event_date_from:(o==null?void 0:o.format("YYYY-MM-DD"))||"",page:1}),slotProps:{textField:{size:"small",fullWidth:!0}}}),e.jsx(P,{label:r("filters.event_date_to"),value:t.event_date_to?Q(t.event_date_to):null,onChange:o=>s({event_date_to:(o==null?void 0:o.format("YYYY-MM-DD"))||"",page:1}),slotProps:{textField:{size:"small",fullWidth:!0}}}),e.jsx(Y,{label:r("filters.per_page"),value:String(t.per_page),options:["5","10","25","50","100"],onChange:o=>{const n=parseInt(o,10);s({per_page:n,page:1})}}),e.jsx(C,{variant:"outlined",fullWidth:!0,onClick:()=>s({status:"",event_date_from:"",event_date_to:"",per_page:5,page:1}),children:r("filters.reset")})]})]});return e.jsxs(e.Fragment,{children:[e.jsx(g,{component:"aside",sx:{display:{xs:"none",md:"block"},position:"sticky",top:l.mixins.toolbar.minHeight,bgcolor:"background.paper",border:`1px solid ${l.palette.divider}`,borderRadius:1,width:260},children:f}),e.jsxs(g,{sx:{display:{xs:"block",md:"none"},mb:2},children:[e.jsx(B,{onClick:()=>d(!0),"aria-label":r("filters.title"),children:e.jsx(te,{})}),e.jsx(se,{open:x,onClose:()=>d(!1),keepMounted:!0,children:e.jsxs(g,{sx:{position:"relative"},children:[e.jsx(B,{onClick:()=>d(!1),size:"small",sx:{position:"absolute",top:8,right:8},"aria-label":r("filters.close"),children:e.jsx(re,{})}),f]})})]})]})}function be(){const t=I(p=>p.authToken),{t:s}=w("tickets"),{notify:r}=U(),[l,x]=h.useState(!1);return{download:async p=>{var a,c;if(!t){r(s("errors.not_authenticated"),"warning");return}const i=p.replace(/^.*[\\/]/,"");if(!i){r(s("errors.download_failed"),"error");return}x(!0);try{const f=await fe(i,t),o=window.URL.createObjectURL(f),n=document.createElement("a");n.href=o,n.download=i,document.body.appendChild(n),n.click(),n.remove(),window.URL.revokeObjectURL(o),r(s("tickets.download_success"),"success")}catch(f){let o=s("errors.download_failed"),n="error";((a=f.response)==null?void 0:a.status)===404?(o=s("errors.not_found"),n="warning"):((c=f.response)==null?void 0:c.status)===401&&(o=s("errors.unauthorized"),n="warning"),r(o,n)}finally{x(!1)}},downloading:l}}function ve(t){const s=I(a=>a.authToken),{notify:r}=U(),{t:l}=w("tickets"),[x,d]=h.useState(null),[p,i]=h.useState(!1);return h.useEffect(()=>{let a=!1;if(x&&(URL.revokeObjectURL(x),d(null)),!t)return;if(!s){r(l("errors.not_authenticated"),"warning");return}const c=t.replace(/^.*[\\/]/,"");return(async()=>{var o,n;i(!0);try{const _=await xe(c,s);if(a)return;const u=URL.createObjectURL(_);d(u)}catch(_){let u=l("errors.qr_fetch_failed");((o=_.response)==null?void 0:o.status)===404?u=l("errors.qr_not_found"):((n=_.response)==null?void 0:n.status)===401&&(u=l("errors.unauthorized")),r(u,"error")}finally{a||i(!1)}})(),()=>{a=!0}},[t,s]),{qrUrl:x,loading:p}}function ye(t){switch(t){case"used":return"success";case"issued":return"info";case"refunded":return"warning";case"cancelled":return"error";default:return"default"}}function Te({ticket:t}){var D,E,L,R,O,z;const{t:s}=w("tickets"),r=N(k=>k.lang),{notify:l}=U(),{download:x,downloading:d}=be(),{download:p,downloading:i}=he(),{ref:a,inView:c}=je({triggerOnce:!0,rootMargin:"200px"}),{qrUrl:f,loading:o}=ve(c?t.qr_filename:null),n=((D=t.product_snapshot)==null?void 0:D.product_id)??null,{product:_,loading:u,error:m}=_e(n,r);if(h.useEffect(()=>{!u&&m&&l(s("errors.product_fetch_failed"),"warning")},[u,m,t.id,l,s]),u)return e.jsx(we,{});let b="",v="",y="",T="",S=null;m||!_?b=s("tickets.no_product"):(b=(E=t.product_snapshot)==null?void 0:E.product_name,v=ge((L=_.product_details)==null?void 0:L.date,r),y=((R=_.product_details)==null?void 0:R.time)||"",T=((O=_.product_details)==null?void 0:O.location)||s("tickets.no_location"),S=((z=t.product_snapshot)==null?void 0:z.ticket_places)??null);const W=s(`tickets.status.${t.status}`,t.status),$=ye(t.status),A=()=>{t.pdf_filename?x(t.pdf_filename).catch(k=>{l(s("errors.download_error"),"error")}):l(s("tickets.no_pdf"),"warning")},V=()=>{const k=`invoice_${t.payment_uuid}.pdf`;p(k).catch(Ie=>{l(s("errors.invoice_download_error"),"error")})},G=o?e.jsx(oe,{variant:"rectangular",sx:{width:{xs:"100%",md:200},height:{xs:150,md:200}}}):f?e.jsx(ne,{component:"img",image:f,alt:s("tickets.qr_alt"),loading:"lazy",sx:{width:{xs:"100%",md:200},height:{xs:150,md:200},objectFit:"contain",backgroundColor:"background.default"}}):e.jsx(g,{sx:{width:{xs:"100%",md:200},height:{xs:150,md:200},display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"background.default"},children:e.jsx(ae,{fontSize:"large",color:"disabled"})});return e.jsx(g,{ref:a,sx:{flex:{xs:"1 1 calc(33% - 32px)",md:"1 1 100%"},minWidth:{xs:280,md:"auto"},maxWidth:{xs:320,md:"100%"}},children:e.jsxs(ie,{sx:{display:"flex",flexDirection:{xs:"column",md:"row"},alignItems:{xs:"stretch",md:"center"},p:2,gap:1},children:[G,e.jsxs(le,{sx:{flexGrow:1},children:[e.jsx(j,{variant:"h6",gutterBottom:!0,children:b}),!u&&t.token&&e.jsx(j,{variant:"body2",sx:{mb:3},children:s("tickets.token",{token:t.token})}),!u&&v&&e.jsxs(j,{variant:"body2",color:"text.secondary",sx:{mt:.5},children:[v,y&&` â€“ ${y}`]}),!u&&T&&e.jsx(j,{variant:"body2",color:"text.secondary",sx:{mt:.5,mb:3},children:T}),!u&&S!==null&&e.jsx(j,{variant:"body2",sx:{mt:.5},children:s("tickets.places",{count:S})}),!u&&e.jsx(g,{sx:{mt:1},children:e.jsx(ce,{label:W,color:$,size:"small"})})]}),e.jsxs(g,{sx:{display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",gap:1,"& .MuiButton-root":{whiteSpace:"nowrap"}},children:[e.jsx(F,{title:s("tickets.download_pdf"),children:e.jsx("span",{children:e.jsx(C,{size:"small",variant:"outlined",startIcon:d?e.jsx(q,{size:16}):e.jsx(de,{}),onClick:A,disabled:d,children:s("tickets.download_ticket")})})}),e.jsx(F,{title:t.product_snapshot.discounted_price===0?s("tickets.free_ticket"):s("tickets.download_invoice_pdf"),children:e.jsx("span",{children:e.jsx(C,{size:"small",variant:"outlined",startIcon:i?e.jsx(q,{size:16}):e.jsx(ue,{}),onClick:V,disabled:i||t.product_snapshot.discounted_price===0,children:t.product_snapshot.discounted_price===0?s("tickets.free_ticket"):s("tickets.download_invoice")})})})]})]})})}function Se({tickets:t}){const{t:s}=w("tickets");return t.length===0?e.jsx(j,{variant:"h6",align:"center",sx:{mt:4},children:s("tickets.no_tickets")}):e.jsx(g,{sx:{display:"flex",flexWrap:"wrap",gap:2,justifyContent:{xs:"center",md:"flex-start"}},children:t.map(r=>e.jsx(Te,{ticket:r,invoiceLink:r.payment_uuid||""},r.token))})}function Ce(t){const s=I(n=>n.authToken),[r,l]=h.useState([]),[x,d]=h.useState(0),[p,i]=h.useState(!1),[a,c]=h.useState(null),[f,o]=h.useState(null);return h.useEffect(()=>{let n=!1;return(async()=>{var u;if(i(!0),c(null),o(null),!s){c(new Error("User not authenticated")),l([]),d(0),i(!1);return}try{const m=await me(t,s);if(n)return;l(m.data.data),m.data.meta&&typeof m.data.meta.total=="number"?d(m.data.meta.total):d(m.data.data.length)}catch(m){if(n)return;((u=m.response)==null?void 0:u.status)===422?o(m.response.data.errors):c(m instanceof Error?m:new Error("Unknown error"))}finally{n||i(!1)}})(),()=>{n=!0}},[JSON.stringify(t),s]),{tickets:r,total:x,loading:p,error:a,validationErrors:f}}function Ne(){const{t}=w("tickets"),[s,r]=h.useState({status:"",per_page:5,page:1,event_date_from:"",event_date_to:""}),{tickets:l,total:x,loading:d,error:p,validationErrors:i}=Ce(s);return H.useEffect(()=>{if(!i)return;const a={};i.q&&(a.status=""),i.event_date_from&&(a.event_date_from=""),i.event_date_to&&(a.event_date_to=""),i.per_page&&(a.per_page=5),i.page&&(a.page=1),r(c=>({...c,...a}))},[i]),p?e.jsx(M,{children:e.jsx(X,{title:t("errors.title"),message:t("errors.message"),showRetry:!0,retryButtonText:t("errors.retry"),onRetry:()=>r(a=>({...a})),showHome:!0,homeButtonText:t("errors.go_home")})}):e.jsxs(e.Fragment,{children:[e.jsx(J,{title:t("seo.title"),description:t("seo.description")}),e.jsxs(M,{disableCard:!0,children:[e.jsx(j,{variant:"h4",sx:{px:2},children:t("tickets.title")}),e.jsxs(g,{sx:{display:"flex",flexDirection:{xs:"column",md:"row"},gap:2,p:2},children:[e.jsx(ke,{filters:s,onChange:a=>r(c=>({...c,...a}))}),e.jsxs(g,{component:"main",flex:1,children:[d?e.jsx(g,{textAlign:"center",py:8,children:e.jsx(K,{})}):e.jsx(Se,{tickets:l}),!d&&l.length>0&&e.jsx(g,{textAlign:"center",mt:4,children:e.jsx(pe,{count:Math.ceil(x/s.per_page)||1,page:s.page,onChange:(a,c)=>r(f=>({...f,page:c}))})})]})]})]})]})}export{Ne as default};
