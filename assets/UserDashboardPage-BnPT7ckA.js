import{r,j as e}from"./react-C0aVURRx.js";import{A as R,b as V,a as le,S as se,O as de}from"./index-BUXUlOD7.js";import{P as ae}from"./PageWrapper-BZs1h3P6.js";import{a as B}from"./axios-xsH4HHeE.js";import{A as $,g as S}from"./AlertMessage-gDVkVQCd.js";import{E as ce}from"./ErrorDisplay-qj7bh5TT.js";import{ap as H,aq as J,q as A,t as x,ar as K,as as X,G as Y,J as O,B as z,C as N,am as ue,I as he,an as pe,ao as me,n as xe,at as ie,V as fe,a6 as be,a8 as ge,a7 as je,a9 as ye}from"./mui-Bv5YL-XP.js";import{u as Q}from"./i18n-react-DsoMXUU6.js";import{O as Z,a4 as we,U as Ce}from"./vendor-CluA6s6b.js";import{a as re,i as ve}from"./validation-491qobvS.js";import{P as Se}from"./PasswordWithConfirmation-C-PrELzv.js";import"./dayjs-DMyafwSS.js";import"./zustand-DgaMZn_z.js";import"./i18n-Bhc83OLH.js";import"./emotion-BXBuUsh5.js";import"./helmet-BXAee230.js";import"./cookie-consent-Eepg6n4_.js";async function Te(a,o){const s={"Content-Type":"application/json",Authorization:`Bearer ${a}`},n=await B.get(`${R}/api/users/me`,{headers:s,signal:o==null?void 0:o.signal});return{status:n.status,data:n.data}}async function Ae(a,o){const s={"Content-Type":"application/json",Authorization:`Bearer ${a}`},n=await B.patch(`${R}/api/users/me`,o,{headers:s});return{status:n.status,data:n.data}}async function Ee(a,o,s){const n={"Content-Type":"application/json",Authorization:`Bearer ${a}`,"Accept-Language":s},E=await B.patch(`${R}/api/auth/email`,{email:o},{headers:n});return{status:E.status,data:E.data}}async function _e(a,o,s,n){const E={"Content-Type":"application/json",Authorization:`Bearer ${a}`},b=await B.patch(`${R}/api/auth/password`,{current_password:o,password:s,password_confirmation:n},{headers:E});return{status:b.status,data:b.data}}async function ke(a){const o={"Content-Type":"application/json",Authorization:`Bearer ${a}`},s=await B.post(`${R}/api/auth/2fa/enable`,{},{headers:o});return{status:s.status,data:s.data}}async function Me(a,o){const s={"Content-Type":"application/json",Authorization:`Bearer ${a}`},n=await B.post(`${R}/api/auth/2fa/confirm`,{otp:o},{headers:s});return{status:n.status,data:n.data}}async function Pe(a,o){const s={"Content-Type":"application/json",Authorization:`Bearer ${a}`};return{status:(await B.post(`${R}/api/auth/2fa/disable`,{twofa_code:o},{headers:s})).status}}function ze({user:a,onUpdate:o}){const{t:s}=Q("userDashboard"),n=V(_=>_.authToken),E=Z(),[b,k]=r.useState(!1),[f,t]=r.useState(a.firstname),[i,M]=r.useState(a.lastname),[u,h]=r.useState(!1),[g,P]=r.useState(!1),[l,d]=r.useState(!1),[y,w]=r.useState(null),[I,m]=r.useState(null),C=u&&f.trim()==="",p=g&&i.trim()==="",j=f.trim()!=="",F=i.trim()!=="";r.useEffect(()=>{t(a.firstname),M(a.lastname),h(!1),P(!1),w(null)},[a.firstname,a.lastname]);const T=()=>{b&&(w(null),m(null),h(!1),P(!1),t(a.firstname),M(a.lastname)),k(_=>!_)},q=async _=>{if(_.preventDefault(),w(null),m(null),!j||!F){w(s("errors.nameRequired"));return}if(!n){E("/login",{replace:!0});return}d(!0);try{const{status:c}=await Ae(n,{firstname:f,lastname:i});c===204||c===200?(o({firstname:f,lastname:i}),m(s("dashboard.successMessageProfileUpdate"))):w(s("errors.nameUpdate"))}catch(c){if(B.isAxiosError(c)&&c.response){const{data:D}=c.response;D.code?w(S(s,D.code)):w(S(s,"generic_error"))}else w(S(s,"network_error"))}finally{d(!1)}};return e.jsxs(H,{expanded:b,onChange:T,children:[e.jsx(J,{expandIcon:e.jsx(K,{}),children:e.jsxs(A,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",width:"100%",gap:{xs:1,sm:0}},children:[e.jsx(x,{sx:{fontSize:{xs:"0.85rem",sm:"1.2rem"}},children:s("dashboard.name")}),e.jsxs(x,{variant:"body2",color:"text.secondary",sx:{fontSize:{xs:"0.8rem",sm:"1rem"}},children:[a.firstname," ",a.lastname]})]})}),e.jsx(X,{children:e.jsxs(Y,{component:"form",onSubmit:q,spacing:2,sx:{width:"100%"},children:[y&&e.jsx($,{message:y,severity:"error"}),I&&e.jsx($,{message:I,severity:"success"}),e.jsx(O,{required:!0,fullWidth:!0,id:"lastname",label:s("dashboard.lastname"),value:i,onChange:_=>M(_.target.value),onBlur:()=>P(!0),autoComplete:"family-name",error:p,helperText:p?s("errors.lastnameRequired"):""}),e.jsx(O,{required:!0,fullWidth:!0,id:"firstname",label:s("dashboard.firstname"),value:f,onChange:_=>t(_.target.value),onBlur:()=>h(!0),autoComplete:"given-name",error:C,helperText:C?s("errors.firstnameRequired"):""}),e.jsxs(A,{sx:{display:"flex",justifyContent:"flex-end",gap:1},children:[e.jsx(z,{onClick:()=>{t(a.firstname),M(a.lastname),h(!1),P(!1),w(null),m(null)},disabled:l,children:s("dashboard.cancel")}),e.jsx(z,{type:"submit",variant:"contained",disabled:l||!j||!F,startIcon:l?e.jsx(N,{color:"inherit",size:16}):void 0,children:l?`${s("dashboard.saveLoad")}…`:s("dashboard.save")})]})]})})]})}function Be({currentEmail:a,onUpdate:o}){const{t:s}=Q("userDashboard"),n=V(C=>C.authToken),E=Z(),b=le(C=>C.lang),[k,f]=r.useState(!1),[t,i]=r.useState(a),[M,u]=r.useState(!1),[h,g]=r.useState(!1),[P,l]=r.useState(null),[d,y]=r.useState(null),w=M&&!re(t);r.useEffect(()=>{i(a),u(!1),l(null)},[a]);const I=()=>{k&&(l(null),y(null),u(!1),i(a)),f(C=>!C)},m=async C=>{if(C.preventDefault(),l(null),y(null),!re(t)){l(s("errors.emailRequired"));return}if(t===a){l(s("errors.emailUnchanged"));return}if(!n){E("/login",{replace:!0});return}g(!0);try{const{status:p}=await Ee(n,t,b);p===204||p===200?(o(t),y(s("dashboard.successMessageEmailUpdate"))):l(s("errors.emailUpdate"))}catch(p){if(B.isAxiosError(p)&&p.response){const{data:j}=p.response;j.code?l(S(s,j.code)):l(S(s,"generic_error"))}else l(S(s,"network_error"))}finally{g(!1)}};return e.jsxs(H,{expanded:k,onChange:I,children:[e.jsx(J,{expandIcon:e.jsx(K,{}),children:e.jsxs(A,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",width:"100%",gap:{xs:1,sm:0}},children:[e.jsx(x,{sx:{fontSize:{xs:"0.85rem",sm:"1.2rem"}},children:s("dashboard.email")}),e.jsx(x,{variant:"body2",color:"text.secondary",sx:{fontSize:{xs:"0.8rem",sm:"1rem"}},children:a})]})}),e.jsx(X,{children:e.jsxs(Y,{component:"form",onSubmit:m,spacing:2,sx:{width:"100%"},children:[P&&e.jsx($,{message:P,severity:"error"}),d&&e.jsx($,{message:d,severity:"success"}),e.jsx(O,{required:!0,fullWidth:!0,id:"email",label:s("dashboard.email"),type:"email",value:t,onChange:C=>i(C.target.value),onBlur:()=>u(!0),autoComplete:"email",error:w,helperText:w?s("errors.emailInvalid"):""}),e.jsxs(A,{sx:{display:"flex",justifyContent:"flex-end",gap:1},children:[e.jsx(z,{onClick:()=>{i(a),u(!1),l(null),y(null)},disabled:h,children:s("dashboard.cancel")}),e.jsx(z,{type:"submit",variant:"contained",disabled:h||!re(t),startIcon:h?e.jsx(N,{color:"inherit",size:16}):void 0,children:h?`${s("dashboard.saveLoad")}…`:s("dashboard.save")})]})]})})]})}function De(){const{t:a}=Q("userDashboard"),o=V(c=>c.authToken),s=Z(),[n,E]=r.useState(!1),[b,k]=r.useState(""),[f,t]=r.useState(""),[i,M]=r.useState(""),[u,h]=r.useState(!1),[g,P]=r.useState(!1),[l,d]=r.useState(!1),[y,w]=r.useState(!1),[I,m]=r.useState(null),[C,p]=r.useState(null),j=u&&!b.trim(),F=ve(f),T=f===i,q=()=>{n&&(m(null),p(null),h(!1),P(!1)),E(c=>!c)},_=async c=>{if(c.preventDefault(),m(null),p(null),j){m(a("errors.currentPasswordRequired"));return}if(!F){m(a("errors.passwordNotStrong"));return}if(!T){m(a("errors.passwordsDontMatch"));return}if(!o){s("/login",{replace:!0});return}w(!0);try{const{status:D}=await _e(o,b,f,i);D===200?p(a("dashboard.successMessagePasswordUpdate")):m(a("errors.passwordUpdate"))}catch(D){if(B.isAxiosError(D)&&D.response){const{data:G}=D.response;G.code?m(S(a,G.code)):m(S(a,"generic_error"))}else m(S(a,"network_error"))}finally{w(!1)}};return e.jsxs(H,{expanded:n,onChange:q,children:[e.jsx(J,{expandIcon:e.jsx(K,{}),children:e.jsx(A,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",width:"100%",gap:{xs:1,sm:0}},children:e.jsx(x,{sx:{fontSize:{xs:"0.85rem",sm:"1.2rem"}},children:a("dashboard.password")})})}),e.jsx(X,{children:e.jsxs(Y,{component:"form",onSubmit:_,spacing:2,sx:{width:"100%"},children:[I&&e.jsx($,{message:I,severity:"error"}),C&&e.jsx($,{message:C,severity:"success"}),e.jsx(O,{required:!0,fullWidth:!0,id:"password",label:a("dashboard.currentPassword"),type:l?"text":"password",value:b,onChange:c=>k(c.target.value),onBlur:()=>h(!0),autoComplete:"password",error:j,helperText:j?a("errors.passwordInvalid"):"",slotProps:{input:{endAdornment:e.jsx(ue,{position:"end",children:e.jsx(he,{"aria-label":a(l?"dashboard.hidePassword":"dashboard.showPassword"),onClick:()=>d(!l),edge:"end",children:l?e.jsx(pe,{}):e.jsx(me,{})})})}}}),e.jsx(Se,{password:f,onPasswordChange:t,confirmPassword:i,onConfirmChange:M,touched:g,onBlur:()=>P(!0)}),e.jsxs(A,{sx:{display:"flex",justifyContent:"flex-end",gap:1},children:[e.jsx(z,{onClick:()=>{k(""),t(""),M(""),h(!1),P(!1),m(null),p(null)},disabled:y,children:a("dashboard.cancel")}),e.jsx(z,{type:"submit",variant:"contained",disabled:y||!F||!T||j,startIcon:y?e.jsx(N,{color:"inherit",size:16}):void 0,children:y?`${a("dashboard.saveLoad")}…`:a("dashboard.save")})]})]})})]})}function Ue({enabled:a,onToggle:o}){const{t:s}=Q("userDashboard"),n=V(v=>v.authToken),E=Z(),b=xe(v=>v.breakpoints.down("sm")),[k,f]=r.useState(!1),[t,i]=r.useState(!1),[M,u]=r.useState(null),[h,g]=r.useState(null),[P,l]=r.useState(!1),[d,y]=r.useState("enable_prepare"),[w,I]=r.useState(null),[m,C]=r.useState(null),[p,j]=r.useState(""),[F,T]=r.useState(null),[q,_]=r.useState(null),[c,D]=r.useState("otp"),G=()=>{k&&(u(null),g(null)),f(v=>!v)},te=async()=>{var v,W;if(u(null),g(null),T(null),_(null),!n){E("/login",{replace:!0});return}if(a)y("disable"),D("otp"),j(""),T(null),l(!0);else{i(!0);try{const U=await ke(n);U.status===200&&U.data.qrCodeUrl?(I(U.data.qrCodeUrl),C(U.data.secret||null),y("enable_prepare"),l(!0)):u(S(s,"generic_error"))}catch(U){B.isAxiosError(U)&&((W=(v=U.response)==null?void 0:v.data)!=null&&W.code)?u(S(s,U.response.data.code)):u(S(s,"network_error"))}finally{i(!1)}}},ne=async()=>{var v,W,U;if(T(null),!n){E("/login",{replace:!0});return}if(d==="enable_confirm"){if(!p){T(s("errors.otpRequired"));return}}else if(d==="disable"&&!p){T(s(c==="otp"?"errors.otpRequired":"errors.recoveryCodeRequired"));return}i(!0);try{switch(d){case"enable_prepare":y("enable_confirm"),j("");break;case"enable_confirm":{const L=await Me(n,p);L.status===200&&((v=L.data)!=null&&v.recovery_codes)?(o(!0),g(s("dashboard.2faEnabled")),_(L.data.recovery_codes),T(null),y("enable_success")):u(S(s,"generic_error"))}break;case"disable":(await Pe(n,p)).status===204?(o(!1),g(s("dashboard.2faDisabled")),l(!1),j(""),f(!1)):u(S(s,"generic_error"));break}}catch(L){if(B.isAxiosError(L)&&((U=(W=L.response)==null?void 0:W.data)!=null&&U.code)){const oe=L.response.data.code;T(d==="disable"&&oe==="twofa_invalid_code"?s(c==="otp"?"errors.invalidOtp":"errors.invalidRecoveryCode"):S(s,oe))}else T(S(s,"network_error"))}finally{i(!1)}},ee=()=>{l(!1),j(""),T(null),I(null),C(null),_(null),(d==="enable_prepare"||d==="enable_confirm")&&o(!1),y("enable_prepare")};return e.jsxs(e.Fragment,{children:[e.jsxs(H,{expanded:k,onChange:G,children:[e.jsx(J,{expandIcon:e.jsx(K,{}),children:e.jsxs(A,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",width:"100%",gap:{xs:1,sm:0}},children:[e.jsx(x,{sx:{fontSize:{xs:"0.85rem",sm:"1.2rem"}},children:s("dashboard.twoFA")}),b?e.jsx(ie,{size:"small",checked:a,onChange:te,disabled:t}):e.jsx(fe,{control:e.jsx(ie,{size:"small",checked:a,onChange:te,disabled:t}),label:s(a?"dashboard.enabled":"dashboard.disabled")})]})}),e.jsxs(X,{children:[M&&e.jsx(x,{color:"error",children:M}),h&&e.jsx(x,{color:"success.main",children:h}),e.jsx(x,{variant:"body2",children:s(a?"dashboard.2faEnabled":"dashboard.2faDisabled")})]})]}),e.jsxs(be,{open:P,onClose:ee,children:[e.jsxs(ge,{children:[d==="disable"&&s("dashboard.disable2faTitle"),d==="enable_prepare"&&s("dashboard.enable2faTitle"),d==="enable_confirm"&&s("dashboard.confirm2faTitle")]}),e.jsxs(je,{children:[d==="enable_prepare"&&w&&e.jsxs(A,{sx:{textAlign:"center",mb:2},children:[e.jsx(x,{variant:"body2",gutterBottom:!0,children:s("dashboard.scanQRCodeWithoutConfirm")}),e.jsx(A,{sx:{mx:"auto",width:200,height:200,backgroundColor:"#fff",p:1},children:e.jsx(we,{value:w,size:180})}),m&&e.jsxs(A,{sx:{display:"flex",alignItems:"center",justifyContent:"center",mt:1},children:[e.jsxs(x,{variant:"caption",sx:{fontFamily:"monospace",mr:1},children:[s("dashboard.secret"),": ",m]}),e.jsx(z,{size:"small",onClick:()=>{navigator.clipboard.writeText(m)},children:s("dashboard.copy")})]}),e.jsx(x,{variant:"body2",sx:{mt:2},children:s("dashboard.enterOtpAfterScan")})]}),d==="enable_confirm"&&e.jsxs(A,{children:[e.jsx(x,{variant:"body2",gutterBottom:!0,children:s("dashboard.enterCodeToConfirm")}),e.jsx(O,{label:s(b?"dashboard.otpCodeMobile":"dashboard.otpCode"),value:p,onChange:v=>j(v.target.value.trim()),fullWidth:!0,type:"text",margin:"normal",slotProps:{input:{inputProps:{maxLength:6}}},placeholder:"123456"}),F&&e.jsx(x,{color:"error",sx:{mt:1},children:F})]}),d==="enable_success"&&q&&e.jsxs(A,{children:[e.jsx(x,{variant:"subtitle2",gutterBottom:!0,children:s("dashboard.recoveryCodesTitle")}),q.map(v=>e.jsx(x,{variant:"body2",sx:{fontFamily:"monospace"},children:v},v)),e.jsx(x,{variant:"caption",sx:{display:"block",mt:1},children:s("dashboard.recoveryCodesNote")})]}),d==="disable"&&e.jsxs(A,{children:[e.jsx(x,{variant:"body2",gutterBottom:!0,children:s(c==="otp"?"dashboard.enterCodeToDisable":"dashboard.enterRecoveryCodeToDisable")}),e.jsxs(A,{sx:{display:"flex",gap:1,mb:1},children:[e.jsx(z,{variant:c==="otp"?"contained":"outlined",onClick:()=>{D("otp"),j(""),T(null)},disabled:t,size:"small",sx:{fontSize:{xs:"0.6rem",sm:"0.875rem"}},children:s("dashboard.useOtp")}),e.jsx(z,{variant:c==="recovery"?"contained":"outlined",onClick:()=>{D("recovery"),j(""),T(null)},disabled:t,size:"small",sx:{fontSize:{xs:"0.6rem",sm:"0.875rem"}},children:s("dashboard.useRecoveryCode")})]}),e.jsx(O,{label:s(b?c==="otp"?"dashboard.otpCodeMobile":"dashboard.recoveryCodeMobile":c==="otp"?"dashboard.otpCode":"dashboard.recoveryCode"),value:p,onChange:v=>j(v.target.value.trim()),fullWidth:!0,type:"text",margin:"normal",slotProps:{input:{inputProps:{maxLength:c==="otp"?6:20}}},placeholder:c==="otp"?"123456":"ABCDEFGHIJ"}),F&&e.jsx(x,{color:"error",sx:{mt:1},children:F})]})]}),e.jsxs(ye,{children:[e.jsx(z,{onClick:ee,disabled:t,children:s("dashboard.cancel")}),d==="enable_prepare"&&e.jsx(z,{variant:"contained",onClick:ne,disabled:t,startIcon:t?e.jsx(N,{size:16}):null,children:s("dashboard.next")}),(d==="enable_confirm"||d==="disable")&&e.jsx(z,{variant:"contained",onClick:ne,disabled:t||!p,startIcon:t?e.jsx(N,{size:16}):null,children:s("dashboard.confirm")}),d==="enable_success"&&e.jsx(z,{variant:"contained",onClick:ee,children:s("dashboard.done")})]})]})]})}function Ze(){const{t:a}=Q("userDashboard"),o=V(t=>t.authToken),[s,n]=r.useState(null),[E,b]=r.useState(!0),[k,f]=r.useState(null);return r.useEffect(()=>{if(!o){n(null),b(!1);return}const t=new AbortController,i=t.signal;return(async()=>{b(!0),f(null);try{const u=await Te(o,{signal:i});if(i.aborted)return;const{status:h,data:g}=u;h===200&&g.user?n({firstname:g.user.firstname,lastname:g.user.lastname,email:g.user.email,twoFAEnabled:g.user.twofa_enabled}):f(a("errors.fetchProfile"))}catch(u){if(i.aborted)return;if(B.isAxiosError(u)&&u.response){const h=u.response.data,g=h==null?void 0:h.code;f(S(a,g??"generic_error"))}else f(S(a,"network_error"))}finally{i.aborted||b(!1)}})(),()=>{t.abort()}},[o,a]),E?e.jsxs(e.Fragment,{children:[e.jsx(se,{title:a("seo.title"),description:a("seo.description")}),e.jsx(ae,{children:e.jsx(A,{sx:{display:"flex",justifyContent:"center",mt:4},children:e.jsx(de,{})})})]}):k?e.jsxs(e.Fragment,{children:[e.jsx(se,{title:a("seo.errorTitle"),description:a("seo.errorDescription")}),e.jsx(ae,{children:e.jsx(ce,{title:a("errors.genericErrorTitle"),message:k,showRetry:!0,retryButtonText:a("errors.retry"),onRetry:()=>{window.location.reload()},showHome:!0,homeButtonText:a("errors.home")})})]}):s?e.jsxs(e.Fragment,{children:[e.jsx(se,{title:a("seo.title"),description:a("seo.description")}),e.jsx(ae,{children:e.jsxs(A,{sx:{maxWidth:600,mx:"auto",mt:4,mb:4},children:[e.jsx(x,{variant:"h4",gutterBottom:!0,align:"center",children:a("dashboard.title")}),e.jsx(x,{variant:"body1",gutterBottom:!0,align:"center",sx:{mb:4},children:a("dashboard.subtitle")}),e.jsxs(Y,{spacing:2,children:[e.jsx(ze,{user:s,onUpdate:t=>n(i=>({...i,...t}))}),e.jsx(Be,{currentEmail:s.email,onUpdate:t=>n(i=>({...i,email:t}))}),e.jsx(De,{}),e.jsx(Ue,{enabled:s.twoFAEnabled,onToggle:t=>n(i=>({...i,twoFAEnabled:t}))})]})]})})]}):e.jsx(Ce,{to:"/login",replace:!0})}export{Ze as default};
