import{r as a,j as e}from"./react-C0aVURRx.js";import{A as $,b as O,a as te,S as Z,O as ae}from"./index-JrA3fJ57.js";import{P as ee}from"./PageWrapper-Ddc78CbV.js";import{a as U}from"./axios-xsH4HHeE.js";import{A as z,g as T}from"./AlertMessage-BAnRUNh9.js";import{E as re}from"./ErrorDisplay-0QdYUOL9.js";import{ap as Q,aq as G,q as M,t as v,ar as H,as as J,G as K,J as N,B as _,C as X,am as ne,I as oe,an as ie,ao as le,V as de,at as ce,a6 as ue,a8 as he,a7 as pe,a9 as fe}from"./mui-Dl6HORPF.js";import{u as V}from"./i18n-react-ZsqOCTOc.js";import{O as Y,U as me}from"./vendor-B9PkVD2_.js";import{a as se,i as xe}from"./validation-491qobvS.js";import{P as ge}from"./PasswordWithConfirmation-DjQiF-aS.js";import"./dayjs-DMyafwSS.js";import"./zustand-DgaMZn_z.js";import"./i18n-Bhc83OLH.js";import"./emotion-QUM7EFga.js";import"./helmet-DwkNRAhC.js";import"./cookie-consent-BI82O-I0.js";async function je(t,i){const s={"Content-Type":"application/json",Authorization:`Bearer ${t}`},n=await U.get(`${$}/api/users/me`,{headers:s,signal:i==null?void 0:i.signal});return{status:n.status,data:n.data}}async function be(t,i){const s={"Content-Type":"application/json",Authorization:`Bearer ${t}`},n=await U.patch(`${$}/api/users/me`,i,{headers:s});return{status:n.status,data:n.data}}async function we(t,i,s){const n={"Content-Type":"application/json",Authorization:`Bearer ${t}`,"Accept-Language":s},C=await U.patch(`${$}/api/auth/email`,{email:i},{headers:n});return{status:C.status,data:C.data}}async function ye(t,i,s,n){const C={"Content-Type":"application/json",Authorization:`Bearer ${t}`},p=await U.patch(`${$}/api/auth/password`,{current_password:i,password:s,password_confirmation:n},{headers:C});return{status:p.status,data:p.data}}async function Ce(t){const i={"Content-Type":"application/json",Authorization:`Bearer ${t}`},s=await U.post(`${$}/api/auth/2fa/enable`,{},{headers:i});return{status:s.status,data:s.data}}async function Se(t,i){const s={"Content-Type":"application/json",Authorization:`Bearer ${t}`};return{status:(await U.post(`${$}/api/auth/2fa/disable`,{twofa_code:i},{headers:s})).status}}function ve({user:t,onUpdate:i}){const{t:s}=V("userDashboard"),n=O(P=>P.authToken),C=Y(),[p,A]=a.useState(!1),[d,r]=a.useState(t.firstname),[o,j]=a.useState(t.lastname),[x,c]=a.useState(!1),[b,g]=a.useState(!1),[l,D]=a.useState(!1),[S,f]=a.useState(null),[I,h]=a.useState(null),u=x&&d.trim()==="",m=b&&o.trim()==="",w=d.trim()!=="",F=o.trim()!=="";a.useEffect(()=>{r(t.firstname),j(t.lastname),c(!1),g(!1),f(null)},[t.firstname,t.lastname]);const q=()=>{p&&(f(null),h(null),c(!1),g(!1),r(t.firstname),j(t.lastname)),A(P=>!P)},k=async P=>{if(P.preventDefault(),f(null),h(null),!w||!F){f(s("errors.nameRequired"));return}if(!n){C("/login",{replace:!0});return}D(!0);try{const{status:y}=await be(n,{firstname:d,lastname:o});y===204||y===200?(i({firstname:d,lastname:o}),h(s("dashboard.successMessageProfileUpdate"))):f(s("errors.nameUpdate"))}catch(y){if(U.isAxiosError(y)&&y.response){const{data:L}=y.response;L.code?f(T(s,L.code)):f(T(s,"generic_error"))}else f(T(s,"network_error"))}finally{D(!1)}};return e.jsxs(Q,{expanded:p,onChange:q,children:[e.jsx(G,{expandIcon:e.jsx(H,{}),children:e.jsxs(M,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",width:"100%",gap:{xs:1,sm:0}},children:[e.jsx(v,{sx:{fontSize:{xs:"0.85rem",sm:"1.2rem"}},children:s("dashboard.name")}),e.jsxs(v,{variant:"body2",color:"text.secondary",sx:{fontSize:{xs:"0.8rem",sm:"1rem"}},children:[t.firstname," ",t.lastname]})]})}),e.jsx(J,{children:e.jsxs(K,{component:"form",onSubmit:k,spacing:2,sx:{width:"100%"},children:[S&&e.jsx(z,{message:S,severity:"error"}),I&&e.jsx(z,{message:I,severity:"success"}),e.jsx(N,{required:!0,fullWidth:!0,id:"lastname",label:s("dashboard.lastname"),value:o,onChange:P=>j(P.target.value),onBlur:()=>g(!0),autoComplete:"family-name",error:m,helperText:m?s("errors.lastnameRequired"):""}),e.jsx(N,{required:!0,fullWidth:!0,id:"firstname",label:s("dashboard.firstname"),value:d,onChange:P=>r(P.target.value),onBlur:()=>c(!0),autoComplete:"given-name",error:u,helperText:u?s("errors.firstnameRequired"):""}),e.jsxs(M,{sx:{display:"flex",justifyContent:"flex-end",gap:1},children:[e.jsx(_,{onClick:()=>{r(t.firstname),j(t.lastname),c(!1),g(!1),f(null),h(null)},disabled:l,children:s("dashboard.cancel")}),e.jsx(_,{type:"submit",variant:"contained",disabled:l||!w||!F,startIcon:l?e.jsx(X,{color:"inherit",size:16}):void 0,children:l?`${s("dashboard.saveLoad")}…`:s("dashboard.save")})]})]})})]})}function Te({currentEmail:t,onUpdate:i}){const{t:s}=V("userDashboard"),n=O(u=>u.authToken),C=Y(),p=te(u=>u.lang),[A,d]=a.useState(!1),[r,o]=a.useState(t),[j,x]=a.useState(!1),[c,b]=a.useState(!1),[g,l]=a.useState(null),[D,S]=a.useState(null),f=j&&!se(r);a.useEffect(()=>{o(t),x(!1),l(null)},[t]);const I=()=>{A&&(l(null),S(null),x(!1),o(t)),d(u=>!u)},h=async u=>{if(u.preventDefault(),l(null),S(null),!se(r)){l(s("errors.emailRequired"));return}if(r===t){l(s("errors.emailUnchanged"));return}if(!n){C("/login",{replace:!0});return}b(!0);try{const{status:m}=await we(n,r,p);m===204||m===200?(i(r),S(s("dashboard.successMessageEmailUpdate"))):l(s("errors.emailUpdate"))}catch(m){if(U.isAxiosError(m)&&m.response){const{data:w}=m.response;w.code?l(T(s,w.code)):l(T(s,"generic_error"))}else l(T(s,"network_error"))}finally{b(!1)}};return e.jsxs(Q,{expanded:A,onChange:I,children:[e.jsx(G,{expandIcon:e.jsx(H,{}),children:e.jsxs(M,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",width:"100%",gap:{xs:1,sm:0}},children:[e.jsx(v,{sx:{fontSize:{xs:"0.85rem",sm:"1.2rem"}},children:s("dashboard.email")}),e.jsx(v,{variant:"body2",color:"text.secondary",sx:{fontSize:{xs:"0.8rem",sm:"1rem"}},children:t})]})}),e.jsx(J,{children:e.jsxs(K,{component:"form",onSubmit:h,spacing:2,sx:{width:"100%"},children:[g&&e.jsx(z,{message:g,severity:"error"}),D&&e.jsx(z,{message:D,severity:"success"}),e.jsx(N,{required:!0,fullWidth:!0,id:"email",label:s("dashboard.email"),type:"email",value:r,onChange:u=>o(u.target.value),onBlur:()=>x(!0),autoComplete:"email",error:f,helperText:f?s("errors.emailInvalid"):""}),e.jsxs(M,{sx:{display:"flex",justifyContent:"flex-end",gap:1},children:[e.jsx(_,{onClick:()=>{o(t),x(!1),l(null),S(null)},disabled:c,children:s("dashboard.cancel")}),e.jsx(_,{type:"submit",variant:"contained",disabled:c||!se(r),startIcon:c?e.jsx(X,{color:"inherit",size:16}):void 0,children:c?`${s("dashboard.saveLoad")}…`:s("dashboard.save")})]})]})})]})}function Ee(){const{t}=V("userDashboard"),i=O(y=>y.authToken),s=Y(),[n,C]=a.useState(!1),[p,A]=a.useState(""),[d,r]=a.useState(""),[o,j]=a.useState(""),[x,c]=a.useState(!1),[b,g]=a.useState(!1),[l,D]=a.useState(!1),[S,f]=a.useState(!1),[I,h]=a.useState(null),[u,m]=a.useState(null),w=x&&!p.trim(),F=xe(d),q=d===o,k=()=>{n&&(h(null),m(null),c(!1),g(!1)),C(y=>!y)},P=async y=>{if(y.preventDefault(),h(null),m(null),w){h(t("errors.currentPasswordRequired"));return}if(!F){h(t("errors.passwordNotStrong"));return}if(!q){h(t("errors.passwordsDontMatch"));return}if(!i){s("/login",{replace:!0});return}f(!0);try{const{status:L}=await ye(i,p,d,o);L===200?m(t("dashboard.successMessagePasswordUpdate")):h(t("errors.passwordUpdate"))}catch(L){if(U.isAxiosError(L)&&L.response){const{data:R}=L.response;R.code?h(T(t,R.code)):h(T(t,"generic_error"))}else h(T(t,"network_error"))}finally{f(!1)}};return e.jsxs(Q,{expanded:n,onChange:k,children:[e.jsx(G,{expandIcon:e.jsx(H,{}),children:e.jsx(M,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",width:"100%",gap:{xs:1,sm:0}},children:e.jsx(v,{sx:{fontSize:{xs:"0.85rem",sm:"1.2rem"}},children:t("dashboard.password")})})}),e.jsx(J,{children:e.jsxs(K,{component:"form",onSubmit:P,spacing:2,sx:{width:"100%"},children:[I&&e.jsx(z,{message:I,severity:"error"}),u&&e.jsx(z,{message:u,severity:"success"}),e.jsx(N,{required:!0,fullWidth:!0,id:"password",label:t("dashboard.currentPassword"),type:l?"text":"password",value:p,onChange:y=>A(y.target.value),onBlur:()=>c(!0),autoComplete:"password",error:w,helperText:w?t("errors.passwordInvalid"):"",slotProps:{input:{endAdornment:e.jsx(ne,{position:"end",children:e.jsx(oe,{"aria-label":t(l?"dashboard.hidePassword":"dashboard.showPassword"),onClick:()=>D(!l),edge:"end",children:l?e.jsx(ie,{}):e.jsx(le,{})})})}}}),e.jsx(ge,{password:d,onPasswordChange:r,confirmPassword:o,onConfirmChange:j,touched:b,onBlur:()=>g(!0)}),e.jsxs(M,{sx:{display:"flex",justifyContent:"flex-end",gap:1},children:[e.jsx(_,{onClick:()=>{A(""),r(""),j(""),c(!1),g(!1),h(null),m(null)},disabled:S,children:t("dashboard.cancel")}),e.jsx(_,{type:"submit",variant:"contained",disabled:S||!F||!q||w,startIcon:S?e.jsx(X,{color:"inherit",size:16}):void 0,children:S?`${t("dashboard.saveLoad")}…`:t("dashboard.save")})]})]})})]})}function Ae({enabled:t,onToggle:i}){const{t:s}=V("dashboard"),n=O(B=>B.authToken),C=Y(),[p,A]=a.useState(!1),[d,r]=a.useState(!1),[o,j]=a.useState(null),[x,c]=a.useState(null),[b,g]=a.useState(!1),[l,D]=a.useState("enable"),[S,f]=a.useState(null),[I,h]=a.useState(null),[u,m]=a.useState("otp"),[w,F]=a.useState(""),[q,k]=a.useState(null),P=()=>{p&&(j(null),c(null)),A(B=>!B)},y=async()=>{var B,W;if(j(null),c(null),k(null),!n){C("/login",{replace:!0});return}if(t)D("disable"),m("otp"),F(""),k(null),g(!0);else{r(!0);try{const E=await Ce(n);E.status===200&&E.data.qrCodeUrl?(i(!0),c(s("success.2faEnabled")),f(E.data.qrCodeUrl),h(E.data.secret||null),D("enable"),g(!0)):j(s("errors.generic_error"))}catch(E){U.isAxiosError(E)&&((W=(B=E.response)==null?void 0:B.data)!=null&&W.code)?j(T(s,E.response.data.code)):j(T(s,"network_error"))}finally{r(!1)}}},L=async()=>{var B,W;if(k(null),!n){C("/login",{replace:!0});return}if(l==="disable"&&u==="otp"&&!w){k(s("errors.otpRequired"));return}r(!0);try{if(l==="disable"){const E={};u==="otp"&&(E.twofa_code=w),(await Se(n,w)).status===204?(i(!1),c(s("success.2faDisabled")),g(!1),F(""),A(!1)):k(s("errors.generic_error"))}else g(!1)}catch(E){U.isAxiosError(E)&&((W=(B=E.response)==null?void 0:B.data)!=null&&W.code)?k(T(s,E.response.data.code)):k(T(s,"network_error"))}finally{r(!1)}},R=()=>{g(!1),F(""),k(null),f(null),h(null)};return e.jsxs(e.Fragment,{children:[e.jsxs(Q,{expanded:p,onChange:P,children:[e.jsx(G,{expandIcon:e.jsx(H,{}),children:e.jsxs(M,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",width:"100%"},children:[e.jsx(v,{children:s("sections.twoFA")}),e.jsx(de,{control:e.jsx(ce,{checked:t,onChange:y,disabled:d}),label:s(t?"enabled":"disabled")})]})}),e.jsxs(J,{children:[o&&e.jsx(v,{color:"error",children:o}),x&&e.jsx(v,{color:"success.main",children:x}),e.jsx(v,{variant:"body2",children:s(t?"info.2faEnabled":"info.2faDisabled")})]})]}),e.jsxs(ue,{open:b,onClose:R,children:[e.jsx(he,{children:s(l==="enable"?"dialog.enable2faTitle":"dialog.disable2faTitle")}),e.jsxs(pe,{children:[l==="enable"&&S&&e.jsxs(M,{sx:{textAlign:"center",mb:2},children:[e.jsx(v,{variant:"body2",gutterBottom:!0,children:s("dialog.scanQRCodeWithoutConfirm")}),e.jsx(M,{component:"img",src:S,alt:"QR Code",sx:{mx:"auto",width:200,height:200}}),I&&e.jsxs(v,{variant:"caption",display:"block",sx:{mt:1},children:[s("dialog.secret"),": ",I]})]}),l==="disable"&&e.jsxs(M,{children:[e.jsx(v,{variant:"body2",gutterBottom:!0,children:s("dialog.enterCodeToDisable")}),e.jsxs(M,{sx:{display:"flex",gap:1,mb:1},children:[e.jsx(_,{variant:u==="otp"?"contained":"outlined",onClick:()=>m("otp"),disabled:d,children:s("dialog.useOtp")}),e.jsx(_,{variant:u==="recovery"?"contained":"outlined",onClick:()=>m("recovery"),disabled:d,children:s("dialog.useRecoveryCode")})]}),e.jsx(N,{label:s("fields.otpCode"),value:w,onChange:B=>F(B.target.value),fullWidth:!0,type:"text",margin:"normal"}),q&&e.jsx(v,{color:"error",sx:{mt:1},children:q})]})]}),e.jsxs(fe,{children:[e.jsx(_,{onClick:R,disabled:d,children:s("buttons.cancel")}),e.jsx(_,{variant:"contained",onClick:L,disabled:d||l==="disable"&&u==="otp"&&!w,startIcon:d?e.jsx(X,{size:16}):null,children:s("buttons.confirm")})]})]})]})}function Qe(){const{t}=V("userDashboard"),i=O(r=>r.authToken),[s,n]=a.useState(null),[C,p]=a.useState(!0),[A,d]=a.useState(null);return a.useEffect(()=>{if(!i){n(null),p(!1);return}const r=new AbortController,o=r.signal;return(async()=>{p(!0),d(null);try{const x=await je(i,{signal:o});if(o.aborted)return;const{status:c,data:b}=x;c===200&&b.user?n({firstname:b.user.firstname,lastname:b.user.lastname,email:b.user.email,twoFAEnabled:b.user.twofa_enabled}):d(t("errors.fetchProfile"))}catch(x){if(o.aborted)return;if(U.isAxiosError(x)&&x.response){const c=x.response.data,b=c==null?void 0:c.code;d(T(t,b??"generic_error"))}else d(T(t,"network_error"))}finally{o.aborted||p(!1)}})(),()=>{r.abort()}},[i,t]),C?e.jsxs(e.Fragment,{children:[e.jsx(Z,{title:t("seo.title"),description:t("seo.description")}),e.jsx(ee,{children:e.jsx(M,{sx:{display:"flex",justifyContent:"center",mt:4},children:e.jsx(ae,{})})})]}):A?e.jsxs(e.Fragment,{children:[e.jsx(Z,{title:t("seo.errorTitle"),description:t("seo.errorDescription")}),e.jsx(ee,{children:e.jsx(re,{title:t("errors.genericErrorTitle"),message:A,showRetry:!0,retryButtonText:t("errors.retry"),onRetry:()=>{window.location.reload()},showHome:!0,homeButtonText:t("errors.home")})})]}):s?e.jsxs(e.Fragment,{children:[e.jsx(Z,{title:t("seo.title"),description:t("seo.description")}),e.jsx(ee,{children:e.jsxs(M,{sx:{maxWidth:600,mx:"auto",mt:4,mb:4},children:[e.jsx(v,{variant:"h4",gutterBottom:!0,align:"center",children:t("dashboard.title")}),e.jsx(v,{variant:"body1",gutterBottom:!0,align:"center",sx:{mb:4},children:t("dashboard.subtitle")}),e.jsxs(K,{spacing:2,children:[e.jsx(ve,{user:s,onUpdate:r=>n(o=>({...o,...r}))}),e.jsx(Te,{currentEmail:s.email,onUpdate:r=>n(o=>({...o,email:r}))}),e.jsx(Ee,{}),e.jsx(Ae,{enabled:s.twoFAEnabled,onToggle:r=>n(o=>({...o,twoFAEnabled:r}))})]})]})})]}):e.jsx(me,{to:"/login",replace:!0})}export{Qe as default};
