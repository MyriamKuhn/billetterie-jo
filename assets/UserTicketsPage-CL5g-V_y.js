import{r as g,j as e,R as X}from"./react-C0aVURRx.js";import{b as D,a as Z,P,S as ee,O as te}from"./index-q-ZiXizB.js";import{E as se}from"./ErrorDisplay-Cpov-QS1.js";import{u as $,q as p,t as w,N as re,a2 as B,B as I,I as F,p as ne,r as ae,a8 as oe,x as A,ax as j,Q as G,O as ie,ay as le,U as ce,as as W,C as Q,az as de,R as ue,_ as xe}from"./mui-CW5KTKiM.js";import{d as Y}from"./dayjs-DMyafwSS.js";import{F as q}from"./FilterSelect-usqmpckm.js";import{u as k}from"./i18n-react-CHYEX_9Z.js";import{a as fe,b as pe,u as me,c as he}from"./useDownloadInvoice-BICOSgoh.js";import{u as U}from"./useCustomSnackbar-Cg6BlIUS.js";import{f as ge}from"./format-_gz818Hm.js";import{u as _e}from"./useProductDetails-PeJqagWa.js";import{ab as je}from"./vendor-1UMx7qFY.js";import"./axios-xsH4HHeE.js";import"./zustand-DgaMZn_z.js";import"./i18n-Bhc83OLH.js";import"./emotion-BKoPsIBf.js";import"./helmet-DqAb31yQ.js";import"./cookie-consent-DYVQHhqE.js";function we({filters:t,onChange:s}){const{t:r}=k("tickets"),l=$(),[m,d]=g.useState(!1),x={"":r("filters.status_all"),issued:r("filters.status_issued"),used:r("filters.status_used"),refunded:r("filters.status_refunded"),cancelled:r("filters.status_cancelled")},i=Object.entries(x).reduce((n,[a,_])=>(n[_]=a,n),{}),o=Object.values(x),c=x[t.status],f=e.jsxs(p,{sx:{width:260,py:2,px:1},children:[e.jsx(w,{variant:"h6",gutterBottom:!0,children:r("filters.title")}),e.jsxs(re,{spacing:2,sx:{mx:1},children:[e.jsx(q,{label:r("filters.status_label"),value:c,options:o,onChange:n=>{const a=i[n];s({status:a,page:1})}}),e.jsx(B,{label:r("filters.event_date_from"),value:t.event_date_from?Y(t.event_date_from):null,onChange:n=>s({event_date_from:(n==null?void 0:n.format("YYYY-MM-DD"))||"",page:1}),slotProps:{textField:{size:"small",fullWidth:!0}}}),e.jsx(B,{label:r("filters.event_date_to"),value:t.event_date_to?Y(t.event_date_to):null,onChange:n=>s({event_date_to:(n==null?void 0:n.format("YYYY-MM-DD"))||"",page:1}),slotProps:{textField:{size:"small",fullWidth:!0}}}),e.jsx(q,{label:r("filters.per_page"),value:String(t.per_page),options:["5","10","25","50","100"],onChange:n=>{const a=parseInt(n,10);s({per_page:a,page:1})}}),e.jsx(I,{variant:"outlined",fullWidth:!0,onClick:()=>s({status:"",event_date_from:"",event_date_to:"",per_page:5,page:1}),children:r("filters.reset")})]})]});return e.jsxs(e.Fragment,{children:[e.jsx(p,{component:"aside",sx:{display:{xs:"none",md:"block"},position:"sticky",top:l.mixins.toolbar.minHeight,bgcolor:"background.paper",border:`1px solid ${l.palette.divider}`,borderRadius:1,width:260},children:f}),e.jsxs(p,{sx:{display:{xs:"block",md:"none"},mb:2},children:[e.jsx(F,{onClick:()=>d(!0),"aria-label":r("filters.title"),children:e.jsx(ne,{})}),e.jsx(ae,{open:m,onClose:()=>d(!1),keepMounted:!0,children:e.jsxs(p,{sx:{position:"relative"},children:[e.jsx(F,{onClick:()=>d(!1),size:"small",sx:{position:"absolute",top:8,right:8},"aria-label":r("filters.close"),children:e.jsx(oe,{})}),f]})})]})]})}function ke(){const t=D(x=>x.authToken),{t:s}=k("tickets"),{notify:r}=U(),[l,m]=g.useState(!1);return{download:async x=>{var o,c;if(!t){r(s("errors.not_authenticated"),"warning");return}const i=x.replace(/^.*[\\/]/,"");if(!i){r(s("errors.download_failed"),"error");return}m(!0);try{const f=await fe(i,t),n=window.URL.createObjectURL(f),a=document.createElement("a");a.href=n,a.download=i,document.body.appendChild(a),a.click(),a.remove(),window.URL.revokeObjectURL(n),r(s("tickets.download_success"),"success")}catch(f){let n=s("errors.download_failed"),a="error";((o=f.response)==null?void 0:o.status)===404?(n=s("errors.not_found"),a="warning"):((c=f.response)==null?void 0:c.status)===401&&(n=s("errors.unauthorized"),a="warning"),r(n,a)}finally{m(!1)}},downloading:l}}function ve(t){const s=D(o=>o.authToken),{notify:r}=U(),{t:l}=k("tickets"),[m,d]=g.useState(null),[x,i]=g.useState(!1);return g.useEffect(()=>{let o=!1;if(m&&(URL.revokeObjectURL(m),d(null)),!t)return;if(!s){r(l("errors.not_authenticated"),"warning");return}const c=t.replace(/^.*[\\/]/,"");return(async()=>{var n,a;i(!0);try{const _=await pe(c,s);if(o)return;const u=URL.createObjectURL(_);d(u)}catch(_){let u=l("errors.qr_fetch_failed");((n=_.response)==null?void 0:n.status)===404?u=l("errors.qr_not_found"):((a=_.response)==null?void 0:a.status)===401&&(u=l("errors.unauthorized")),r(u,"error")}finally{o||i(!1)}})(),()=>{o=!0}},[t,s]),{qrUrl:m,loading:x}}function be(){const t=$();return e.jsx(p,{sx:{flex:{xs:"1 1 calc(33% - 32px)",md:"1 1 100%"},minWidth:{xs:280,md:"auto"},maxWidth:{xs:320,md:"100%"}},children:e.jsxs(A,{sx:{display:"flex",flexDirection:{xs:"column",md:"row"},alignItems:{xs:"stretch",md:"center"},p:2,gap:1},children:[e.jsx(j,{variant:"rectangular",sx:{width:{xs:"100%",md:200},height:{xs:150,md:200},bgcolor:t.palette.action.hover}}),e.jsxs(G,{sx:{flexGrow:1},children:[e.jsx(j,{variant:"text",width:"60%",height:32}),e.jsx(j,{variant:"text",width:"40%",sx:{mt:1,mb:1}}),e.jsx(j,{variant:"text",width:"50%",sx:{mt:1}}),e.jsx(j,{variant:"text",width:"70%",sx:{mt:.5}}),e.jsx(j,{variant:"text",width:"30%",sx:{mt:.5}}),e.jsx(j,{variant:"rectangular",width:80,height:24,sx:{mt:2,borderRadius:1}})]}),e.jsxs(p,{sx:{display:"flex",flexDirection:{xs:"row",md:"column"},justifyContent:"center",alignItems:"center",gap:1},children:[e.jsx(j,{variant:"rectangular",width:120,height:36}),e.jsx(j,{variant:"rectangular",width:120,height:36})]})]})})}function ye(t){switch(t){case"used":return"success";case"issued":return"info";case"refunded":return"warning";case"cancelled":return"error";default:return"default"}}function Te({ticket:t}){var E,L,R,z,O,M;const{t:s}=k("tickets"),r=Z(v=>v.lang),{notify:l}=U(),{download:m,downloading:d}=ke(),{download:x,downloading:i}=me(),{ref:o,inView:c}=je({triggerOnce:!0,rootMargin:"200px"}),{qrUrl:f,loading:n}=ve(c?t.qr_filename:null),a=((E=t.product_snapshot)==null?void 0:E.product_id)??null,{product:_,loading:u,error:h}=_e(a,r);if(g.useEffect(()=>{!u&&h&&l(s("errors.product_fetch_failed"),"warning")},[u,h,t.id,l,s]),u)return e.jsx(be,{});let b="",y="",T="",C="",S=null;h||!_?b=s("tickets.no_product"):(b=(L=t.product_snapshot)==null?void 0:L.product_name,y=ge((R=_.product_details)==null?void 0:R.date,r),T=((z=_.product_details)==null?void 0:z.time)||"",C=((O=_.product_details)==null?void 0:O.location)||s("tickets.no_location"),S=((M=t.product_snapshot)==null?void 0:M.ticket_places)??null);const V=s(`tickets.status.${t.status}`,t.status),H=ye(t.status),N=()=>{t.pdf_filename?m(t.pdf_filename).catch(v=>{l(s("errors.download_error"),"error")}):l(s("tickets.no_pdf"),"warning")},J=()=>{const v=`invoice_${t.payment_uuid}.pdf`;x(v).catch(Ie=>{l(s("errors.invoice_download_error"),"error")})},K=n?e.jsx(j,{variant:"rectangular",sx:{width:{xs:"100%",md:200},height:{xs:150,md:200}}}):f?e.jsx(ie,{component:"img",image:f,alt:s("tickets.qr_alt"),loading:"lazy",sx:{width:{xs:"100%",md:200},height:{xs:150,md:200},objectFit:"contain",backgroundColor:"background.default"}}):e.jsx(p,{sx:{width:{xs:"100%",md:200},height:{xs:150,md:200},display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"background.default"},children:e.jsx(le,{fontSize:"large",color:"disabled"})});return e.jsx(p,{ref:o,sx:{flex:{xs:"1 1 calc(33% - 32px)",md:"1 1 100%"},minWidth:{xs:280,md:"auto"},maxWidth:{xs:320,md:"100%"}},children:e.jsxs(A,{sx:{display:"flex",flexDirection:{xs:"column",md:"row"},alignItems:{xs:"stretch",md:"center"},p:2,gap:1},children:[K,e.jsxs(G,{sx:{flexGrow:1},children:[e.jsx(w,{variant:"h6",gutterBottom:!0,children:b}),!u&&t.token&&e.jsxs(w,{variant:"body2",sx:{mb:3},children:[s("tickets.token"),": ",t.token]}),!u&&y&&e.jsxs(w,{variant:"body2",color:"text.secondary",sx:{mt:.5},children:[y,T&&` â€“ ${T}`]}),!u&&C&&e.jsx(w,{variant:"body2",color:"text.secondary",sx:{mt:.5,mb:3},children:C}),!u&&S!==null&&e.jsx(w,{variant:"body2",sx:{mt:.5},children:s("tickets.places",{count:S})}),!u&&e.jsx(p,{sx:{mt:1},children:e.jsx(ce,{label:V,color:H,size:"small"})})]}),e.jsxs(p,{sx:{display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",gap:1,"& .MuiButton-root":{whiteSpace:"nowrap"}},children:[e.jsx(W,{title:s("tickets.download_pdf"),children:e.jsx("span",{children:e.jsx(I,{size:"small",variant:"outlined",startIcon:d?e.jsx(Q,{size:16}):e.jsx(de,{}),onClick:N,disabled:d,children:s("tickets.download_ticket")})})}),t.payment_uuid&&e.jsx(W,{title:s("tickets.download_invoice_pdf"),children:e.jsx("span",{children:e.jsx(I,{size:"small",variant:"outlined",startIcon:i?e.jsx(Q,{size:16}):e.jsx(ue,{}),onClick:J,disabled:i,children:s("tickets.download_invoice")})})})]})]})})}function Ce({tickets:t}){const{t:s}=k("tickets");return t.length===0?e.jsx(w,{variant:"h6",align:"center",sx:{mt:4},children:s("tickets.no_tickets")}):e.jsx(p,{sx:{display:"flex",flexWrap:"wrap",gap:2,justifyContent:{xs:"center",md:"flex-start"}},children:t.map(r=>e.jsx(Te,{ticket:r,invoiceLink:r.payment_uuid||""},r.token))})}function Se(t){const s=D(a=>a.authToken),[r,l]=g.useState([]),[m,d]=g.useState(0),[x,i]=g.useState(!1),[o,c]=g.useState(null),[f,n]=g.useState(null);return g.useEffect(()=>{let a=!1;return(async()=>{var u;if(i(!0),c(null),n(null),!s){c(new Error("User not authenticated")),l([]),d(0),i(!1);return}try{const h=await he(t,s);if(a)return;l(h.data.data),h.data.meta&&typeof h.data.meta.total=="number"?d(h.data.meta.total):d(h.data.data.length)}catch(h){if(a)return;((u=h.response)==null?void 0:u.status)===422?n(h.response.data.errors):c(h instanceof Error?h:new Error("Unknown error"))}finally{a||i(!1)}})(),()=>{a=!0}},[JSON.stringify(t),s]),{tickets:r,total:m,loading:x,error:o,validationErrors:f}}function Ve(){const{t}=k("tickets"),[s,r]=g.useState({status:"",per_page:5,page:1,event_date_from:"",event_date_to:""}),{tickets:l,total:m,loading:d,error:x,validationErrors:i}=Se(s);return X.useEffect(()=>{if(!i)return;const o={};i.q&&(o.status=""),i.event_date_from&&(o.event_date_from=""),i.event_date_to&&(o.event_date_to=""),i.per_page&&(o.per_page=5),i.page&&(o.page=1),r(c=>({...c,...o}))},[i]),x?e.jsx(P,{children:e.jsx(se,{title:t("errors.title"),message:t("errors.message"),showRetry:!0,retryButtonText:t("errors.retry"),onRetry:()=>r(o=>({...o})),showHome:!0,homeButtonText:t("errors.go_home")})}):e.jsxs(e.Fragment,{children:[e.jsx(ee,{title:t("seo.title"),description:t("seo.description")}),e.jsxs(P,{disableCard:!0,children:[e.jsx(w,{variant:"h4",sx:{px:2},children:t("tickets.title")}),e.jsxs(p,{sx:{display:"flex",flexDirection:{xs:"column",md:"row"},gap:2,p:2},children:[e.jsx(we,{filters:s,onChange:o=>r(c=>({...c,...o}))}),e.jsxs(p,{component:"main",flex:1,children:[d?e.jsx(p,{textAlign:"center",py:8,children:e.jsx(te,{})}):e.jsx(Ce,{tickets:l}),!d&&l.length>0&&e.jsx(p,{textAlign:"center",mt:4,children:e.jsx(xe,{count:Math.ceil(m/s.per_page)||1,page:s.page,onChange:(o,c)=>r(f=>({...f,page:c}))})})]})]})]})]})}export{Ve as default};
